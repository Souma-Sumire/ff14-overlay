import{U as p}from"./util-6ab7166a.js";const d=new URLSearchParams(window.location.href.split("?")[1]),a=d.get("api"),i={cafe:"cafemaker.wakingsands.com",xivapi:"xivapi.com"},u=new Map,s={first:`https://${(a==null?void 0:a.toLowerCase())==="xivapi"?i.xivapi:i.cafe}`,second:`https://${(a==null?void 0:a.toLowerCase())==="xivapi"?i.cafe:i.xivapi}`},w={get random(){return Math.floor(Math.random()*864e5*11)+864e5*25}},I=new Map(Object.entries({任务指令:"/i/000000/000123.png",冲刺:"/i/000000/000104.png",坐骑:"/i/000000/000118.png",攻击:"/i/000000/000101.png",腐秽大地:"/i/003000/003090.png"})),g="souma-action-cache",m=JSON.parse(localStorage.getItem(g)||"[]"),$=Date.now(),C=1e3,y=m.filter((e,t)=>e.expirationTime>=$&&t<C);localStorage.setItem(g,JSON.stringify(y));const A=/(\d{6})\/(\d{6})\.png$/;async function T(e,t,n=["ID","Icon","ActionCategoryTargetID"]){if(u.has(t))return u.get(t);const o=D(e,t,n);try{const r=await f(o,{mode:"cors"});return u.set(t,r),r}catch(r){return console.error(`Failed to parse action: ${r}`),Promise.resolve({ActionCategoryTargetID:0,ID:t,Icon:"/i/000000/000405.png"})}}function D(e,t,n){const o=`${s.first}/${e}/${t}?columns=${n.join(",")}`;return[o,o.replace(s.first,s.second)]}async function E(e,t=!1){return`${s.first}${e}`.replace(A,(o,r,c)=>`${r}/${t?"hq/":""}${c}.png`)}function S(e){const t=p.jobEnumToJob(e),n=p.nameToFullName(t);return`${s.first}/cj/companion/${n.en.toLowerCase().replaceAll(/\s/g,"")}.png`}async function b(e){const t=await T("action",e,["Icon"]);return E(t.Icon)}async function j(e){const t=I.get(e);if(t)return{ActionCategoryTargetID:0,ID:0,Icon:t};const n=m.find(o=>o.name===e);if(n!=null&&n.action)return n.action;try{const o=await f([`https://${i.cafe}/search?filters=ClassJobLevel>0&indexes=action&string=${encodeURIComponent(e)}`]);if(o){const r=Date.now()+w.random,c={name:e,action:o,expirationTime:r};return m.push(c),localStorage.setItem(g,JSON.stringify(m)),o}return{ActionCategoryTargetID:0,ID:0,Icon:"/i/000000/000405.png"}}catch(o){throw console.error(`Failed to get action by name: ${o}`),new Error("Failed to retrieve action data")}}async function v(e,t){let n;const o=new Promise((r,c)=>{n=setTimeout(()=>{c(new Error("Promise timed out"))},t)});return Promise.race([e,o]).finally(()=>{clearTimeout(n)})}async function f(e,t){const n=Object.assign({cache:"force-cache"},t);for(const o of e)try{const r=await v(fetch(o,n),3e3);if(r.ok){const c=await r.json(),h=new URL(o).host;return{...c,Host:h}}}catch{}throw new Error("All fetch attempts failed.")}const l=new Map;function N(e){return l.has(e)?l.get(e):`${s.first}${e}`}function L(e){var o;const t=e.target,n=(o=t.src.match(new RegExp("(?<=\\.\\w+)\\/.+$")))==null?void 0:o[0];!n||t.src===""||(/pictomancer\.png$/.test(t.src)?t.src="//souma.diemoe.net/resources/img/pictomancer.png":/viper\.png$/.test(t.src)?t.src="//souma.diemoe.net/resources/img/viper.png":t.src.includes(s.first)?t.src=t.src.replace(s.first,s.second):t.src="",l.set(n,t.src))}export{j as a,E as b,S as c,b as d,u as e,N as g,L as h,T as p,s};
