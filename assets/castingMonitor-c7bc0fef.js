import{U as O,B as F,A as w,d as j,o as u,b as y,J as T,K as P,u as s,c as G,w as m,g as I,t as k,R as x,S as z,i as $,aF as B,p as Q,l as U,a0 as J,I as b,F as R,h as V,H as Y,a as f,j as q,k as K,e as W,P as X}from"./vendor-9c8efe32.js";import{p as C}from"./queryParams-cf2e4fb1.js";import{U as D}from"./util-ef9ccf87.js";import{p as Z,a as tt,h as N,b as et}from"./xivapi-cae66b04.js";import{c as at,a as v}from"./overlay_plugin_api-409cb9ea.js";import{_ as L}from"./index-992d2ccb.js";const H=["tank","healer","dps","crafter","gatherer","none"],E=[34563,34564,34565,34566,34567,34568,34569,34570,34571,34572,34573,34574,34575,34576,34577,34578,34579,34580,34581,34582],A=O("castingMonitor",{state:()=>{var t;return{castData:F({}),playerId:w(""),focusTargetId:w(""),partyData:[],config:{duration:Number(((t=C)==null?void 0:t.duration)||25)},lastPush:Date.now()}},getters:{partyDataFormatted(t){return t.partyData.sort((e,i)=>H.indexOf(D.jobToRole(D.jobEnumToJob(e.job)))-H.indexOf(D.jobToRole(D.jobEnumToJob(i.job))))},focusTargetCastArr(t){var e;return((e=t.castData)==null?void 0:e[t.focusTargetId])??[]}},actions:{testAction(){const t=E[Math.floor(Math.random()*E.length)];this.pushAction(Date.now(),15,"青魔技能随机",this.focusTargetId,t)},testItem(){this.pushAction(Date.now(),15,"item_11c7",this.focusTargetId,33558983)},testItemHQ(){this.pushAction(Date.now(),15,"item_f5407",this.focusTargetId,34558983)},testParty(t){this.handlePartyChanged({party:t?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0}]:[]})},async pushAction(t,e,i,o,p,r){var _;const d=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test((_=C)==null?void 0:_.energySaving);let c=p;if(this.partyData.length===0&&o===this.playerId||d&&o===this.focusTargetId||!d&&this.partyData.length>0&&this.partyData.find(a=>a.id===o)){let a,h=!1;/^(?:item|mount)_/.test(i)?(c=Number.parseInt(i.replace(/^.+_/,""),16),c>983040&&(c=Number.parseInt(c.toString().slice(-5),10),h=!0),a=i.replace(/_.+$/,"")):a="action",this.castData[o]||(this.castData[o]=[]);const g=Symbol();this.castData[o].push({time:t,logLine:e,src:"",class:"",key:g,APIData:{}}),this.lastPush=Date.now();const n=this.castData[o].find(l=>l.key===g);if(!n)return;if(setTimeout(()=>{var l;(l=this.castData[o])==null||l.splice(this.castData[o].indexOf(n),1)},(r||this.config.duration)*1e3),/^unknown_/.test(i))n.src="https://cafemaker.wakingsands.com/i/000000/000405.png",n.class="action action-category-0";else if(c<1e5){const l=await Z(a,c,["ID","Icon","ActionCategoryTargetID","Name","Description"]);if(n.APIData=l,n.src=await tt((l==null?void 0:l.Icon)??"",h),a==="action"?n.class=`action action-category-${l==null?void 0:l.ActionCategoryTargetID}`:a==="item"?n.class=`item${h?"HQ":""}`:a==="mount"&&(n.class="mount"),l.ActionCategoryTargetID===2||l.ActionCategoryTargetID===3){const S=this.castData[o].filter(M=>/action-category-[23]/.test(M.class)&&M.logLine!==14).at(-2);S&&(n.GCDCast=((n.time-S.time)/1e3).toFixed(2),Number.parseFloat(n.GCDCast)>=2.55&&(n.GCDClass="wasted"))}}}},handleChangePrimaryPlayer(t){this.playerId=t.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(t){t.line[0]==="20"?this.pushAction(Date.parse(t.line[1]),14,t.line[5],t.line[2],Number.parseInt(t.line[4],16),Number(t.line[8])):(t.line[0]==="21"||t.line[0]==="22"&&t.line[45]==="0")&&this.pushAction(Date.parse(t.line[1]),15,t.line[5],t.line[2],Number.parseInt(t.line[4],16))},handlePartyChanged(t){if(t.party.length>0){this.partyData=t.party.filter(e=>e.inParty).map(e=>({...e,src:""}));for(const e in this.castData)Object.prototype.hasOwnProperty.call(this.castData,e)&&(this.partyData.find(i=>i.id===e)||Reflect.deleteProperty(this.castData,e));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(t){var e;t===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=t,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test((e=C)==null?void 0:e.syncFocusWS)&&at({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})}}}),st=t=>(Q("data-v-ce63ebf1"),t=t(),U(),t),ot={"w-100vw":"",flex:"~ nowrap",class:"main"},nt=["data-casterId"],rt={class:"elhover"},it=["innerHTML"],lt=["src"],ct=st(()=>I("img",{class:"frame",loading:"lazy"},null,-1)),dt=j({__name:"Main",setup(t){const e=A(),i=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(C.displayAA)),o=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(C.displayGCDSpace));return(p,r)=>{const d=B;return u(),y("div",ot,[(u(!0),y(T,null,P(s(e).castData,(c,_)=>(u(),y("div",{key:_,"data-casterId":_},[(u(!0),y(T,null,P(c,a=>(u(),G(d,{"raw-content":"",placement:"right-start",effect:"dark",transition:"",teleported:!1,"popper-class":"el-tooltip","show-arrow":!1,key:a.key},{content:m(()=>{var h;return[I("div",rt,[I("strong",null,k(a.APIData.Name),1),I("div",{innerHTML:(h=a.APIData)==null?void 0:h.Description,style:{"white-space":"pre-line"}},null,8,it)])]}),default:m(()=>[I("div",{class:x(`images ${a.class} logLine${a.logLine} displayAA${s(i)} displayGCD${s(o)}`),style:z(`--animeDuration: ${s(e).config.duration}s;opacity:${+(s(e).focusTargetId===_)}`)},[I("img",{src:a.src,class:"action-icon",height:"40",loading:"lazy",onError:r[0]||(r[0]=(...h)=>s(N)&&s(N)(...h))},null,40,lt),ct,s(o)===1?(u(),y("span",{key:0,class:x(["GCDCast",a.GCDClass])},k((a==null?void 0:a.GCDCast)??""),3)):$("",!0)],6)]),_:2},1024))),128))],8,nt))),128))])}}});const ut=L(dt,[["__scopeId","data-v-ce63ebf1"]]),pt={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},ht=["onClick"],ft={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},mt=["src"],yt=j({__name:"Header",setup(t){var o;const e=A();J(()=>{for(const p of e.partyData)p.src=et(p.job)});const i=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test((o=C)==null?void 0:o.showHeader);return(p,r)=>s(i)?(u(),y("div",pt,[(u(!0),y(T,null,P(s(e).partyDataFormatted,(d,c)=>(u(),y("button",{key:c,onClick:_=>s(e).handleClickChangeTarget(d.id),class:x(["job-lists",s(e).focusTargetId===d.id?"job-lists-focus":""]),"p-0":"","m-0":""},[I("div",ft,[I("img",{src:d.src,style:{height:"1.25em"},loading:"lazy"},null,8,mt),b(" "+k(s(D).nameToFullName(s(D).jobEnumToJob(d.job)).simple2),1)])],10,ht))),128))])):$("",!0)}});const _t={class:"common-layout"},gt={key:0},It=j({__name:"castingMonitor",setup(t){const e=A(),i=location.href.indexOf("localhost")>-1;R(()=>{v("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),v("LogLine",e.handleLogLine),v("PartyChanged",e.handlePartyChanged),v("BroadcastMessage",p=>{p.source==="castMonitorOverlay"&&(e.focusTargetId=p.msg.targetId)}),startOverlayEvents()});const o=w(!1);return setInterval(()=>{o.value=Date.now()-e.lastPush<e.config.duration*2*1e3},1e3),(p,r)=>{const d=yt,c=q,_=ut,a=K,h=W,g=X;return V((u(),y("div",_t,[f(h,{"items-center":""},{default:m(()=>[f(c,{class:"header-layout"},{default:m(()=>[f(d)]),_:1}),f(a,{"p-0":""},{default:m(()=>[f(_)]),_:1})]),_:1}),i?(u(),y("footer",gt,[f(g,{onClick:r[0]||(r[0]=n=>s(e).testParty(!0))},{default:m(()=>[b("虚假小队")]),_:1}),f(g,{onClick:r[1]||(r[1]=n=>s(e).testParty(!1))},{default:m(()=>[b("单人")]),_:1}),f(g,{onClick:r[2]||(r[2]=n=>s(e).testAction())},{default:m(()=>[b("Action")]),_:1}),f(g,{onClick:r[3]||(r[3]=n=>s(e).testItem())},{default:m(()=>[b("Item")]),_:1}),f(g,{onClick:r[4]||(r[4]=n=>s(e).testItemHQ())},{default:m(()=>[b("ItemHQ")]),_:1})])):$("",!0)],512)),[[Y,s(o)]])}}});const Pt=L(It,[["__scopeId","data-v-2f7502ba"]]);export{Pt as default};
