import{R as M,d as x,o as u,e as h,F as j,K as P,u as o,O as k,P as E,s as D,D as L,G as N,Y as O,$ as S,t as I,x as U,b as F,a as p,w as g,C as H,a4 as z,a5 as R,M as B}from"./vendor-78a7168b.js";import{c as G,a as b}from"./overlay_plugin_api-409cb9ea.js";import{U as y}from"./util-6ab7166a.js";import{e as V,s as W,p as J,b as Y,h as w,c as q}from"./xivapi-a7df41e3.js";import{_ as A}from"./_plugin-vue_export-helper-c27b6911.js";const T=new URLSearchParams(window.location.href.split("?")[1]),$=["tank","healer","dps","crafter","gatherer","none"],v=[34563,34564,34565,34566,34567,34568,34569,34570,34571,34572,34573,34574,34575,34576,34577,34578,34579,34580,34581,34582],C=M("castingMonitor",{state:()=>({castData:[],playerId:"",focusTargetId:"",partyData:[],config:{duration:Number(T.get("duration")||15)}}),getters:{partyDataFormatted(t){return t.partyData.sort((e,a)=>$.indexOf(y.jobToRole(y.jobEnumToJob(e.job)))-$.indexOf(y.jobToRole(y.jobEnumToJob(a.job))))},focusTargetCastArr(t){return t.castData.filter(e=>e.casterId===t.focusTargetId)}},actions:{testAction(){const t=v[Math.floor(Math.random()*v.length)];this.pushAction(Date.now(),15,"青魔技能随机",this.focusTargetId,t)},testParty(t){this.handlePartyChanged({party:t?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0}]:[]})},async pushAction(t,e,a,i,n,f){if(this.partyData.length===0&&i===this.playerId||this.partyData.length>0&&i===this.focusTargetId){let s=n,r="action",_=!1;if(a.startsWith("item_"))return;a.startsWith("mount_")&&(s=Number.parseInt(a.replace(/^.+_/,""),16),s>983040&&(s=Number.parseInt(s.toString().slice(-5),10),_=!0),r=a.replace(/_.+$/,""));const m=`${t}-${e}-${i}-${n}`,c={casterId:i,time:t,expirationTime:Date.now()+this.config.duration*1e3,logLine:e,src:"",class:"",key:m},d=V.get(s);if(d&&(c.src=`//${d.Host}${d.Icon}`),this.castData.push(c),e===14&&f&&setTimeout(()=>{this.castData=this.castData.filter(l=>l.key!==m)},f*1e3-500),a.startsWith("unknown_"))c.src=`${W.first}/i/000000/000405.png`,c.class="action action-category-0";else if(s<1e5){const l=d||await J(r,s,["ID","Icon","ActionCategoryTargetID"]);l.ID===3&&(l.Icon="/i/000000/000104.png"),d||(c.src=await Y((l==null?void 0:l.Icon)??"",_)),r==="action"?c.class=`action action-category-${l==null?void 0:l.ActionCategoryTargetID}`:r==="mount"&&(c.class="mount")}}},handleChangePrimaryPlayer(t){this.playerId=t.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(t){t.line[0]==="20"?this.pushAction(Date.now(),14,t.line[5],t.line[2],Number.parseInt(t.line[4],16),Number(t.line[8])):(t.line[0]==="21"||t.line[0]==="22"&&t.line[45]==="0")&&this.pushAction(Date.now(),15,t.line[5],t.line[2],Number.parseInt(t.line[4],16))},handlePartyChanged(t){if(t.party.length>0){this.partyData=t.party.filter(e=>e.inParty).map(e=>({...e,src:""}));for(const e in this.castData)Object.prototype.hasOwnProperty.call(this.castData,e)&&(this.partyData.find(a=>a.id===e)||Reflect.deleteProperty(this.castData,e));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(t){t===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=t,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(T.get("syncFocusWS")||"")&&G({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})},cleanUpExpired(){this.castData=this.castData.filter(t=>t.expirationTime>Date.now())}}}),K=t=>(L("data-v-6eeb6b5a"),t=t(),N(),t),Q={"w-100vw":"",flex:"~ nowrap",class:"main"},X=["data-casterId"],Z=["src"],tt=K(()=>D("img",{class:"frame",loading:"lazy"},null,-1)),et=x({__name:"Main",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),a=C(),i=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(e.get("displayAA")??"")),n=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(e.get("displayGCD")??e.get("displayGCDSpace")??""));return(f,s)=>(u(),h("div",Q,[(u(!0),h(j,null,P(o(a).castData,r=>(u(),h("div",{key:r.key,"data-casterId":r.casterId,class:k(`images ${r.class} logLine${r.logLine} displayAA${o(i)} displayGCD${o(n)}`),style:E(`--animeDuration: ${o(a).config.duration}s;`)},[D("img",{src:r.src,class:"action-icon",height:"40",loading:"lazy",onError:s[0]||(s[0]=(..._)=>o(w)&&o(w)(..._))},null,40,Z),tt],14,X))),128))]))}});const at=A(et,[["__scopeId","data-v-6eeb6b5a"]]),ot={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},st=["onClick"],nt={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},rt=["src","onerror"],it=x({__name:"Header",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),a=C();O(()=>{for(const n of a.partyData)n.src=q(n.job)});const i=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(e.get("showHeader")||"true");return(n,f)=>o(i)&&o(a).partyData.length>1?(u(),h("div",ot,[(u(!0),h(j,null,P(o(a).partyDataFormatted,(s,r)=>(u(),h("button",{key:r,class:k(["job-lists",o(a).focusTargetId===s.id?"job-lists-focus":""]),"m-0":"","p-0":"",onClick:_=>o(a).handleClickChangeTarget(s.id)},[D("div",nt,[D("img",{src:s.src,style:{height:"1.25em"},loading:"lazy",onerror:o(w)},null,8,rt),I(" "+U(o(y).nameToFullName(o(y).jobEnumToJob(s.job)).simple2),1)])],10,st))),128))])):S("",!0)}});const ct={class:"common-layout"},lt={key:0},dt=x({__name:"castingMonitor",setup(t){const e=C(),a=location.href.includes("localhost");return F(()=>{b("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),b("LogLine",e.handleLogLine),b("PartyChanged",e.handlePartyChanged),b("BroadcastMessage",i=>{i.source==="castMonitorOverlay"&&(e.focusTargetId=i.msg.targetId)})}),setInterval(()=>{e.cleanUpExpired()},1e3),(i,n)=>{const f=it,s=H,r=at,_=z,m=R,c=B;return u(),h("div",ct,[p(m,{"items-center":""},{default:g(()=>[p(s,{class:"header-layout"},{default:g(()=>[p(f)]),_:1}),p(_,null,{default:g(()=>[p(r)]),_:1})]),_:1}),o(a)?(u(),h("footer",lt,[p(c,{onClick:n[0]||(n[0]=d=>o(e).testParty(!0))},{default:g(()=>[I(" 虚假小队 ")]),_:1}),p(c,{onClick:n[1]||(n[1]=d=>o(e).testParty(!1))},{default:g(()=>[I(" 单人 ")]),_:1}),p(c,{onClick:n[2]||(n[2]=d=>o(e).testAction())},{default:g(()=>[I(" Action ")]),_:1})])):S("",!0)])}}});const gt=A(dt,[["__scopeId","data-v-9ae8b22a"]]);export{gt as default};
