import{d as k,x as E,v as I,s as w,o as C,c as D,w as i,a as n,u as d,F as T,S as c,T as x,K as V,ai as P,ak as $,M as b,ad as B,aj as F,h as M,e as j}from"./vendor-5deaef20.js";const K=k({__name:"fflogsCsvTimelineCreate",setup(N){const l=E("fflogs-csv-timeline-create",{api_key:"",url:"",code:""}),a=I({fight:void 0,enemies:[],friendlies:[],enemiesIDs:[],friendyIDs:[],takenEvents:[],showCN:!0,filter:{friendlyID:0},tableData:[],keigenns:[]}),m=w(!1);async function g(){m.value=!0;let f=l.value.url.match(new RegExp("(?<=^|\\/)(?<code>[\\d\\w]{16,})\\/?#fight=(?<fight>\\d+|last)"));if(l.value.api_key.length!==32){c.alert("错误的 API key");return}if(!f){x.error("战斗记录输入有误");return}l.value.code=f.groups.code,await fetch(`https://cn.fflogs.com/v1/report/fights/${l.value.code}?api_key=${l.value.api_key}`).then(t=>t.json()).then(async t=>{var o;const s=(f.groups.fight==="last"?t.fights.length:parseInt(f.groups.fight))-1;a.fight=t.fights[s],a.enemiesIDs=t.enemies.filter(e=>e.type==="Boss").map(e=>e.id),a.enemies=t.enemies,a.friendlies=t.friendlies.filter(e=>e.fights.find(r=>r.id===s)),a.friendyIDs=a.friendlies.map(e=>e.id).filter(e=>{var r;return((r=t.friendlies.find(u=>u.id===e))==null?void 0:r.type)!=="LimitBreak"}),a.takenEvents=[],await p(a.fight.start_time,a.fight.end_time,0),a.takenEvents=a.takenEvents.filter(e=>e.ability.name!=="Combined DoTs"&&e.type==="damage").sort((e,r)=>e.timestamp-r.timestamp),a.filter.friendlyID=((o=a.friendyIDs)==null?void 0:o[0])??0}).catch(t=>{c.alert(t)}),m.value=!1}async function p(f,t,s){s>=0&&await fetch(`https://cn.fflogs.com/v1/report/events/damage-taken/${l.value.code}?start=${f}&end=${t}&hostility=0&sourceid=${a.friendyIDs[s]}&api_key=${l.value.api_key}`).then(o=>o.json()).then(async o=>{let e=o;a.takenEvents.push(...e.events),e!=null&&e.nextPageTimestamp&&(e==null?void 0:e.nextPageTimestamp)>0&&e.nextPageTimestamp<t&&await p(e.nextPageTimestamp,t,s),s<a.friendyIDs.length-1&&await p(f,t,s+1)})}return(f,t)=>{const s=V,o=P,e=$,r=b,u=B,h=F,y=M,v=j;return C(),D(v,null,{default:i(()=>[n(y,{"p-t-0":""},{default:i(()=>[n(h,null,{default:i(()=>[n(o,null,{default:i(()=>[n(u,{gutter:5,style:{width:"100%"}},{default:i(()=>[n(e,{span:6},{default:i(()=>[n(o,{label:"API KEY"},{default:i(()=>[n(s,{modelValue:d(l).api_key,"onUpdate:modelValue":t[0]||(t[0]=_=>d(l).api_key=_),type:"password",placeholder:"","show-password":""},null,8,["modelValue"])]),_:1})]),_:1}),n(e,{span:12},{default:i(()=>[n(o,{label:"FIGHT CODE"},{default:i(()=>[n(s,{modelValue:d(l).url,"onUpdate:modelValue":t[1]||(t[1]=_=>d(l).url=_),type:"text",placeholder:""},null,8,["modelValue"])]),_:1})]),_:1}),n(e,{span:6},{default:i(()=>[n(r,{type:"primary",onClick:g,loading:d(m)},{default:i(()=>[T("开始分析")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}}});export{K as default};
