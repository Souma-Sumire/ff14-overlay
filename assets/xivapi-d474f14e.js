import{U as g}from"./util-6ab7166a.js";const I=new URLSearchParams(window.location.href.split("?")[1]),c=I.get("api"),a={cafe:"cafemaker.wakingsands.com",xivapi:"xivapi.com"},s={first:`https://${(c==null?void 0:c.toLowerCase())==="xivapi"?a.xivapi:a.cafe}`,second:`https://${(c==null?void 0:c.toLowerCase())==="xivapi"?a.cafe:a.xivapi}`},w={get random(){return Math.floor(Math.random()*864e5*11)+864e5*25}},$=new Map(Object.entries({任务指令:"/i/000000/000123.png",冲刺:"/i/000000/000104.png",坐骑:"/i/000000/000118.png",攻击:"/i/000000/000101.png",腐秽大地:"/i/003000/003090.png"})),p="souma-action-cache",l=JSON.parse(localStorage.getItem(p)||"[]"),y=Date.now(),C=1e3,A=l.filter((t,e)=>t.expirationTime>=y&&e<C);localStorage.setItem(p,JSON.stringify(A));const T=/(\d{6})\/(\d{6})\.png$/;async function D(t,e,o=["ID","Icon","ActionCategoryTargetID"]){const n=E(t,e,o);try{return await(await f(n,{mode:"cors"})).json()}catch(r){return console.error(`Failed to parse action: ${r}`),Promise.resolve({ActionCategoryTargetID:0,ID:e,Icon:"/i/000000/000405.png"})}}function E(t,e,o){const n=`${s.first}/${t}/${e}?columns=${o.join(",")}`;return[n,n.replace(s.first,s.second)]}async function v(t,e=!1){return`${s.first}${t}`.replace(T,(n,r,i)=>`${r}/${e?"hq/":""}${i}.png`)}function b(t){const e=g.jobEnumToJob(t),o=g.nameToFullName(e);return`${s.first}/cj/companion/${o.en.toLowerCase().replaceAll(/\s/g,"")}.png`}async function j(t){const e=await D("action",t,["Icon"]);return v(e.Icon)}async function N(t){var n;const e=$.get(t);if(e)return{ActionCategoryTargetID:0,ID:0,Icon:e};const o=l.find(r=>r.name===t);if(o!=null&&o.action)return o.action;try{const m=(n=(await(await f([`https://${a.cafe}/search?filters=ClassJobLevel>0&indexes=action&string=${encodeURIComponent(t)}`])).json()).Results)==null?void 0:n[0];if(m){const h=Date.now()+w.random,d={name:t,action:m,expirationTime:h};return l.push(d),localStorage.setItem(p,JSON.stringify(l)),m}return{ActionCategoryTargetID:0,ID:0,Icon:"/i/000000/000405.png"}}catch(r){throw console.error(`Failed to get action by name: ${r}`),new Error("Failed to retrieve action data")}}async function x(t,e){let o;const n=new Promise((r,i)=>{o=setTimeout(()=>{i(new Error("Promise timed out"))},e)});return Promise.race([t,n]).finally(()=>{clearTimeout(o)})}async function f(t,e){const o=Object.assign({cache:"force-cache"},e);for(const n of t)try{const r=await x(fetch(n,o),3e3);if(r.ok)return r}catch(r){console.error(`Failed to fetch ${n}: ${r}`)}throw new Error("All fetch attempts failed.")}const u=new Map;function P(t){return u.has(t)?u.get(t):`${s.first}${t}`}function _(t){var n;const e=t.target,o=(n=e.src.match(new RegExp("(?<=\\.\\w+)\\/.+$")))==null?void 0:n[0];!o||e.src===""||(/pictomancer\.png$/.test(e.src)?e.src="//souma.diemoe.net/resources/img/pictomancer.png":/viper\.png$/.test(e.src)?e.src="//souma.diemoe.net/resources/img/viper.png":e.src.includes(s.first)?e.src=e.src.replace(s.first,s.second):e.src="",u.set(o,e.src))}export{N as a,v as b,b as c,j as d,P as g,_ as h,D as p,s};
