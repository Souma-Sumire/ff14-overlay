import{d as Fe,o as L,b as B,J as ke,K as ze,g as G,t as tt,u as l,R as at,D as ye,A as S,C as P,F as nt,B as ot,a0 as it,r as ae,h as Ee,H as Ae,a as g,w as D,a3 as st,S as lt,I as fe,i as rt,ax as ct,ay as Se,c as ut}from"./vendor-cc98dd31.js";import{u as He,t as Ce,m as mt,a as dt,p as ft,b as pt,d as gt,g as vt,e as bt,f as yt,_ as ht,c as kt}from"./flags-10d64d7a.js";import{h as je}from"./xivapi-2de896fe.js";import{N as j,l as n}from"./netregexes-2830d8aa.js";import{a as he}from"./overlay_plugin_api-409cb9ea.js";import{U as M}from"./util-ef9ccf87.js";import{g as Ct}from"./actionChinese-91930ff4.js";import{c as xt,a as It}from"./status-5d5f450e.js";import"./index-48b2daca.js";const _t={key:0},wt={key:1},Nt=["title","data-duration","data-sourcePov"],$t=["src","alt"],Dt=Fe({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(Q){const _=Q,F=He().icon4k;return(z,T)=>_.row.type==="dot"?(L(),B("div",_t," （不支持） ")):(L(),B("div",wt,[(L(!0),B(ke,null,ze(_.row.keigenns,(w,ne)=>(L(),B("span",{key:ne},[G("span",{class:"status",title:`${w.name}(${w.source})`,"data-duration":w.remainingDuration,"data-sourcePov":w.isPov},[G("img",{class:at(`statusIcon ${l(mt)(w.performance[Q.row.type])}`),src:`//cafemaker.wakingsands.com/i/${w.fullIcon}${l(F)}.png`,alt:w.effect,loading:"lazy",onError:T[0]||(T[0]=(...ee)=>l(je)&&l(je)(...ee))},null,42,$t)],8,Nt)]))),128)),G("span",null,tt(Q.row.effect==="damage done"?"":l(Ce)(Q.row.effect)),1)]))}}),Tt={key:0,class:"testLog"},Et={class:"test-buttons"},Le="souma-keigenn-record-2",Mt=Fe({__name:"keigennRecord2",setup(Q){const _=He(),r=_.userOptions;_.recheckIsDev();const F=ye(()=>r.actionCN?"actionCN":"action"),z=S(r.minimize),T={line_height:28*r.scale,time:35*r.scale,action:65*r.scale,target:((r.showIcon?24:0)+(r.showName?r.anonymous||!r.anonymous&&r.abbrId?24:36:0)+7)*r.scale,amount:44*r.scale},w={"--vxe-font-size-mini":`${12*r.scale}px`,"--vxe-table-row-line-height":`${30*r.scale}px`,"--vxe-table-row-height-mini":`${30*r.scale}px`,"--vxe-input-height-mini":`${20*r.scale}px`,"--vxe-select-option-height-mini":`${24*r.scale}px`},ne={runtime:99,localStorage:3},ee=S(!1),oe=S(),C=P("keigenn-record-2-pov-name",""),k=P("keigenn-record-2-pov-id",""),pe=P("keigenn-record-2-party-list",[]),O=P("keigenn-record-2-job-map",{}),ie=P("keigenn-record-2-party-event-party",[]),N=S(0),i=S([{zoneName:"",duration:"00:00",table:[],key:"init"}]),xe={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:j.ability(),statusEffectExplicit:j.statusEffectExplicit(),gainsEffect:j.gainsEffect(),losesEffect:j.losesEffect(),inCombat:/^260\|(?<timestamp>[^|]*)\|(?<inACTCombat>[^|]*)\|(?<inGameCombat>[^|]*)\|/,changeZone:j.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,primaryPlayer:/^02\|(?<timestamp>[^|]*)\|(?<id>[^|]*)\|(?<name>[^|]*)/,addCombatant:j.addedCombatant(),removingCombatant:j.removingCombatant(),networkDoT:j.networkDoT()},b=S(0),Ie=P("souma-keigenn-record-2-zone-name",""),_e=P("souma-keigenn-record-2-rsv-data",{}),ge={},p={friendly:{},enemy:{}};function Re(e){e.table.length=0,e.zoneName="",e.duration="00:00",e.key="init"}function Pe(){ee.value=!0,b.value=0,N.value=0,i.value.length=1,Re(i.value[0])}function Me(){le(),ee.value=!1}function se(e){var t,o,u,f,v,J,W,K,U,m;for(const ue in xe){const H=xe[ue].exec(e);if(H){const a=e.split("|");switch(ue){case"statusEffectExplicit":(t=H.groups)!=null&&t.targetId.startsWith("1")&&(ge[(o=H.groups)==null?void 0:o.targetId]=(u=H.groups)==null?void 0:u.currentShield);break;case"gainsEffect":{const s=a[n.GainsEffect.fields.effectId],c=a[n.GainsEffect.fields.effect],d=a[n.GainsEffect.fields.target],y=a[n.GainsEffect.fields.targetId],$=Number.parseInt(a[n.GainsEffect.fields.count],16);let h=vt(s);if(!h){const I=y.startsWith("1")&&bt.get(Number.parseInt(s,16).toString())||y.startsWith("4")&&yt.get(Number.parseInt(s,16).toString());if(!I)return;const Y=xt(I.icon),te=$>1?It(Y,$):Y;h={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(s,16),fullIcon:te,name:I.name,isFriendly:I.isFriendly}}const Z=a[n.GainsEffect.fields.duration],x=a[n.GainsEffect.fields.source],A=a[n.GainsEffect.fields.sourceId],q=new Date(a[n.GainsEffect.fields.timestamp]).getTime()+Number.parseFloat(Z)*1e3,X={name:h.name,count:$,effect:c,effectId:s,source:x,sourceId:A,target:d,targetId:y,expirationTimestamp:q,performance:h.performance,fullIcon:h.fullIcon,isPov:k.value===A};y.startsWith("1")&&h.isFriendly?(p.friendly[y]===void 0&&(p.friendly[y]={}),p.friendly[y][s]=X):y.startsWith("4")&&!h.isFriendly&&(p.enemy[d]===void 0&&(p.enemy[d]={}),p.enemy[d][s]=X)}break;case"losesEffect":{const s=a[n.LosesEffect.fields.target],c=a[n.LosesEffect.fields.targetId],d=a[n.LosesEffect.fields.effectId];c.startsWith("1")?p.friendly[c]&&Reflect.deleteProperty(p.friendly[c],d):p.enemy[s]&&Reflect.deleteProperty(p.enemy[s],d)}break;case"addCombatant":if(a[n.AddedCombatant.fields.job]!=="00"){const s=a[n.AddedCombatant.fields.job],c=new Date(a[n.AddedCombatant.fields.timestamp]).getTime();O.value[a[n.AddedCombatant.fields.id]]={job:Number.parseInt(s,16),timestamp:c}}break;case"removingCombatant":Reflect.deleteProperty(O.value,a[n.RemovedCombatant.fields.id]);break;case"primaryPlayer":{k.value=a[n.ChangedPlayer.fields.id];const s=a[n.ChangedPlayer.fields.name];if(C.value===s)return;C.value=s,_.initEnvironment(a[n.ChangedPlayer.fields.name]);break}case"partyList":pe.value=((v=(f=H.groups)==null?void 0:f.list)==null?void 0:v.split("|"))??[];break;case"changeZone":Ie.value=a[n.ChangeZone.fields.name],$e(new Date(a[n.ChangeZone.fields.timestamp]).getTime());break;case"inCombat":{const s=a[n.InCombat.fields.inACTCombat]==="1",c=a[n.InCombat.fields.inGameCombat]==="1",d=new Date(a[n.InCombat.fields.timestamp]).getTime();if(s||c){if(b.value>0)return;i.value[0].table.length!==0&&(i.value[0]=ct(i.value[0]),i.value.unshift({zoneName:"",duration:"00:00",table:[],key:a[n.InCombat.fields.timestamp]}),i.value.length>=ne.runtime&&i.value.splice(i.value.length-1,1)),b.value=d,i.value[0].zoneName=Ie.value,N.value=0;return}if(!s&&!c){$e(d);return}}break;case"rsv":{const s=Number((J=H.groups)==null?void 0:J.id),c=a[n.RSVData.fields.value];_e.value[Number(s)]=c}break;case"networkDoT":if(!r.parseDoT)return;{const s=a[n.NetworkDoT.fields.which],c=a[n.NetworkDoT.fields.id];if(s!=="DoT"||c.startsWith("4")||!(c===k.value||pe.value.includes(c)||ie.value.find(te=>te.id===c)))return;const d=a[n.NetworkDoT.fields.name],y=a[n.NetworkDoT.fields.damage],$=Number.parseInt(y,16),h=new Date(a[n.Ability.fields.timestamp]??"???").getTime(),Z=Number(a[n.NetworkDoT.fields.currentHp]),x=Number(a[n.NetworkDoT.fields.maxHp]),A=b.value===0?0:h-b.value,me=re(A),q=we(c),X=M.nameToFullName(M.jobEnumToJob(q)).simple2,I=q,Y=M.jobEnumToIcon(I).toLowerCase();Ne({timestamp:h,time:me,id:void 0,action:s,actionCN:s,source:"",target:d,targetId:c,job:X,jobIcon:Y,jobEnum:I,amount:$,keigenns:[],currentHp:Z,maxHp:x,effect:"damage done",type:"dot",shield:ge[c],povId:k.value})}break;case"ability":if(b.value===0)return;{const s=ft(a);if(s.isAttack&&s.amount>=0){const c=a[n.Ability.fields.sourceId]??"???",d=a[n.Ability.fields.targetId]??"???";if(!(c.startsWith("4")&&d.startsWith("1"))||!(d===k.value||pe.value.includes(d)||ie.value.find(R=>R.id===d)))return;const y=new Date(a[n.Ability.fields.timestamp]??"???").getTime(),$=a[n.Ability.fields.ability],h=$.match(/^_rsv_(?<id>\d+)_/),Z=a[n.Ability.fields.id]??"???";let x=$;if(h){const R=Number((W=h.groups)==null?void 0:W.id);x=_e.value[R]??((U=(K=$.match(/^_(?<id>rsv_\d+)_/))==null?void 0:K.groups)==null?void 0:U.id)}else if(x=x.replace(/unknown_.*/,"攻击"),r.parseAA===!1&&/^攻击|攻撃|[Aa]ttack$/.test(x))return;const A=Ct(Number.parseInt(Z,16)),me=A&&A!==""?A:x,q=Number(a[n.Ability.fields.targetCurrentHp])??"???",X=Number(a[n.Ability.fields.targetMaxHp])??"???",I=a[n.Ability.fields.source]??"???",Y=a[n.Ability.fields.target]??"???",{effect:te,type:Ze}=pt(s.flags),qe=b.value===0?0:y-b.value,Xe=re(qe),De=we(d),Ye=M.nameToFullName(M.jobEnumToJob(De)).cn.substring(0,2),Te=De,Qe=M.jobEnumToIcon(Te).toLowerCase(),et=gt(Object.values(p.friendly[d]??[]).concat(Object.values(p.enemy[I]??[])).filter(R=>{const de=Math.max(0,(R.expirationTimestamp-y)/1e3);return R.remainingDuration=de>=999?"":de.toFixed(de>.05&&de<.95?1:0),Number(R.remainingDuration)>-3}));Ne({timestamp:y,time:Xe,id:Z,action:x,actionCN:me,source:I,target:Y,targetId:d,job:Ye,jobIcon:Qe,jobEnum:Te,amount:s.amount,keigenns:et,currentHp:q,maxHp:X,effect:te,type:Ze,shield:ge[((m=H.groups)==null?void 0:m.targetId)??""],povId:k.value}),i.value[0].duration=re(new Date(a[n.Ability.fields.timestamp]).getTime()-b.value)}break}}}}}function we(e){const t=O.value[e],o=ie.value.find(u=>u.id===e)??{job:0,timestamp:0};return[t,o].sort((u,f)=>f.timestamp-u.timestamp)[0].job}function Ne(e){i.value[0].table.unshift(e)}function $e(e){b.value!==0&&(i.value[0].duration=re(e-b.value),b.value=0,p.friendly={},p.enemy={},le())}function le(){localStorage.setItem(Le,JSON.stringify(i.value.slice(0,ne.localStorage)))}function Be(){const e=localStorage.getItem(Le);if(e)try{const t=JSON.parse(e);i.value.length=0,i.value.push(...t)}catch(t){console.error(t)}}function re(e){const t=Math.max(Math.floor(e/6e4),0),o=Math.max(Math.floor((e-t*6e4)/1e3),0);return`${t<10?"0":""}${t}:${o<10?"0":""}${o}`}const Ge=ye(()=>{const e=new Set(i.value[N.value].table.map(t=>r.actionCN?t.actionCN:t.action));return Array.from(e).map(t=>({label:t,value:t}))}),Oe=ye(()=>{const e={},t=new Set(i.value[N.value].table.slice().sort((o,u)=>M.enumSortMethod(o.jobEnum,u.jobEnum)).map(o=>(e[o.target]=o.job,o.target)));return Array.from(t).map(o=>({label:`${e[o]}（${o}）`,value:o}))});_.isDev&&(C.value="测试用户"),C.value!==""&&_.initEnvironment(C.value),nt(()=>{for(const e in O.value){const t=O.value[e];Date.now()-t.timestamp>1e3*60*60*24*1&&Reflect.deleteProperty(O.value,e)}Be(),he("LogLine",e=>{se(e.rawLine)}),he("PartyChanged",e=>{ie.value=e.party.map(t=>({...t,timestamp:Date.now()}))}),he("ChangePrimaryPlayer",e=>{C.value=e.charName,k.value=Number(e.charID).toString(16).toUpperCase()})});function Ve(e){const{action:t,actionCN:o,amount:u,job:f,keigenns:v,source:J,target:W,time:K,type:U}=e,m=e.effect==="damage done"?"":`,${Ce(e.effect)}`,ue=`${K} [${f}]${W} HP:${e.currentHp}/${e.maxHp}(${Math.round(e.currentHp/e.maxHp*100)}%)+盾:${Math.round(e.maxHp*+e.shield/100)}(${e.shield}%),受到${J}“${t}${o!==t?`(${o})`:""}”的 ${u.toLocaleString()} 点${Ce(U)}伤害。减伤:${v.length===0&&m===""?"无":v.map(be=>r.statusCN?be.name:be.effect).join(",")+m}`;Je(ue)}function Je(e){navigator.clipboard.writeText(e).catch(()=>{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}),Se.modal.message({content:"已复制到剪贴板",status:"success"})}const E=S({target:!1,action:!1}),V=S(),ve=ot({className:"my-menus",body:{options:[]}});it(()=>{var e,t,o,u;(e=ve.body)!=null&&e.options&&oe.value&&(ve.body.options[0]=[{code:"copy",name:"复制详情",prefixIcon:"vxe-icon-copy",className:"my-copy-item"},{code:"clearFilterAction",name:"取消技能筛选",prefixIcon:"vxe-icon-funnel-clear",className:"my-clear-filter",visible:E.value.action,disabled:!1},{code:"filterSelectAction",name:(t=V.value)!=null&&t[F.value]?`只看 ${(o=V.value)==null?void 0:o[F.value]}`:"只看该技能",prefixIcon:"vxe-icon-info-circle",visible:!E.value.action,disabled:!1},{code:"clearFilterTarget",name:"取消玩家筛选",prefixIcon:"vxe-icon-funnel-clear",visible:E.value.target,disabled:!1},{code:"filterSelectTarget",name:(u=V.value)!=null&&u.target?`只看[${V.value.job}] ${V.value.target}`:"只看该玩家",prefixIcon:"vxe-icon-user-fill",visible:!E.value.target,disabled:!1}])});function We(){z.value=!z.value}const Ke=({row:e})=>{const t=oe.value;t&&(t.setCurrentRow(e),V.value=e)},Ue=({menu:e,row:t})=>{const o=oe.value;switch(e.code){case"copy":if(!t){Se.modal.message({content:"未选中有效数据行",status:"error"});return}Ve(t);break;case"clearFilterTarget":o&&(o.clearFilter(o.getColumnByField("target")),E.value.target=!1);break;case"clearFilterAction":o&&(o.clearFilter(o.getColumnByField(F.value)),E.value.action=!1);break;case"filterSelectTarget":if(o){const u=o.getColumnByField("target");if(u){const f=u.filters.find(v=>v.value===t.target);if(!f)return;f.checked=!0,o.updateData().then(()=>{o.scrollToRow(t),E.value.target=!0})}}break;case"filterSelectAction":if(o){const u=o.getColumnByField(F.value);if(u){const f=u.filters.find(v=>v.value===t[F.value]);if(!f)return;f.checked=!0,o.updateData().then(()=>{o.scrollToRow(t),E.value.action=!0})}}break}},ce={clearData:()=>{N.value=0,i.value.length=0,i.value.push({key:Date.now().toString(),zoneName:"测试地区",duration:"00:00",table:[]}),b.value=0,p.friendly={},p.enemy={},le()},fakeData:()=>{i.value[0].table.push({timestamp:1e4,time:i.value[0].table.length.toString(),id:void 0,action:"测试动作",actionCN:"测试动作",source:"测试敌人",target:C.value,targetId:"1234567890",job:"战士",jobIcon:"warrior",jobEnum:0,amount:1e3,keigenns:[{name:"整体盾",count:0,effect:"整体盾",effectId:"D25",source:"芸豆角包子",sourceId:"1011A008",target:"芸豆角包子",targetId:"1011A008",expirationTimestamp:1712757148883,performance:{physics:1,magic:1,darkness:1},fullIcon:"012000/012972",isPov:!1,remainingDuration:"14"},{name:"整体论",count:0,effect:"整体论",effectId:"BBB",source:"芸豆角包子",sourceId:"1011A008",target:"芸豆角包子",targetId:"1011A008",expirationTimestamp:1712757138883,performance:{physics:1,magic:1,darkness:1},fullIcon:"012000/012971",isPov:!1,remainingDuration:"4"},{name:"均衡预后",count:0,effect:"均衡预后",effectId:"A31",source:"芸豆角包子",sourceId:"1011A008",target:"芸豆角包子",targetId:"1011A008",expirationTimestamp:1712757153915,performance:{physics:1,magic:1,darkness:1},fullIcon:"012000/012954",isPov:!1,remainingDuration:"19"}],currentHp:1e3,maxHp:1e3,effect:"damage done",type:"magic",shield:"0",povId:k.value}),le()},fakeLogDamage:()=>{b.value=Date.now(),se(`21|${new Date}|4000044A|万魔殿|829A|尖脚|${k.value}|${C.value}|720203|B0F10000|9F0E|8200000|1B|829A8000|0|0|0|0|0|0|0|0|0|0|155065|155065|10000|10000|||94.62|98.28|0.00|-3.13|44|44|0|10000|||92.00|100.00|0.00|0.00|000010B3|0|1|fd5fa47ff773c3ca`)},fakeLogStatus:()=>{se(`26|${new Date}|59|复仇|15.00|${k.value}|${C.value}|${k.value}|${C.value}|64|129221|129221|b6388ee76760c33b`)}};return(e,t)=>{const o=ae("vxe-option"),u=ae("vxe-select"),f=ae("vxe-button"),v=ae("vxe-column"),J=ht,W=kt,K=Dt,U=ae("vxe-table");return L(),B(ke,null,[G("div",{class:"wrapper",style:w},[G("header",null,[Ee(g(u,{modelValue:l(N),"onUpdate:modelValue":t[0]||(t[0]=m=>st(N)?N.value=m:null),size:"mini",class:"select"},{default:D(()=>[(L(!0),B(ke,null,ze(l(i).length,m=>(L(),ut(o,{key:`${l(i)[m-1].key}-${l(i)[m-1].duration}-${l(i)[m-1].zoneName}`,value:m-1,label:`${l(i)[m-1].duration} ${l(i)[m-1].zoneName}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue"]),[[Ae,!l(z)]]),g(f,{class:"minimize",icon:l(z)?"vxe-icon-fullscreen":"vxe-icon-minimize",style:lt({opacity:l(z)?.5:1}),onClick:We},null,8,["icon","style"])]),Ee(G("main",null,[g(U,{ref_key:"xTable",ref:oe,size:"mini",class:"vxe-table","show-overflow":"tooltip",round:"",height:"100%","scroll-y":{enabled:!0},loading:l(ee),"show-header":l(r).showHeader,data:l(i)[l(N)].table,"row-config":{isHover:!0,height:T.line_height},"header-cell-style":{padding:"0px"},"menu-config":l(ve),onCellMenu:Ke,onMenuClick:Ue},{default:D(()=>[g(v,{width:T.time,field:"time",title:"时间",align:"center"},null,8,["width"]),g(v,{width:T.action,field:l(r).actionCN?"actionCN":"action",title:"技能",filters:l(Ge),"filter-multiple":!1,resizable:!1,align:"center"},null,8,["width","field","filters"]),g(v,{width:T.target,field:"target",title:l(r).showName?"目标":"目",filters:l(Oe),"filter-multiple":!1,resizable:!l(r).anonymous&&!l(r).abbrId,align:"left","header-align":"center"},{default:D(({row:m})=>[g(J,{row:m},null,8,["row"])]),_:1},8,["width","title","filters","resizable"]),g(v,{width:T.amount,title:"伤害","header-align":"center"},{default:D(({row:m})=>[g(W,{row:m},null,8,["row"])]),_:1},8,["width"]),g(v,{title:"减伤",align:"left"},{default:D(({row:m})=>[g(K,{row:m},null,8,["row"])]),_:1})]),_:1},8,["loading","show-header","data","row-config","menu-config"])],512),[[Ae,!l(z)]])]),l(_).isDev?(L(),B("div",Tt,[G("div",Et,[g(f,{class:"test-button",type:"primary",onClick:ce.clearData},{default:D(()=>[fe(" 清空 ")]),_:1},8,["onClick"]),g(f,{class:"test-button",type:"primary",onClick:ce.fakeData},{default:D(()=>[fe(" 假条目 ")]),_:1},8,["onClick"]),g(f,{class:"test-button",type:"primary",onClick:ce.fakeLogDamage},{default:D(()=>[fe(" 假伤害 ")]),_:1},8,["onClick"]),g(f,{class:"test-button",type:"primary",onClick:ce.fakeLogStatus},{default:D(()=>[fe(" 假状态 ")]),_:1},8,["onClick"])]),g(dt,{onBeforeHandle:Pe,onAfterHandle:Me,onHandleLine:se})])):rt("",!0)],64)}}});export{Mt as default};
