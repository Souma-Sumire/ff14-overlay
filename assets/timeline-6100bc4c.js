import{d as Z,J as H,n as S,q as K,p as V,b as Q,aw as A,o as u,e as m,u as a,F as W,L as X,$ as g,a as Y,y as M,T as ee,U as j}from"./vendor-11da2b7e.js";import{u as te,p as ne,_ as oe}from"./TimelineShow-75c5cb92.js";import{a as _,c as D}from"./overlay_plugin_api-409cb9ea.js";import{_ as ie}from"./_plugin-vue_export-helper-c27b6911.js";import"./util-831b56e7.js";import"./xivapi-a5c0f7f0.js";const ae={id:"wrapper"},le={key:0,class:"optionalTimelines"},se=["onClick"],re={key:6,style:{color:"white","background-color":"black"}},ce=Z({__name:"timeline",setup(ue){const n=te(),s=H({loadedTimeline:[],optionalTimeline:[]}),p=S(0),c=S(0-n.configValues.preBattle),C=S(0);let T=!1;const v=K("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),I=new URLSearchParams(location.hash.split("?")[1]),y=S(window.location.href.match(/localhost/)||I.get("dev")==="1"),L=V(()=>s.loadedTimeline.filter(e=>e.sync)),k=V(()=>s.loadedTimeline.filter(e=>e.tts));Q(()=>{R()});function w(){h(),s.loadedTimeline.length=0,s.optionalTimeline.length=0;const e=n.getTimeline(v.value);e.length===1?B(e[0]):e.length>1&&(s.optionalTimeline=e)}function O(e){B(e)}async function B(e,t=!0){t&&h(),T=!1,e!=null&&e.timeline&&(s.loadedTimeline=await ne(e.timeline),s.loadedTimeline.sort((i,o)=>i.time-o.time),A.fire({position:"top-end",icon:"success",text:`加载了${e.name}`,showConfirmButton:!1,timer:1e3,backdrop:!1})),setTimeout(()=>{T=!0},1e3)}function h(){p.value=0,c.value=0-n.configValues.preBattle,C.value=0;for(const e of s.loadedTimeline)e.alertAlready=!1;for(const e of L.value)e.syncAlready=!1}function b(e,t=!0){t&&(T=!1,setTimeout(()=>{T=!0},1e3)),c.value=0,C.value=0,p.value=new Date().getTime()+e*1e3,k.value.forEach(i=>{i.alertAlready=!1}),$()}function $(){if(p.value===0)return;c.value=(new Date().getTime()-p.value+C.value)/1e3;const e=k.value.find(t=>!t.alertAlready&&t.time-n.configValues.ttsAdvance<=c.value);e&&(e.alertAlready=!0,e.tts&&x(e.tts)),requestAnimationFrame($)}function N(e){var t,i,o;for(const r of e.detail.logs){const d=r.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(d)b(Number.parseInt(((t=d==null?void 0:d.groups)==null?void 0:t.cd)||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(r)||/^.{14} ChatLog 00:0038::end$/.test(r)||/^.{14} SystemLogMessage 29:.{8}:B1C:/.test(r))h();else{const f=L.value.find(l=>l.sync&&(l.syncOnce&&!l.syncAlready||!l.syncOnce)&&c.value>=l.time-l.windowBefore&&c.value<=l.time+Number(l.windowAfter)&&l.sync.test(r));f&&(f.syncAlready=!0,E(f.jump||f.time))}if(/^.{14} ChatLog 00:0038::/.test(r)){const f=(o=(i=r.match(/^.{14} ChatLog 00:0038::(?<name>.+)$/))==null?void 0:i.groups)==null?void 0:o.name;if(f){const l=n.getTimeline(v.value).find(U=>U.name===f);l&&B(l,!1)}}}}function P(e){E(e)}function E(e){p.value===0&&b(0,!1),C.value+=(e-c.value)*1e3,k.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}const F=e=>{v.value.jobs[0]=e.detail.job,e.detail.job!==v.value.jobs[0]&&w()},z=e=>{v.value.zoneId=String(e.zoneID),w()};function x(e,t=!1){e&&(T||t)&&D({call:"cactbotSay",text:e})}function q(e,t={}){D({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const G=e=>{if(e.source==="soumaTimelineSettings"){if(e.msg.type==="post"){let t=function(){for(const o of i.allTimelines)o.condition.jobs===void 0&&(o.condition.jobs=[o.condition.job]),o.condition.jobs.sort((r,d)=>n.jobList.indexOf(r)-n.jobList.indexOf(d)),Reflect.deleteProperty(o.condition,"job");n.allTimelines=i.allTimelines,n.configValues=i.configValues,n.showStyle=i.showStyle,n.saveTimelineSettings(),j.closeAll(),j({message:"已更新数据",type:"success",duration:0,showClose:!0}),w()};const i=e.msg.data;i.allTimelines.length<n.allTimelines.length-1?ee.confirm(i.allTimelines.length===0?"传入数据为空. 确定要清空数据吗?":"你删除了2条以上的时间轴. 确定吗?","警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{t()}).catch(()=>{j({type:"info",message:"操作已取消"})}):t()}e.msg.type==="get"&&q("post",n.$state)}};function J(e){e.detail.inGameCombat&&e.detail.inACTCombat&&p.value===0?b(0):!e.detail.inGameCombat&&!e.detail.inACTCombat&&h()}function R(){_("onLogEvent",N),_("onPlayerChangedEvent",F),_("ChangeZone",z),_("BroadcastMessage",G),_("onInCombatChangedEvent",J),n.loadTimelineSettings(),A.isVisible()||A.fire({text:`${n.allTimelines.length}条时间轴已就绪`,showConfirmButton:!1,timer:1500,backdrop:!1}),w()}return(e,t)=>{const i=oe;return u(),m("div",ae,[a(s).optionalTimeline.length&&a(c)<=-a(n).configValues.preBattle?(u(),m("ul",le,[(u(!0),m(W,null,X(a(s).optionalTimeline,(o,r)=>(u(),m("li",{key:r,onClick:d=>O(o)},M(o.name),9,se))),128))])):g("",!0),Y(i,{config:a(n).configValues,lines:a(s).loadedTimeline,runtime:a(c),"show-style":a(n).showStyle},null,8,["config","lines","runtime","show-style"]),a(y)?(u(),m("button",{key:1,onClick:t[0]||(t[0]=o=>b(30))}," 开始从-30 ")):g("",!0),a(y)?(u(),m("button",{key:2,onClick:t[1]||(t[1]=o=>b(0))}," 开始从0 ")):g("",!0),a(y)?(u(),m("button",{key:3,onClick:t[2]||(t[2]=o=>h())}," 团灭 ")):g("",!0),a(y)?(u(),m("button",{key:4,onClick:t[3]||(t[3]=o=>P(1e3))}," 跳转1000测试 ")):g("",!0),a(y)?(u(),m("button",{key:5,onClick:t[4]||(t[4]=o=>x("今天天气真不错",!0))}," TTS测试 ")):g("",!0),a(y)?(u(),m("span",re,M(a(c)),1)):g("",!0)])}}});const Te=ie(ce,[["__scopeId","data-v-8dcb72e2"]]);export{Te as default};
