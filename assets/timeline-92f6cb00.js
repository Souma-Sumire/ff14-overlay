import{d as H,J as R,n as k,q as K,p as x,b as Q,ai as A,o as c,e as u,u as a,F as W,L as X,a0 as g,a as Y,y as E,T as ee,U as L}from"./vendor-688a9a69.js";import{u as te,p as ne,_ as ae}from"./TimelineShow-28dd63e2.js";import{a as b,c as D}from"./overlay_plugin_api-409cb9ea.js";import{_ as oe}from"./_plugin-vue_export-helper-c27b6911.js";import"./util-831b56e7.js";import"./xivapi-a5c0f7f0.js";const ie={id:"wrapper"},le={key:0,class:"optionalTimelines"},se=["onClick"],re={key:6,style:{color:"white","background-color":"black"}},ce=H({__name:"timeline",setup(ue){const n=te(),s=R({loadedTimeline:[],optionalTimeline:[]}),p=k(0),r=k(0-n.configValues.preBattle),C=k(0);let v=!1;const m=K("timeline-condition",{zoneId:"0",job:"NONE"}),I=new URLSearchParams(location.hash.split("?")[1]),y=k(window.location.href.match(/localhost/)||I.get("dev")==="1"),$=x(()=>s.loadedTimeline.filter(e=>e.sync)),S=x(()=>s.loadedTimeline.filter(e=>e.tts));Q(()=>{U()});function w(e){T(),s.loadedTimeline.length=0,s.optionalTimeline.length=0;const t=n.getTimeline(e);t.length===1?B(t[0]):t.length>1&&(s.optionalTimeline=t)}function N(e){B(e)}async function B(e,t=!0){t&&T(),v=!1,e!=null&&e.timeline&&(s.loadedTimeline=await ne(e.timeline),s.loadedTimeline.sort((o,i)=>o.time-i.time),A.fire({position:"top-end",icon:"success",text:`加载了${e.name}`,showConfirmButton:!1,timer:1e3,backdrop:!1})),setTimeout(()=>{v=!0},1e3)}function T(){p.value=0,r.value=0-n.configValues.preBattle,C.value=0;for(const e of s.loadedTimeline)e.alertAlready=!1;for(const e of $.value)e.syncAlready=!1}function h(e,t=!0){t&&(v=!1,setTimeout(()=>{v=!0},1e3)),r.value=0,C.value=0,p.value=new Date().getTime()+e*1e3,S.value.forEach(o=>{o.alertAlready=!1}),V()}function V(){if(p.value===0)return;r.value=(new Date().getTime()-p.value+C.value)/1e3;const e=S.value.find(t=>!t.alertAlready&&t.time-n.configValues.ttsAdvance<=r.value);e&&(e.alertAlready=!0,e.tts&&M(e.tts)),requestAnimationFrame(V)}function O(e){var t,o,i;for(const d of e.detail.logs){const _=d.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(_)h(Number.parseInt(((t=_==null?void 0:_.groups)==null?void 0:t.cd)||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(d)||/^.{14} ChatLog 00:0038::end$/.test(d)||/^.{14} SystemLogMessage 29:.{8}:B1C:/.test(d))T();else{const f=$.value.find(l=>l.sync&&(l.syncOnce&&!l.syncAlready||!l.syncOnce)&&r.value>=l.time-l.windowBefore&&r.value<=l.time+Number(l.windowAfter)&&l.sync.test(d));f&&(f.syncAlready=!0,j(f.jump||f.time))}if(/^.{14} ChatLog 00:0038::/.test(d)){const f=(i=(o=d.match(/^.{14} ChatLog 00:0038::(?<name>.+)$/))==null?void 0:o.groups)==null?void 0:i.name;if(f){const l=n.getTimeline(m.value).find(Z=>Z.name===f);l&&B(l,!1)}}}}function F(e){j(e)}function j(e){p.value===0&&h(0,!1),C.value+=(e-r.value)*1e3,S.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}const P=e=>{e.detail.job!==m.value.job?(m.value.job=e.detail.job,w(m.value)):m.value.job=e.detail.job},z=e=>{m.value.zoneId=String(e.zoneID),w(m.value)};function M(e,t=!1){e&&(v||t)&&D({call:"cactbotSay",text:e})}function q(e,t={}){D({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const G=e=>{if(e.source==="soumaTimelineSettings"){if(e.msg.type==="post"){let t=function(){n.allTimelines=o.allTimelines,n.configValues=o.configValues,n.showStyle=o.showStyle,n.saveTimelineSettings(),L.closeAll(),L({message:"已更新数据",type:"success",duration:0,showClose:!0}),w(m.value)};const o=e.msg.data;o.allTimelines.length<n.allTimelines.length-1?ee.confirm(o.allTimelines.length===0?"传入数据为空. 确定要清空数据吗?":"你删除了2条以上的时间轴. 确定吗?","警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{t()}).catch(()=>{L({type:"info",message:"操作已取消"})}):t()}e.msg.type==="get"&&q("post",n.$state)}};function J(e){e.detail.inGameCombat&&e.detail.inACTCombat&&p.value===0?h(0):!e.detail.inGameCombat&&!e.detail.inACTCombat&&T()}function U(){b("onLogEvent",O),b("onPlayerChangedEvent",P),b("ChangeZone",z),b("BroadcastMessage",G),b("onInCombatChangedEvent",J),n.loadTimelineSettings(),A.isVisible()||A.fire({text:`${n.allTimelines.length}条时间轴已就绪`,showConfirmButton:!1,timer:1500,backdrop:!1}),w(m.value)}return(e,t)=>{const o=ae;return c(),u("div",ie,[a(s).optionalTimeline.length&&a(r)<=-a(n).configValues.preBattle?(c(),u("ul",le,[(c(!0),u(W,null,X(a(s).optionalTimeline,(i,d)=>(c(),u("li",{key:d,onClick:_=>N(i)},E(i.condition.job)+" - "+E(i.name),9,se))),128))])):g("",!0),Y(o,{config:a(n).configValues,lines:a(s).loadedTimeline,runtime:a(r),"show-style":a(n).showStyle},null,8,["config","lines","runtime","show-style"]),a(y)?(c(),u("button",{key:1,onClick:t[0]||(t[0]=i=>h(30))}," 开始从-30 ")):g("",!0),a(y)?(c(),u("button",{key:2,onClick:t[1]||(t[1]=i=>h(0))}," 开始从0 ")):g("",!0),a(y)?(c(),u("button",{key:3,onClick:t[2]||(t[2]=i=>T())}," 团灭 ")):g("",!0),a(y)?(c(),u("button",{key:4,onClick:t[3]||(t[3]=i=>F(1e3))}," 跳转1000测试 ")):g("",!0),a(y)?(c(),u("button",{key:5,onClick:t[4]||(t[4]=i=>M("今天天气真不错",!0))}," TTS测试 ")):g("",!0),a(y)?(c(),u("span",re,E(a(r)),1)):g("",!0)])}}});const ve=oe(ce,[["__scopeId","data-v-8b2a3f99"]]);export{ve as default};
