import{d as ze,o as w,e as D,F as he,J as Fe,q as ae,t as tt,u as s,N as at,m as ve,l as L,n as G,b as nt,H as ot,Y as it,r as te,p as De,v as Ae,a as g,w as E,$ as st,O as lt,a6 as be,s as de,ay as rt,az as Se,c as ct}from"./vendor-0825ff50.js";import{u as He,t as ke,m as ut,a as mt,p as dt,b as ft,d as pt,g as gt,e as vt,f as bt,_ as yt,c as ht}from"./flags-246a85f2.js";import{g as kt,h as je}from"./xivapi-d474f14e.js";import{N as z,l as n}from"./netregexes-2830d8aa.js";import{a as ye}from"./overlay_plugin_api-409cb9ea.js";import{U as O}from"./util-6ab7166a.js";import{g as Ct}from"./actionChinese-14fd9964.js";import{c as _t,a as xt}from"./status-ea9dd8b5.js";import"./_plugin-vue_export-helper-c27b6911.js";const It={key:0},wt={key:1},Nt=["title","data-duration","data-sourcePov"],$t=["src","alt"],Tt=ze({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(X){const k=X,F=He().icon4k;return(H,A)=>k.row.type==="dot"?(w(),D("div",It," （不支持） ")):(w(),D("div",wt,[(w(!0),D(he,null,Fe(k.row.keigenns,(N,ne)=>(w(),D("span",{key:ne},[ae("span",{class:"status",title:`${N.name}(${N.source})`,"data-duration":N.remainingDuration,"data-sourcePov":N.isPov},[ae("img",{class:at(`statusIcon ${s(ut)(N.performance[X.row.type])}`),src:s(kt)(`/i/${N.fullIcon}${s(F)}.png`),alt:N.effect,loading:"lazy",onError:A[0]||(A[0]=(...Q)=>s(je)&&s(je)(...Q))},null,42,$t)],8,Nt)]))),128)),ae("span",null,tt(X.row.effect==="damage done"?"":s(ke)(X.row.effect)),1)]))}}),Et={key:0},Dt={key:0,class:"testLog"},At={key:0,class:"test-buttons"},Le="souma-keigenn-record-2",Gt=ze({__name:"keigennRecord2",setup(X){const k=He(),r=k.userOptions;k.recheckIsDev();const F=ve(()=>r.actionCN?"actionCN":"action"),H=L(r.minimize),A={line_height:28*r.scale,time:35*r.scale,action:65*r.scale,target:((r.showIcon?24:0)+(r.showName?r.anonymous||!r.anonymous&&r.abbrId?24:36:0)+7)*r.scale,amount:44*r.scale},N={"--vxe-font-size-mini":`${12*r.scale}px`,"--vxe-table-row-line-height":`${30*r.scale}px`,"--vxe-table-row-height-mini":`${30*r.scale}px`,"--vxe-input-height-mini":`${20*r.scale}px`,"--vxe-select-option-height-mini":`${24*r.scale}px`},ne={runtime:99,localStorage:3},Q=L(!1),oe=L(),_=G("keigenn-record-2-pov-name",""),C=G("keigenn-record-2-pov-id",""),fe=G("keigenn-record-2-party-list",[]),V=G("keigenn-record-2-job-map",{}),ie=G("keigenn-record-2-party-event-party",[]),$=L(0),i=L([{zoneName:"",duration:"00:00",table:[],key:"init"}]),Ce={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:z.ability(),statusEffectExplicit:z.statusEffectExplicit(),gainsEffect:z.gainsEffect(),losesEffect:z.losesEffect(),inCombat:/^260\|(?<timestamp>[^|]*)\|(?<inACTCombat>[^|]*)\|(?<inGameCombat>[^|]*)\|/,changeZone:z.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,primaryPlayer:/^02\|(?<timestamp>[^|]*)\|(?<id>[^|]*)\|(?<name>[^|]*)/,addCombatant:z.addedCombatant(),removingCombatant:z.removingCombatant(),networkDoT:z.networkDoT()},v=L(0),_e=G("souma-keigenn-record-2-zone-name",""),xe=G("souma-keigenn-record-2-rsv-data",{}),pe={},p={friendly:{},enemy:{}};function Re(e){e.table.length=0,e.zoneName="",e.duration="00:00",e.key="init"}function Pe(){Q.value=!0,v.value=0,$.value=0,i.value.length=1,Re(i.value[0])}function Be(){le(),Q.value=!1}function se(e){var t,o,u,d,b,W,R,K,P,f;for(const $e in Ce){const B=Ce[$e].exec(e);if(B){const a=e.split("|");switch($e){case"statusEffectExplicit":(t=B.groups)!=null&&t.targetId.startsWith("1")&&(pe[(o=B.groups)==null?void 0:o.targetId]=(u=B.groups)==null?void 0:u.currentShield);break;case"gainsEffect":{const l=a[n.GainsEffect.fields.effectId],c=a[n.GainsEffect.fields.effect],m=a[n.GainsEffect.fields.target],y=a[n.GainsEffect.fields.targetId],T=Number.parseInt(a[n.GainsEffect.fields.count],16);let h=gt(l);if(!h){const I=y.startsWith("1")&&vt.get(Number.parseInt(l,16).toString())||y.startsWith("4")&&bt.get(Number.parseInt(l,16).toString());if(!I)return;const Y=_t(I.icon),ee=T>1?xt(Y,T):Y;h={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(l,16),fullIcon:ee,name:I.name,isFriendly:I.isFriendly}}const U=a[n.GainsEffect.fields.duration],x=a[n.GainsEffect.fields.source],j=a[n.GainsEffect.fields.sourceId],Z=new Date(a[n.GainsEffect.fields.timestamp]).getTime()+Number.parseFloat(U)*1e3,q={name:h.name,count:T,effect:c,effectId:l,source:x,sourceId:j,target:m,targetId:y,expirationTimestamp:Z,performance:h.performance,fullIcon:h.fullIcon,isPov:C.value===j};y.startsWith("1")&&h.isFriendly?(p.friendly[y]===void 0&&(p.friendly[y]={}),p.friendly[y][l]=q):y.startsWith("4")&&!h.isFriendly&&(p.enemy[m]===void 0&&(p.enemy[m]={}),p.enemy[m][l]=q)}break;case"losesEffect":{const l=a[n.LosesEffect.fields.target],c=a[n.LosesEffect.fields.targetId],m=a[n.LosesEffect.fields.effectId];c.startsWith("1")?p.friendly[c]&&Reflect.deleteProperty(p.friendly[c],m):p.enemy[l]&&Reflect.deleteProperty(p.enemy[l],m)}break;case"addCombatant":if(a[n.AddedCombatant.fields.job]!=="00"){const l=a[n.AddedCombatant.fields.job],c=new Date(a[n.AddedCombatant.fields.timestamp]).getTime();V.value[a[n.AddedCombatant.fields.id]]={job:Number.parseInt(l,16),timestamp:c}}break;case"removingCombatant":Reflect.deleteProperty(V.value,a[n.RemovedCombatant.fields.id]);break;case"primaryPlayer":{C.value=a[n.ChangedPlayer.fields.id];const l=a[n.ChangedPlayer.fields.name];if(_.value===l)return;_.value=l,k.initEnvironment(a[n.ChangedPlayer.fields.name]);break}case"partyList":fe.value=((b=(d=B.groups)==null?void 0:d.list)==null?void 0:b.split("|"))??[];break;case"changeZone":_e.value=a[n.ChangeZone.fields.name],Ne(new Date(a[n.ChangeZone.fields.timestamp]).getTime());break;case"inCombat":{const l=a[n.InCombat.fields.inACTCombat]==="1",c=a[n.InCombat.fields.inGameCombat]==="1",m=new Date(a[n.InCombat.fields.timestamp]).getTime();if(l||c){if(v.value>0)return;i.value[0].key==="placeholder"&&i.value.splice(0,1),i.value[0].table.length!==0&&(i.value[0]=rt(i.value[0]),i.value.unshift({zoneName:"",duration:"00:00",table:[],key:a[n.InCombat.fields.timestamp]}),i.value.length>=ne.runtime&&i.value.splice(i.value.length-1,1)),v.value=m,i.value[0].zoneName=_e.value,$.value=0;return}if(!l&&!c){Ne(m);return}}break;case"rsv":{const l=Number((W=B.groups)==null?void 0:W.id),c=a[n.RSVData.fields.value];xe.value[Number(l)]=c}break;case"networkDoT":if(!r.parseDoT)return;{const l=a[n.NetworkDoT.fields.which],c=a[n.NetworkDoT.fields.id];if(l!=="DoT"||c.startsWith("4")||!(c===C.value||fe.value.includes(c)||ie.value.find(ee=>ee.id===c)))return;const m=a[n.NetworkDoT.fields.name],y=a[n.NetworkDoT.fields.damage],T=Number.parseInt(y,16),h=new Date(a[n.Ability.fields.timestamp]??"???").getTime(),U=Number(a[n.NetworkDoT.fields.currentHp]),x=Number(a[n.NetworkDoT.fields.maxHp]),j=v.value===0?0:h-v.value,ue=re(j),Z=Ie(c),q=O.nameToFullName(O.jobEnumToJob(Z)).simple2,I=Z,Y=O.jobEnumToIcon(I).toLowerCase();we({timestamp:h,time:ue,id:void 0,action:l,actionCN:l,source:"",target:m,targetId:c,job:q,jobIcon:Y,jobEnum:I,amount:T,keigenns:[],currentHp:U,maxHp:x,effect:"damage done",type:"dot",shield:pe[c],povId:C.value})}break;case"ability":if(v.value===0)return;{const l=dt(a);if(l.isAttack&&l.amount>=0){const c=a[n.Ability.fields.sourceId]??"???",m=a[n.Ability.fields.targetId]??"???";if(!(c.startsWith("4")&&m.startsWith("1"))||!(m===C.value||fe.value.includes(m)||ie.value.find(M=>M.id===m)))return;const y=new Date(a[n.Ability.fields.timestamp]??"???").getTime(),T=a[n.Ability.fields.ability],h=T.match(/^_rsv_(?<id>\d+)_/),U=a[n.Ability.fields.id]??"???";let x=T;if(h){const M=Number((R=h.groups)==null?void 0:R.id);x=xe.value[M]??((P=(K=T.match(/^_(?<id>rsv_\d+)_/))==null?void 0:K.groups)==null?void 0:P.id)}else if(x=x.replace(/unknown_.*/,"攻击"),r.parseAA===!1&&/^攻击|攻撃|[Aa]ttack$/.test(x))return;const j=Ct(Number.parseInt(U,16)),ue=j&&j!==""?j:x,Z=Number(a[n.Ability.fields.targetCurrentHp])??"???",q=Number(a[n.Ability.fields.targetMaxHp])??"???",I=a[n.Ability.fields.source]??"???",Y=a[n.Ability.fields.target]??"???",{effect:ee,type:Ze}=ft(l.flags),qe=v.value===0?0:y-v.value,Ye=re(qe),Te=Ie(m),Xe=O.nameToFullName(O.jobEnumToJob(Te)).simple2,Ee=Te,Qe=O.jobEnumToIcon(Ee).toLowerCase(),et=pt(Object.values(p.friendly[m]??[]).concat(Object.values(p.enemy[I]??[])).filter(M=>{const me=Math.max(0,(M.expirationTimestamp-y)/1e3);return M.remainingDuration=me>=999?"":me.toFixed(me>.05&&me<.95?1:0),Number(M.remainingDuration)>-3}));we({timestamp:y,time:Ye,id:U,action:x,actionCN:ue,source:I,target:Y,targetId:m,job:Xe,jobIcon:Qe,jobEnum:Ee,amount:l.amount,keigenns:et,currentHp:Z,maxHp:q,effect:ee,type:Ze,shield:pe[((f=B.groups)==null?void 0:f.targetId)??""],povId:C.value}),i.value[0].duration=re(new Date(a[n.Ability.fields.timestamp]).getTime()-v.value)}break}}}}}function Ie(e){const t=V.value[e],o=ie.value.find(u=>u.id===e)??{job:0,timestamp:0};return[t,o].sort((u,d)=>d.timestamp-u.timestamp)[0].job}function we(e){i.value[0].table.unshift(e)}function Ne(e){v.value!==0&&(i.value[0].duration=re(e-v.value),v.value=0,p.friendly={},p.enemy={},le())}function le(){localStorage.setItem(Le,JSON.stringify(i.value.slice(0,ne.localStorage)))}function Me(){const e=localStorage.getItem(Le);if(e)try{const t=JSON.parse(e);i.value.length=0,i.value.push(...t)}catch(t){console.error(t)}}function re(e){const t=Math.max(Math.floor(e/6e4),0),o=Math.max(Math.floor((e-t*6e4)/1e3),0);return`${t<10?"0":""}${t}:${o<10?"0":""}${o}`}const Ge=ve(()=>{const e=new Set(i.value[$.value].table.map(t=>r.actionCN?t.actionCN:t.action));return Array.from(e).map(t=>({label:t,value:t}))}),Oe=ve(()=>{const e={},t=new Set(i.value[$.value].table.slice().sort((o,u)=>O.enumSortMethod(o.jobEnum,u.jobEnum)).map(o=>(e[o.target]=o.job,o.target)));return Array.from(t).map(o=>({label:`${e[o]}（${o}）`,value:o}))});k.isBrowser&&(_.value="测试用户"),_.value!==""&&k.initEnvironment(_.value),nt(()=>{for(const e in V.value){const t=V.value[e];Date.now()-t.timestamp>1e3*60*60*24*1&&Reflect.deleteProperty(V.value,e)}Me(),!k.isBrowser&&i.value[0].key!=="placeholder"&&i.value.unshift({duration:"00:00",table:[],zoneName:"",key:"placeholder"}),ye("LogLine",e=>{se(e.rawLine)}),ye("PartyChanged",e=>{ie.value=e.party.map(t=>({...t,timestamp:Date.now()}))}),ye("ChangePrimaryPlayer",e=>{_.value=e.charName,C.value=Number(e.charID).toString(16).toUpperCase()})});function Ve(e){const{actionCN:t,amount:o,job:u,keigenns:d,time:b,type:W}=e,R=e.effect==="damage done"?"":`,${ke(e.effect)}`,K=`${b} ${u} ${t} ${o.toLocaleString()}(${ke(W)}) 减伤:${d.length===0&&R===""?"无":d.map(P=>r.statusCN?P.name:P.effect).join(",")+R} HP:${e.currentHp}/${e.maxHp}(${Math.round(e.currentHp/e.maxHp*100)}%)+盾:${Math.round(e.maxHp*+e.shield/100)}(${e.shield}%)`;Je(K)}function Je(e){navigator.clipboard.writeText(e).catch(()=>{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}),Se.modal.message({content:"已复制到剪贴板",status:"success"})}const S=L({target:!1,action:!1}),J=L(),ge=ot({className:"my-menus",body:{options:[]}});it(()=>{var e,t,o,u;(e=ge.body)!=null&&e.options&&oe.value&&(ge.body.options[0]=[{code:"copy",name:"复制详情",prefixIcon:"vxe-icon-copy",className:"my-copy-item"},{code:"clearFilterAction",name:"取消技能筛选",prefixIcon:"vxe-icon-funnel-clear",className:"my-clear-filter",visible:S.value.action,disabled:!1},{code:"filterSelectAction",name:(t=J.value)!=null&&t[F.value]?`只看 ${(o=J.value)==null?void 0:o[F.value]}`:"只看该技能",prefixIcon:"vxe-icon-info-circle",visible:!S.value.action,disabled:!1},{code:"clearFilterTarget",name:"取消玩家筛选",prefixIcon:"vxe-icon-funnel-clear",visible:S.value.target,disabled:!1},{code:"filterSelectTarget",name:(u=J.value)!=null&&u.target?`只看[${J.value.job}] ${J.value.target}`:"只看该玩家",prefixIcon:"vxe-icon-user-fill",visible:!S.value.target,disabled:!1}])});function We(){H.value=!H.value}const Ke=({row:e})=>{const t=oe.value;t&&(t.setCurrentRow(e),J.value=e)},Ue=({menu:e,row:t})=>{const o=oe.value;switch(e.code){case"copy":if(!t){Se.modal.message({content:"未选中有效数据行",status:"error"});return}Ve(t);break;case"clearFilterTarget":o&&(o.clearFilter(o.getColumnByField("target")),S.value.target=!1);break;case"clearFilterAction":o&&(o.clearFilter(o.getColumnByField(F.value)),S.value.action=!1);break;case"filterSelectTarget":if(o){const u=o.getColumnByField("target");if(u){const d=u.filters.find(b=>b.value===t.target);if(!d)return;d.checked=!0,o.updateData().then(()=>{o.scrollToRow(t),S.value.target=!0})}}break;case"filterSelectAction":if(o){const u=o.getColumnByField(F.value);if(u){const d=u.filters.find(b=>b.value===t[F.value]);if(!d)return;d.checked=!0,o.updateData().then(()=>{o.scrollToRow(t),S.value.action=!0})}}break}},ce={clearData:()=>{$.value=0,i.value.length=0,i.value.push({key:Date.now().toString(),zoneName:"测试地区",duration:"00:00",table:[]}),v.value=0,p.friendly={},p.enemy={},le()},fakeData:()=>{i.value[0].table.push({timestamp:1e4,time:i.value[0].table.length.toString(),id:void 0,action:"测试动作",actionCN:"测试动作",source:"测试敌人",target:_.value,targetId:"1234567890",job:"战士",jobIcon:"warrior",jobEnum:0,amount:1e3,keigenns:[{name:"整体盾",count:0,effect:"整体盾",effectId:"D25",source:"芸豆角包子",sourceId:"1011A008",target:"芸豆角包子",targetId:"1011A008",expirationTimestamp:1712757148883,performance:{physics:1,magic:1,darkness:1},fullIcon:"012000/012972",isPov:!1,remainingDuration:"14"},{name:"整体论",count:0,effect:"整体论",effectId:"BBB",source:"芸豆角包子",sourceId:"1011A008",target:"芸豆角包子",targetId:"1011A008",expirationTimestamp:1712757138883,performance:{physics:1,magic:1,darkness:1},fullIcon:"012000/012971",isPov:!1,remainingDuration:"4"},{name:"均衡预后",count:0,effect:"均衡预后",effectId:"A31",source:"芸豆角包子",sourceId:"1011A008",target:"芸豆角包子",targetId:"1011A008",expirationTimestamp:1712757153915,performance:{physics:1,magic:1,darkness:1},fullIcon:"012000/012954",isPov:!1,remainingDuration:"19"}],currentHp:1e3,maxHp:1e3,effect:"damage done",type:"magic",shield:"0",povId:C.value}),le()},fakeLogDamage:()=>{v.value=Date.now(),se(`21|${new Date}|4000044A|万魔殿|829A|尖脚|${C.value}|${_.value}|720203|B0F10000|9F0E|8200000|1B|829A8000|0|0|0|0|0|0|0|0|0|0|155065|155065|10000|10000|||94.62|98.28|0.00|-3.13|44|44|0|10000|||92.00|100.00|0.00|0.00|000010B3|0|1|fd5fa47ff773c3ca`)},fakeLogStatus:()=>{se(`26|${new Date}|59|复仇|15.00|${C.value}|${_.value}|${C.value}|${_.value}|64|129221|129221|b6388ee76760c33b`)}};return(e,t)=>{const o=te("vxe-option"),u=te("vxe-select"),d=te("vxe-button"),b=te("vxe-column"),W=yt,R=ht,K=Tt,P=te("vxe-table");return w(),D(he,null,[ae("div",{class:"wrapper",style:N},[s(r).showHeader?(w(),D("header",Et,[De(g(u,{modelValue:s($),"onUpdate:modelValue":t[0]||(t[0]=f=>st($)?$.value=f:null),size:"mini",class:"select"},{default:E(()=>[(w(!0),D(he,null,Fe(s(i).length,f=>(w(),ct(o,{key:`${s(i)[f-1].key}-${s(i)[f-1].duration}-${s(i)[f-1].zoneName}`,value:f-1,label:`${s(i)[f-1].duration} ${s(i)[f-1].zoneName}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue"]),[[Ae,!s(H)]]),g(d,{class:"minimize",icon:s(H)?"vxe-icon-fullscreen":"vxe-icon-minimize",style:lt({opacity:s(H)?.5:1}),onClick:We},null,8,["icon","style"])])):be("",!0),De(ae("main",null,[g(P,{ref_key:"xTable",ref:oe,size:"mini",class:"vxe-table","show-overflow":"tooltip",round:"",height:"100%","scroll-y":{enabled:!0},loading:s(Q),"show-header":s(r).showHeader,data:s(i)[s($)].table,"row-config":{isHover:!0,height:A.line_height},"header-cell-style":{padding:"0px"},"menu-config":s(ge),onCellMenu:Ke,onMenuClick:Ue},{default:E(()=>[g(b,{width:A.time,field:"time",title:"时间",align:"center"},null,8,["width"]),g(b,{width:A.action,field:s(r).actionCN?"actionCN":"action",title:"技能",filters:s(Ge),"filter-multiple":!1,resizable:!1,align:"center"},null,8,["width","field","filters"]),g(b,{width:A.target,field:"target",title:s(r).showName?"目标":"目",filters:s(Oe),"filter-multiple":!1,resizable:!s(r).anonymous&&!s(r).abbrId,align:"left","header-align":"center"},{default:E(({row:f})=>[g(W,{row:f},null,8,["row"])]),_:1},8,["width","title","filters","resizable"]),g(b,{width:A.amount,title:"伤害","header-align":"center"},{default:E(({row:f})=>[g(R,{row:f},null,8,["row"])]),_:1},8,["width"]),g(b,{title:"减伤",align:"left"},{default:E(({row:f})=>[g(K,{row:f},null,8,["row"])]),_:1})]),_:1},8,["loading","show-header","data","row-config","menu-config"])],512),[[Ae,!s(H)]])]),s(k).isBrowser?(w(),D("div",Dt,[s(k).isLocalhost?(w(),D("div",At,[g(d,{class:"test-button",type:"primary",onClick:ce.clearData},{default:E(()=>[de(" 清空 ")]),_:1},8,["onClick"]),g(d,{class:"test-button",type:"primary",onClick:ce.fakeData},{default:E(()=>[de(" 假条目 ")]),_:1},8,["onClick"]),g(d,{class:"test-button",type:"primary",onClick:ce.fakeLogDamage},{default:E(()=>[de(" 假伤害 ")]),_:1},8,["onClick"]),g(d,{class:"test-button",type:"primary",onClick:ce.fakeLogStatus},{default:E(()=>[de(" 假状态 ")]),_:1},8,["onClick"])])):be("",!0),g(mt,{onBeforeHandle:Pe,onAfterHandle:Be,onHandleLine:se})])):be("",!0)],64)}}});export{Gt as default};
