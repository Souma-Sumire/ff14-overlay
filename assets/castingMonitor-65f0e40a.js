import{Q as H,H as O,l as w,d as j,o as u,e as g,F as v,J as T,u as o,c as F,w as y,q as m,t as P,N as x,O as G,a6 as $,aI as z,C as B,D as U,Y as R,s as I,b as J,p as V,v as W,a as _,B as Q,a4 as Y,a5 as q,L as K}from"./vendor-0825ff50.js";import{c as X,a as D}from"./overlay_plugin_api-409cb9ea.js";import{U as b}from"./util-6ab7166a.js";import{s as Z,p as tt,b as et,h as M,c as at}from"./xivapi-d474f14e.js";import{_ as E}from"./_plugin-vue_export-helper-c27b6911.js";const C=new URLSearchParams(window.location.href.split("?")[1]),L=["tank","healer","dps","crafter","gatherer","none"],N=[34563,34564,34565,34566,34567,34568,34569,34570,34571,34572,34573,34574,34575,34576,34577,34578,34579,34580,34581,34582],k=H("castingMonitor",{state:()=>({castData:O({}),playerId:w(""),focusTargetId:w(""),partyData:[],config:{duration:Number(C.get("duration")||25)},lastPush:Date.now()}),getters:{partyDataFormatted(t){return t.partyData.sort((e,s)=>L.indexOf(b.jobToRole(b.jobEnumToJob(e.job)))-L.indexOf(b.jobToRole(b.jobEnumToJob(s.job))))},focusTargetCastArr(t){var e;return((e=t.castData)==null?void 0:e[t.focusTargetId])??[]}},actions:{testAction(){const t=N[Math.floor(Math.random()*N.length)];this.pushAction(Date.now(),15,"青魔技能随机",this.focusTargetId,t)},testParty(t){this.handlePartyChanged({party:t?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0}]:[]})},async pushAction(t,e,s,r,c,h){const d=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(C.get("energySaving")||"");let p=c;if(this.partyData.length===0&&r===this.playerId||d&&r===this.focusTargetId||!d&&this.partyData.length>0&&this.partyData.find(l=>l.id===r)){let l,f=!1;if(s.startsWith("item_"))return;s.startsWith("mount_")?(p=Number.parseInt(s.replace(/^.+_/,""),16),p>983040&&(p=Number.parseInt(p.toString().slice(-5),10),f=!0),l=s.replace(/_.+$/,"")):l="action",this.castData[r]||(this.castData[r]=[]);const i=Symbol("cast");this.castData[r].push({time:t,logLine:e,src:"",class:"",key:i,APIData:{}}),this.lastPush=Date.now();const a=this.castData[r].find(n=>n.key===i);if(!a)return;if(setTimeout(()=>{var n;(n=this.castData[r])==null||n.splice(this.castData[r].indexOf(a),1)},(h||this.config.duration)*1e3),s.startsWith("unknown_"))a.src=`${Z.first}/i/000000/000405.png`,a.class="action action-category-0";else if(p<1e5){const n=await tt(l,p,["ID","Icon","ActionCategoryTargetID","Name","Description"]);if(n.ID===3&&(n.Icon="/i/000000/000104.png"),a.APIData=n,a.src=await et((n==null?void 0:n.Icon)??"",f),l==="action"?a.class=`action action-category-${n==null?void 0:n.ActionCategoryTargetID}`:l==="item"?a.class=`item${f?"HQ":""}`:l==="mount"&&(a.class="mount"),n.ActionCategoryTargetID===2||n.ActionCategoryTargetID===3){const A=this.castData[r].filter(S=>/action-category-[23]/.test(S.class)&&S.logLine!==14).at(-2);A&&(a.GCDCast=((a.time-A.time)/1e3).toFixed(2),Number.parseFloat(a.GCDCast)>=2.55&&(a.GCDClass="wasted"))}}}},handleChangePrimaryPlayer(t){this.playerId=t.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(t){t.line[0]==="20"?this.pushAction(Date.parse(t.line[1]),14,t.line[5],t.line[2],Number.parseInt(t.line[4],16),Number(t.line[8])):(t.line[0]==="21"||t.line[0]==="22"&&t.line[45]==="0")&&this.pushAction(Date.parse(t.line[1]),15,t.line[5],t.line[2],Number.parseInt(t.line[4],16))},handlePartyChanged(t){if(t.party.length>0){this.partyData=t.party.filter(e=>e.inParty).map(e=>({...e,src:""}));for(const e in this.castData)Object.prototype.hasOwnProperty.call(this.castData,e)&&(this.partyData.find(s=>s.id===e)||Reflect.deleteProperty(this.castData,e));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(t){t===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=t,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(C.get("syncFocusWS")||"")&&X({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})}}}),st=t=>(B("data-v-067139b4"),t=t(),U(),t),ot={"w-100vw":"",flex:"~ nowrap",class:"main"},nt=["data-casterId"],rt={class:"elhover"},it=["innerHTML"],lt=["src"],ct=st(()=>m("img",{class:"frame",loading:"lazy"},null,-1)),dt=j({__name:"Main",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),s=k(),r=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(e.get("displayAA")??"")),c=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(e.get("displayGCD")??e.get("displayGCDSpace")??""));return(h,d)=>{const p=z;return u(),g("div",ot,[(u(!0),g(v,null,T(o(s).castData,(l,f)=>(u(),g("div",{key:f,"data-casterId":f},[(u(!0),g(v,null,T(l,i=>(u(),F(p,{key:i.key,"raw-content":"",placement:"right-start",effect:"dark",transition:"",teleported:!1,"popper-class":"el-tooltip","show-arrow":!1,disabled:o(s).focusTargetId!==f},{content:y(()=>{var a;return[m("div",rt,[m("strong",null,P(i.APIData.Name),1),m("div",{style:{"white-space":"pre-line"},innerHTML:(a=i.APIData)==null?void 0:a.Description},null,8,it)])]}),default:y(()=>[m("div",{class:x(`images ${i.class} logLine${i.logLine} displayAA${o(r)} displayGCD${o(c)}`),style:G(`--animeDuration: ${o(s).config.duration}s;opacity:${+(o(s).focusTargetId===f)}`)},[m("img",{src:i.src,class:"action-icon",height:"40",loading:"lazy",onError:d[0]||(d[0]=(...a)=>o(M)&&o(M)(...a))},null,40,lt),ct,o(c)===1?(u(),g("span",{key:0,class:x(["GCDCast",i.GCDClass])},P((i==null?void 0:i.GCDCast)??""),3)):$("",!0)],6)]),_:2},1032,["disabled"]))),128))],8,nt))),128))])}}});const pt=E(dt,[["__scopeId","data-v-067139b4"]]),ut={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},ht=["onClick"],ft={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},gt=["src"],_t=j({__name:"Header",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),s=k();R(()=>{for(const c of s.partyData)c.src=at(c.job)});const r=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(e.get("showHeader")||"false");return(c,h)=>o(r)?(u(),g("div",ut,[(u(!0),g(v,null,T(o(s).partyDataFormatted,(d,p)=>(u(),g("button",{key:p,class:x(["job-lists",o(s).focusTargetId===d.id?"job-lists-focus":""]),"m-0":"","p-0":"",onClick:l=>o(s).handleClickChangeTarget(d.id)},[m("div",ft,[m("img",{src:d.src,style:{height:"1.25em"},loading:"lazy"},null,8,gt),I(" "+P(o(b).nameToFullName(o(b).jobEnumToJob(d.job)).simple2),1)])],10,ht))),128))])):$("",!0)}});const yt={class:"common-layout"},mt={key:0},bt=j({__name:"castingMonitor",setup(t){const e=k(),s=location.href.includes("localhost");J(()=>{D("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),D("LogLine",e.handleLogLine),D("PartyChanged",e.handlePartyChanged),D("BroadcastMessage",c=>{c.source==="castMonitorOverlay"&&(e.focusTargetId=c.msg.targetId)})});const r=w(!1);return setInterval(()=>{r.value=Date.now()-e.lastPush<e.config.duration*2*1e3},1e3),(c,h)=>{const d=_t,p=Q,l=pt,f=Y,i=q,a=K;return V((u(),g("div",yt,[_(i,{"items-center":""},{default:y(()=>[_(p,{class:"header-layout"},{default:y(()=>[_(d)]),_:1}),_(f,{"p-0":""},{default:y(()=>[_(l)]),_:1})]),_:1}),o(s)?(u(),g("footer",mt,[_(a,{onClick:h[0]||(h[0]=n=>o(e).testParty(!0))},{default:y(()=>[I(" 虚假小队 ")]),_:1}),_(a,{onClick:h[1]||(h[1]=n=>o(e).testParty(!1))},{default:y(()=>[I(" 单人 ")]),_:1}),_(a,{onClick:h[2]||(h[2]=n=>o(e).testAction())},{default:y(()=>[I(" Action ")]),_:1})])):$("",!0)],512)),[[W,o(r)]])}}});const Tt=E(bt,[["__scopeId","data-v-6c37ef7b"]]);export{Tt as default};
