import{T as M,d as v,o as p,e as h,F as x,M as k,u as o,Q as A,R as E,x as b,H as L,I as H,Y as O,$ as S,y as w,A as N,b as U,a as _,w as g,G as F,a4 as R,a5 as z,O as B}from"./vendor-6ba522cf.js";import{c as V,a as I}from"./overlay_plugin_api-409cb9ea.js";import{U as f}from"./util-831b56e7.js";import{d as W,s as J,p as Q,b as q,h as D,e as G}from"./xivapi-a5c0f7f0.js";import{_ as T}from"./_plugin-vue_export-helper-c27b6911.js";const C=new URLSearchParams(window.location.href.split("?")[1]),P=["tank","healer","dps","crafter","gatherer","none"],j=[34563,34564,34565,34566,34567,34568,34569,34570,34571,34572,34573,34574,34575,34576,34577,34578,34579,34580,34581,34582],$=M("castingMonitor",{state:()=>({castData:[],playerId:"",focusTargetId:"",partyData:[],config:{duration:Number(C.get("duration")||15)}}),getters:{partyDataFormatted(t){return t.partyData.sort((e,a)=>P.indexOf(f.jobToRole(f.jobEnumToJob(e.job)))-P.indexOf(f.jobToRole(f.jobEnumToJob(a.job))))},focusTargetCastArr(t){return t.castData.filter(e=>e.casterId===t.focusTargetId)}},actions:{testAction(){const t=j[Math.floor(Math.random()*j.length)];this.pushAction(Date.now(),15,"青魔技能随机",this.focusTargetId,t)},testParty(t){this.handlePartyChanged({party:t?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0}]:[]})},async pushAction(t,e,a,r,n,d){if(this.partyData.length===0&&r===this.playerId||this.partyData.length>0&&r===this.focusTargetId){let s=n,c="action",y=!1;if(a.startsWith("item_"))return;a.startsWith("mount_")&&(s=Number.parseInt(a.replace(/^.+_/,""),16),s>983040&&(s=Number.parseInt(s.toString().slice(-5),10),y=!0),c=a.replace(/_.+$/,""));const m=`${t}-${e}-${r}-${n}`,i={casterId:r,time:t,expirationTime:Date.now()+this.config.duration*1e3,logLine:e,src:"",class:"",key:m},u=W.get(s);if(u&&(i.src=`//${u.Host}${u.Icon}`),this.castData.push(i),e===14&&d&&setTimeout(()=>{this.castData=this.castData.filter(l=>l.key!==m)},d*1e3-500),a.startsWith("unknown_"))i.src=`${J.first}/i/000000/000405.png`,i.class="action action-category-0";else if(s<1e5){const l=u||await Q(c,s,["ID","Icon","ActionCategoryTargetID"]);l.ID===3&&(l.Icon="/i/000000/000104.png"),u||(i.src=await q((l==null?void 0:l.Icon)??"",y)),c==="action"?i.class=`action action-category-${l==null?void 0:l.ActionCategoryTargetID}`:c==="mount"&&(i.class="mount")}}},handleChangePrimaryPlayer(t){this.playerId=t.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(t){t.line[0]==="20"?this.pushAction(Date.now(),14,t.line[5],t.line[2],Number.parseInt(t.line[4],16),Number(t.line[8])):(t.line[0]==="21"||t.line[0]==="22"&&t.line[45]==="0")&&this.pushAction(Date.now(),15,t.line[5],t.line[2],Number.parseInt(t.line[4],16))},handlePartyChanged(t){if(t.party.length>0){this.partyData=t.party.filter(e=>e.inParty).map(e=>({...e,src:""}));for(const e in this.castData)Object.prototype.hasOwnProperty.call(this.castData,e)&&(this.partyData.find(a=>a.id===e)||Reflect.deleteProperty(this.castData,e));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(t){t===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=t,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(C.get("syncFocusWS")||"")&&V({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})},cleanUpExpired(){this.castData=this.castData.filter(t=>t.expirationTime>Date.now())}}}),Y=t=>(L("data-v-4ac7a876"),t=t(),H(),t),K={"w-100vw":"",flex:"~ nowrap",class:"main","m-t-1":""},X=["data-casterId"],Z=["src"],tt=Y(()=>b("img",{class:"frame",loading:"lazy"},null,-1)),et=v({__name:"Main",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),a=$(),r=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(e.get("displayAA")??""));return(n,d)=>(p(),h("div",K,[(p(!0),h(x,null,k(o(a).castData,s=>(p(),h("div",{key:s.key,"data-casterId":s.casterId,class:A(`images ${s.class} logLine${s.logLine} displayAA${o(r)}`),style:E(`--animeDuration: ${o(a).config.duration}s;`)},[b("img",{src:s.src,class:"action-icon",height:"40",loading:"lazy",onError:d[0]||(d[0]=(...c)=>o(D)&&o(D)(...c))},null,40,Z),tt],14,X))),128))]))}});const at=T(et,[["__scopeId","data-v-4ac7a876"]]),st={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},ot=["onClick"],nt={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},rt=["src","onerror"],it=v({__name:"Header",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),a=$();O(()=>{for(const n of a.partyData)n.src=G(n.job)});const r=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(e.get("showHeader")||"true");return(n,d)=>o(r)&&o(a).partyData.length>1?(p(),h("div",st,[(p(!0),h(x,null,k(o(a).partyDataFormatted,(s,c)=>(p(),h("button",{key:c,class:A(["job-lists",o(a).focusTargetId===s.id?"job-lists-focus":""]),"m-0":"","p-0":"",onClick:y=>o(a).handleClickChangeTarget(s.id)},[b("div",nt,[b("img",{src:s.src,style:{height:"1.25em"},loading:"lazy",onerror:o(D)},null,8,rt),w(" "+N(o(f).nameToFullName(o(f).jobEnumToJob(s.job)).simple2),1)])],10,ot))),128))])):S("",!0)}});const ct=T(it,[["__scopeId","data-v-427ac828"]]),lt={class:"common-layout"},dt={key:0},ut=v({__name:"castingMonitor",setup(t){const e=$(),a=location.href.includes("localhost");return U(()=>{I("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),I("LogLine",e.handleLogLine),I("PartyChanged",e.handlePartyChanged),I("BroadcastMessage",r=>{r.source==="castMonitorOverlay"&&(e.focusTargetId=r.msg.targetId)})}),setInterval(()=>{e.cleanUpExpired()},1e3),(r,n)=>{const d=ct,s=F,c=at,y=R,m=z,i=B;return p(),h("div",lt,[_(m,{"items-center":""},{default:g(()=>[_(s,{class:"header-layout"},{default:g(()=>[_(d)]),_:1}),_(y,null,{default:g(()=>[_(c)]),_:1})]),_:1}),o(a)?(p(),h("footer",dt,[_(i,{onClick:n[0]||(n[0]=u=>o(e).testParty(!0))},{default:g(()=>[w(" 虚假小队 ")]),_:1}),_(i,{onClick:n[1]||(n[1]=u=>o(e).testParty(!1))},{default:g(()=>[w(" 单人 ")]),_:1}),_(i,{onClick:n[2]||(n[2]=u=>o(e).testAction())},{default:g(()=>[w(" Action ")]),_:1})])):S("",!0)])}}});const yt=T(ut,[["__scopeId","data-v-7a87f66d"]]);export{yt as default};
