import{d as Z,J as H,n as S,q as K,p as M,b as Q,ah as A,o as c,e as u,u as a,F as W,L as X,$ as f,a as Y,y as x,T as ee,U as $}from"./vendor-67b87c3f.js";import{u as te,p as ne,_ as oe}from"./TimelineShow-239c7f48.js";import{a as b,c as D}from"./overlay_plugin_api-409cb9ea.js";import{_ as ie}from"./_plugin-vue_export-helper-c27b6911.js";import"./util-831b56e7.js";import"./xivapi-a5c0f7f0.js";const ae={id:"wrapper"},le={key:0,class:"optionalTimelines"},se=["onClick"],re={key:6,style:{color:"white","background-color":"black"}},ce=Z({__name:"timeline",setup(ue){const o=te(),s=H({loadedTimeline:[],optionalTimeline:[]}),g=S(0),r=S(0-o.configValues.preBattle),C=S(0);let y=!1;const T=K("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),I=new URLSearchParams(location.hash.split("?")[1]),p=S(window.location.href.match(/localhost/)||I.get("dev")==="1"),E=M(()=>s.loadedTimeline.filter(e=>e.sync)),k=M(()=>s.loadedTimeline.filter(e=>e.tts));Q(()=>{R()});function w(){v(),s.loadedTimeline.length=0,s.optionalTimeline.length=0;const e=o.getTimeline(T.value);e.length===1?B(e[0]):e.length>1&&(s.optionalTimeline=e)}function N(e){B(e)}async function B(e,t=!0){t&&v(),y=!1,e!=null&&e.timeline&&(s.loadedTimeline=await ne(e.timeline),s.loadedTimeline.sort((i,n)=>i.time-n.time),A.fire({position:"top-end",icon:"success",text:`加载了${e.name}`,showConfirmButton:!1,timer:1e3,backdrop:!1})),setTimeout(()=>{y=!0},1e3)}function v(){g.value=0,r.value=0-o.configValues.preBattle,C.value=0;for(const e of s.loadedTimeline)e.alertAlready=!1;for(const e of E.value)e.syncAlready=!1}function h(e,t=!0){t&&(y=!1,setTimeout(()=>{y=!0},1e3)),r.value=0,C.value=0,g.value=new Date().getTime()+e*1e3,k.value.forEach(i=>{i.alertAlready=!1}),L()}function L(){if(g.value===0)return;r.value=(new Date().getTime()-g.value+C.value)/1e3;const e=k.value.find(t=>!t.alertAlready&&t.time-o.configValues.ttsAdvance<=r.value);e&&(e.alertAlready=!0,e.tts&&V(e.tts)),requestAnimationFrame(L)}function O(e){var t,i,n;for(const m of e.detail.logs){const _=m.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(_)h(Number.parseInt(((t=_==null?void 0:_.groups)==null?void 0:t.cd)||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(m)||/^.{14} ChatLog 00:0038::end$/.test(m)||/^.{14} SystemLogMessage 29:.{8}:B1C:/.test(m))v();else{const d=E.value.find(l=>l.sync&&(l.syncOnce&&!l.syncAlready||!l.syncOnce)&&r.value>=l.time-l.windowBefore&&r.value<=l.time+Number(l.windowAfter)&&l.sync.test(m));d&&(d.syncAlready=!0,j(d.jump||d.time))}if(/^.{14} ChatLog 00:0038::/.test(m)){const d=(n=(i=m.match(/^.{14} ChatLog 00:0038::(?<name>.+)$/))==null?void 0:i.groups)==null?void 0:n.name;if(d){const l=o.getTimeline(T.value).find(U=>U.name===d);l&&B(l,!1)}}}}function P(e){j(e)}function j(e){g.value===0&&h(0,!1),C.value+=(e-r.value)*1e3,k.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}const F=e=>{T.value.jobs[0]=e.detail.job,e.detail.job!==T.value.jobs[0]&&w()},z=e=>{T.value.zoneId=String(e.zoneID),w()};function V(e,t=!1){e&&(y||t)&&D({call:"cactbotSay",text:e})}function q(e,t={}){D({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const G=e=>{if(e.source==="soumaTimelineSettings"){if(e.msg.type==="post"){let t=function(){for(const n of i.allTimelines)n.condition.jobs===void 0&&(n.condition.jobs=[n.condition.job]),Reflect.deleteProperty(n.condition,"job");o.allTimelines=i.allTimelines,o.configValues=i.configValues,o.showStyle=i.showStyle,o.saveTimelineSettings(),$.closeAll(),$({message:"已更新数据",type:"success",duration:0,showClose:!0}),w()};const i=e.msg.data;i.allTimelines.length<o.allTimelines.length-1?ee.confirm(i.allTimelines.length===0?"传入数据为空. 确定要清空数据吗?":"你删除了2条以上的时间轴. 确定吗?","警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{t()}).catch(()=>{$({type:"info",message:"操作已取消"})}):t()}e.msg.type==="get"&&q("post",o.$state)}};function J(e){e.detail.inGameCombat&&e.detail.inACTCombat&&g.value===0?h(0):!e.detail.inGameCombat&&!e.detail.inACTCombat&&v()}function R(){b("onLogEvent",O),b("onPlayerChangedEvent",F),b("ChangeZone",z),b("BroadcastMessage",G),b("onInCombatChangedEvent",J),o.loadTimelineSettings(),A.isVisible()||A.fire({text:`${o.allTimelines.length}条时间轴已就绪`,showConfirmButton:!1,timer:1500,backdrop:!1}),w()}return(e,t)=>{const i=oe;return c(),u("div",ae,[a(s).optionalTimeline.length&&a(r)<=-a(o).configValues.preBattle?(c(),u("ul",le,[(c(!0),u(W,null,X(a(s).optionalTimeline,(n,m)=>(c(),u("li",{key:m,onClick:_=>N(n)},x(n.name),9,se))),128))])):f("",!0),Y(i,{config:a(o).configValues,lines:a(s).loadedTimeline,runtime:a(r),"show-style":a(o).showStyle},null,8,["config","lines","runtime","show-style"]),a(p)?(c(),u("button",{key:1,onClick:t[0]||(t[0]=n=>h(30))}," 开始从-30 ")):f("",!0),a(p)?(c(),u("button",{key:2,onClick:t[1]||(t[1]=n=>h(0))}," 开始从0 ")):f("",!0),a(p)?(c(),u("button",{key:3,onClick:t[2]||(t[2]=n=>v())}," 团灭 ")):f("",!0),a(p)?(c(),u("button",{key:4,onClick:t[3]||(t[3]=n=>P(1e3))}," 跳转1000测试 ")):f("",!0),a(p)?(c(),u("button",{key:5,onClick:t[4]||(t[4]=n=>V("今天天气真不错",!0))}," TTS测试 ")):f("",!0),a(p)?(c(),u("span",re,x(a(r)),1)):f("",!0)])}}});const Te=ie(ce,[["__scopeId","data-v-2b937d7d"]]);export{Te as default};
