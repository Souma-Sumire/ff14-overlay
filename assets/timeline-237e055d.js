import{d as R,J as K,n as k,q as Q,p as M,b as W,ai as E,o as r,e as u,u as a,F as X,L as Y,a0 as g,a as ee,y as L,T as D,U as S}from"./vendor-688a9a69.js";import{u as te,p as ne,_ as ae}from"./TimelineShow-28dd63e2.js";import{a as b,c as I}from"./overlay_plugin_api-409cb9ea.js";import{_ as ie}from"./_plugin-vue_export-helper-c27b6911.js";import"./util-831b56e7.js";import"./xivapi-a5c0f7f0.js";const oe={id:"wrapper"},le={key:0,class:"optionalTimelines"},se=["onClick"],ce={key:6,style:{color:"white","background-color":"black"}},re=R({__name:"timeline",setup(ue){const n=te(),s=K({loadedTimeline:[],optionalTimeline:[]}),p=k(0),c=k(0-n.configValues.preBattle),C=k(0);let T=!1;const m=Q("timeline-condition",{zoneId:"0",job:"NONE"}),N=new URLSearchParams(location.hash.split("?")[1]),y=k(window.location.href.match(/localhost/)||N.get("dev")==="1"),$=M(()=>s.loadedTimeline.filter(e=>e.sync)),B=M(()=>s.loadedTimeline.filter(e=>e.tts));W(()=>{Z()});function w(e){v(),s.loadedTimeline.length=0,s.optionalTimeline.length=0;const t=n.getTimeline(e);t.length===1?A(t[0]):t.length>1&&(s.optionalTimeline=t)}function O(e){A(e)}async function A(e,t=!0){t&&v(),T=!1,e!=null&&e.timeline&&(s.loadedTimeline=await ne(e.timeline),s.loadedTimeline.sort((i,o)=>i.time-o.time),E.fire({position:"top-end",icon:"success",text:`加载了${e.name}`,showConfirmButton:!1,timer:1e3,backdrop:!1})),setTimeout(()=>{T=!0},1e3)}function v(){p.value=0,c.value=0-n.configValues.preBattle,C.value=0;for(const e of s.loadedTimeline)e.alertAlready=!1;for(const e of $.value)e.syncAlready=!1}function h(e,t=!0){t&&(T=!1,setTimeout(()=>{T=!0},1e3)),c.value=0,C.value=0,p.value=new Date().getTime()+e*1e3,B.value.forEach(i=>{i.alertAlready=!1}),x()}function x(){if(p.value===0)return;c.value=(new Date().getTime()-p.value+C.value)/1e3;const e=B.value.find(t=>!t.alertAlready&&t.time-n.configValues.ttsAdvance<=c.value);e&&(e.alertAlready=!0,e.tts&&j(e.tts)),requestAnimationFrame(x)}function F(e){var t,i,o;for(const d of e.detail.logs){const _=d.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(_)h(Number.parseInt(((t=_==null?void 0:_.groups)==null?void 0:t.cd)||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(d)||/^.{14} ChatLog 00:0038::end$/.test(d)||/^.{14} SystemLogMessage 29:.{8}:B1C:/.test(d))v();else{const f=$.value.find(l=>l.sync&&(l.syncOnce&&!l.syncAlready||!l.syncOnce)&&c.value>=l.time-l.windowBefore&&c.value<=l.time+Number(l.windowAfter)&&l.sync.test(d));f&&(f.syncAlready=!0,V(f.jump||f.time))}if(/^.{14} ChatLog 00:0038::/.test(d)){const f=(o=(i=d.match(/^.{14} ChatLog 00:0038::(?<name>.+)$/))==null?void 0:i.groups)==null?void 0:o.name;if(f){const l=n.getTimeline(m.value).find(H=>H.name===f);l&&A(l,!1)}}}}function P(e){V(e)}function V(e){p.value===0&&h(0,!1),C.value+=(e-c.value)*1e3,B.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}const z=e=>{e.detail.job!==m.value.job?(m.value.job=e.detail.job,w(m.value)):m.value.job=e.detail.job},q=e=>{m.value.zoneId=String(e.zoneID),w(m.value)};function j(e,t=!1){e&&(T||t)&&I({call:"cactbotSay",text:e})}function G(e,t={}){I({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const J=e=>{if(e.source==="soumaTimelineSettings"){if(e.msg.type==="post"){let t=function(){n.allTimelines=i.allTimelines,n.configValues=i.configValues,n.showStyle=i.showStyle,n.saveTimelineSettings(),S.closeAll(),S({message:"已更新数据",type:"success",duration:0,showClose:!0}),w(m.value)};const i=e.msg.data;i.allTimelines.length===0&&n.allTimelines.length>1?D.confirm("传入数据为空. 确定要清空数据吗?","警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{t()}).catch(()=>{S({type:"info",message:"操作已取消"})}):i.allTimelines.length<n.allTimelines.length-1?D.confirm("传入数据比当前数据少2条以上. 确定要接受吗?","警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{t()}).catch(()=>{S({type:"info",message:"操作已取消"})}):t()}e.msg.type==="get"&&G("post",n.$state)}};function U(e){e.detail.inGameCombat&&e.detail.inACTCombat&&p.value===0?h(0):!e.detail.inGameCombat&&!e.detail.inACTCombat&&v()}function Z(){b("onLogEvent",F),b("onPlayerChangedEvent",z),b("ChangeZone",q),b("BroadcastMessage",J),b("onInCombatChangedEvent",U),n.loadTimelineSettings(),E.isVisible()||E.fire({text:`${n.allTimelines.length}条时间轴已就绪`,showConfirmButton:!1,timer:1500,backdrop:!1}),w(m.value)}return(e,t)=>{const i=ae;return r(),u("div",oe,[a(s).optionalTimeline.length&&a(c)<=-a(n).configValues.preBattle?(r(),u("ul",le,[(r(!0),u(X,null,Y(a(s).optionalTimeline,(o,d)=>(r(),u("li",{key:d,onClick:_=>O(o)},L(o.condition.job)+" - "+L(o.name),9,se))),128))])):g("",!0),ee(i,{config:a(n).configValues,lines:a(s).loadedTimeline,runtime:a(c),"show-style":a(n).showStyle},null,8,["config","lines","runtime","show-style"]),a(y)?(r(),u("button",{key:1,onClick:t[0]||(t[0]=o=>h(30))}," 开始从-30 ")):g("",!0),a(y)?(r(),u("button",{key:2,onClick:t[1]||(t[1]=o=>h(0))}," 开始从0 ")):g("",!0),a(y)?(r(),u("button",{key:3,onClick:t[2]||(t[2]=o=>v())}," 团灭 ")):g("",!0),a(y)?(r(),u("button",{key:4,onClick:t[3]||(t[3]=o=>P(1e3))}," 跳转1000测试 ")):g("",!0),a(y)?(r(),u("button",{key:5,onClick:t[4]||(t[4]=o=>j("今天天气真不错",!0))}," TTS测试 ")):g("",!0),a(y)?(r(),u("span",ce,L(a(c)),1)):g("",!0)])}}});const Te=ie(re,[["__scopeId","data-v-55c55108"]]);export{Te as default};
