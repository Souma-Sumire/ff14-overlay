import{U as p}from"./util-ef9ccf87.js";const h=new URLSearchParams(window.location.href.split("?")[1]),c=h.get("api"),a={cafe:"https://cafemaker.wakingsands.com",xivapi:"https://xivapi.com"},s={first:(c==null?void 0:c.toLowerCase())==="xivapi"?a.xivapi:a.cafe,second:(c==null?void 0:c.toLowerCase())==="xivapi"?a.cafe:a.xivapi},w={get random(){return Math.floor(Math.random()*864e5*11)+864e5*25}},I=new Map(Object.entries({任务指令:"/i/000000/000123.png",冲刺:"/i/000000/000104.png",坐骑:"/i/000000/000118.png",攻击:"/i/000000/000101.png",腐秽大地:"/i/003000/003090.png"})),u="souma-action-cache",l=JSON.parse(localStorage.getItem(u)||"[]"),y=Date.now(),A=1e3,C=l.filter((e,t)=>e.expirationTime>=y&&t<A);localStorage.setItem(u,JSON.stringify(C));const $=/(\d{6})\/(\d{6})\.png$/;async function T(e,t,o=["ID","Icon","ActionCategoryTargetID"]){const r=D(e,t,o);try{return await(await f(r,{mode:"cors"})).json()}catch(n){return console.error(`Failed to parse action: ${n}`),{ActionCategoryTargetID:0,ID:t,Icon:"/i/000000/000405.png"}}}function D(e,t,o){const r=`${s.first}/${e}/${t}?columns=${o.join(",")}`;return[r,r.replace(s.first,s.second)]}async function x(e,t=!1){return`${s.first}${e}`.replace($,(r,n,i)=>`${n}/${t?"hq/":""}${i}.png`)}function S(e){const t=p.jobEnumToJob(e),o=p.nameToFullName(t);return`${s.first}/cj/companion/${o.en.toLowerCase().replaceAll(/\s/g,"")}.png`}async function b(e){const t=await T("action",e,["Icon"]);return x(t.Icon)}async function j(e){var r;const t=I.get(e);if(t)return{ActionCategoryTargetID:0,ID:0,Icon:t};const o=l.find(n=>n.name===e);if(o!=null&&o.action)return o.action;try{const m=(r=(await(await f([`${a.cafe}/search?filters=ClassJobLevel>0&indexes=action&string=${encodeURIComponent(e)}`])).json()).Results)==null?void 0:r[0];if(m){const g=Date.now()+w.random,d={name:e,action:m,expirationTime:g};return l.push(d),localStorage.setItem(u,JSON.stringify(l)),m}return{ActionCategoryTargetID:0,ID:0,Icon:"/i/000000/000405.png"}}catch(n){throw console.error(`Failed to get action by name: ${n}`),new Error("Failed to retrieve action data")}}async function E(e,t){let o;const r=new Promise((n,i)=>{o=setTimeout(()=>{i(new Error("Promise timed out"))},t)});return Promise.race([e,r]).finally(()=>{clearTimeout(o)})}async function f(e,t){const o=Object.assign({cache:"force-cache"},t);for(const r of e)try{const n=await E(fetch(r,o),3e3);if(n.ok)return n}catch(n){console.error(`Failed to fetch ${r}: ${n}`)}throw new Error("All fetch attempts failed.")}function N(e){const t=e.target;t.src.includes("cafemaker.wakingsands.com")?t.src=t.src.replace("cafemaker.wakingsands.com","xivapi.com"):t.src.includes("xivapi.com")&&(t.src="")}export{x as a,S as b,b as c,j as g,N as h,T as p};
