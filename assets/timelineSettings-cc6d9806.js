import{d as we,n as z,J as ke,o as I,e as G,a as t,w as l,u as i,a0 as W,x as F,y as Q,t as y,s as ge,v as ye,F as X,L as te,ah as E,ai as pe,B as Ne,aj as Be,C as Ye,N as Ae,ak as Oe,ae as De,af as Ue,ad as be,a1 as je,al as he,c as q,ac as ze,Y as et,p as Pe,am as Je,an as tt,G as Me,H as qe,A as nt,Z as Ve,b as lt,X as it,$ as fe,ao as re,U as j,T as ee,ap as Ee,aq as ot,ar as st,a3 as at,a2 as rt,D as ct,ag as dt,as as ut,a4 as mt,a5 as pt}from"./vendor-67b87c3f.js";import{u as ve,_ as Re,p as ft}from"./TimelineShow-239c7f48.js";import{U as Z}from"./util-831b56e7.js";import{g as _t}from"./actionChinese-f29d4188.js";import{g as gt,h as yt}from"./xivapi-a5c0f7f0.js";import{_ as Te}from"./_plugin-vue_export-helper-c27b6911.js";import{a as wt,c as bt}from"./overlay_plugin_api-409cb9ea.js";import{z as _e}from"./zoneInfo-9e4e9a78.js";import{r as ht}from"./index-07c9d3dd.js";import{u as vt,c as Ie}from"./useWebSocket-fd029fe2.js";import"./actWS-e2500b62.js";const r=new Map;r.set(26155,{type:"cast",window:[999,999]});r.set(28027,{type:"cast",window:[999,999]});r.set(26340,{type:"cast",window:[999,999]});r.set(25533,{type:"begincast",window:[60,60]});r.set(26376,{type:"cast",window:[999,999]});r.set(26814,{type:"begincast",window:[999,999]});r.set(25313,{type:"begincast",window:[200,200]});r.set(27526,{type:"begincast",window:[999,999]});r.set(26215,{type:"cast",window:[500,30]});r.set(29050,{type:"begincast",window:[200,30]});r.set(29156,{type:"cast",window:[20,20]});r.set(27973,{type:"cast",window:[20,20]});r.set(27937,{type:"begincast",window:[20,20]});r.set(28059,{type:"begincast",window:[20,20]});r.set(28060,{type:"begincast",window:[20,20]});r.set(28061,{type:"begincast",window:[20,20]});r.set(27956,{type:"begincast",window:[20,20]});r.set(27957,{type:"begincast",window:[20,20]});r.set(27952,{type:"begincast",window:[30,30]});r.set(27969,{type:"begincast",window:[20,20]});r.set(27971,{type:"begincast",window:[20,20]});r.set(27939,{type:"begincast",window:[20,20]});r.set(27966,{type:"begincast",window:[20,20]});r.set(25316,{type:"begincast",window:[999,999]});r.set(25544,{type:"begincast",window:[10,10]});r.set(26379,{type:"begincast",window:[10,10]});r.set(31552,{type:"begincast",window:[30,30]});r.set(31573,{type:"begincast",window:[30,30]});r.set(31573,{type:"begincast",window:[30,30]});r.set(31617,{type:"begincast",window:[8,8]});r.set(31624,{type:"begincast",window:[30,30]});r.set(31649,{type:"begincast",window:[30,30]});r.set(18864,{type:"cast",window:[10,2.5],once:!0});r.set(18480,{type:"cast",window:[200,60],once:!0});r.set(18516,{type:"cast",window:[250,65],once:!0});r.set(18522,{type:"begincast",window:[500,500],once:!0});r.set(18552,{type:"begincast",window:[67,67],once:!0});r.set(18553,{type:"cast",window:[67,67],once:!0});r.set(19083,{type:"cast",window:[900,0],once:!0});function Tt(S){const D=new Map;S.filter(g=>g.type==="begincast").map(g=>D.set(g.actionId,(D.get(g.actionId)??0)+1));for(const g of S){D.get(g.actionId)===1&&g.type==="begincast"&&(g.window=[12,12]);const s=r.get(g.actionId);(s==null?void 0:s.type)===g.type&&(g.window=s==null?void 0:s.window),g.syncOnce=!!(s!=null&&s.once)}return S}const Ft={class:"fflogs-query-result-friendlies"},xt=["src","onerror"],Ct=we({__name:"FflogsImport",props:{filters:{}},emits:["newTimeline","showFFlogsToggle","clearCurrentlyTimeline","updateFilters"],setup(S,{emit:D}){const g=S,s=D,T=new RegExp("(?<=^|\\/)(?<code>\\w{16,})\\/?#fight=(?<fight>\\d+|last)"),R={begincast:"14",cast:"1[56]"},C=z("查询"),N=z(""),B=z(!1),e=ke({});K();const k=ve();function L($){var w;E.fire({text:"正在解析数据 (步骤1/3)",showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1}),K(),C.value="正在请求";const c=$.match(T);k.settings.api?c?c?(e.code=((w=c.groups)==null?void 0:w.code)??"",pe.get(`https://cn.fflogs.com/v1/report/fights/${e.code}?api_key=${k.settings.api}`).then(m=>{var v,x;e.bossIDs=m.data.enemies.filter(a=>a.type==="Boss").map(a=>a.id),e.fightIndex=(((v=c==null?void 0:c.groups)==null?void 0:v.fight)==="last"?m.data.fights.length:Number.parseInt(((x=c==null?void 0:c.groups)==null?void 0:x.fight)??"0"))-1;const u=m.data.fights[e.fightIndex];e.zoneID=u.zoneID,e.start=u.start_time,e.end=u.end_time,e.friendlies=m.data.friendlies.filter(a=>a.icon!=="LimitBreak"&&a.fights.find(H=>H.id===e.fightIndex+1)),C.value="查询",e.abilityFilterEvents.length=0,e.abilityFilterCandidate.length=0,E.fire("在列表中选择一名玩家")}).catch(m=>{E.fire({icon:"error",title:"Oops...(步骤1)",text:m}),C.value="查询"})):(E.fire({icon:"error",title:"url链接格式错误",footer:`验证规则：${T.toString().replaceAll(/\?<\w+>/g,"")}`}),C.value="查询"):(E.fire({icon:"error",title:"FF logs 战斗记录链接 未填写",footer:"例如：aaAAAAaAAAaAaa11#fight=18"}),C.value="查询"):(E.fire({icon:"error",title:"FF logs API Key 未填写",footer:'<a href="https://cn.fflogs.com/profile">点击这里，在最下方起名，然后获得你的 V1客户端密钥</a>'}),C.value="查询")}async function P($){e.player=$,await U().then(()=>{e.abilityFilterCandidate=e.abilityFilterEvents.reduce((c,w)=>(w.sourceIsFriendly&&!c.find(m=>m.actionId===w.actionId)&&c.push(w),c),[])}).catch(c=>{E.fire({icon:"error",title:"Oops...(步骤2)",text:c})})}async function U(){E.fire({text:"正在解析数据，请耐心等待。(步骤2/3)",showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1});const $=[];e.abilityFilterEvents.length=0;async function c(v){var x;await pe.get(`https://cn.fflogs.com/v1/report/events/casts/${e.code}?start=${v}&end=${e.end}&hostility=0&sourceid=${(x=e.player)==null?void 0:x.id}&api_key=${k.settings.api}`).then(async a=>{$.push(...a.data.events),a.data.nextPageTimestamp&&a.data.nextPageTimestamp>0&&a.data.nextPageTimestamp<e.end&&await c(a.data.nextPageTimestamp)}).catch(a=>{E.fire({icon:"error",title:"Oops...(步骤3.1)",text:a})})}async function w(v,x){x>=0&&await pe.get(`https://cn.fflogs.com/v1/report/events/casts/${e.code}?start=${v}&end=${e.end}&hostility=1&sourceid=${e.bossIDs[x]}&api_key=${k.settings.api}`).then(async a=>{$.push(...a.data.events),a.data.nextPageTimestamp&&a.data.nextPageTimestamp>0&&a.data.nextPageTimestamp<e.end&&await w(a.data.nextPageTimestamp,x),x<e.bossIDs.length-1&&await w(v,x+1)}).catch(a=>{E.fire({icon:"error",title:"Oops...(步骤3.2)",text:a})})}const m=await c(e.start),u=await w(e.start,0);await Promise.all([m,u]).then(()=>{var v,x;for(const a of $)a.type==="begincast"&&a.sourceIsFriendly||e.abilityFilterEvents.push({time:Number(((a.timestamp-e.start)/1e3).toFixed(1)),type:a.type,actionName:_t(a.ability.guid)??a.ability.name,actionId:a.ability.guid,sourceIsFriendly:a.sourceIsFriendly,url:((v=a==null?void 0:a.ability)==null?void 0:v.abilityIcon.replace("-","/").replace(".png",""))??"000000/000405",window:void 0});(x=e.player)!=null&&x.icon&&g.filters[e.player.icon]&&(e.abilityFilterSelected=g.filters[e.player.icon]),E.fire("请在技能过滤器中选择需要的技能")})}function Y(){var $,c,w,m;E.fire({text:"正在解析数据 (步骤3/3)",showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1}),($=e.player)!=null&&$.icon&&s("updateFilters",(c=e.player)==null?void 0:c.icon,JSON.parse(JSON.stringify(e.abilityFilterSelected))),e.abilityFilterEvents=e.abilityFilterEvents.filter(u=>u.sourceIsFriendly&&e.abilityFilterSelected.includes(u.actionId)||!u.sourceIsFriendly).sort((u,v)=>u.time-v.time),e.abilityFilterEvents=Tt(e.abilityFilterEvents),e.abilityFilterEventsAfterFilterRawTimeline=e.abilityFilterEvents.map(u=>u.sourceIsFriendly?`${u.time} "<${u.actionName}>~"${B.value?` tts "${u.actionName}"`:""}`:/^(?:攻击|attack|攻撃)$|^unknown/i.test(u.actionName)||u.type==="cast"&&u.window===void 0?`# ${u.time} "${u.actionName}"`:`${u.time} "${u.actionName}" sync /^.{14} \\w+ ${R[u.type]}:4.{7}:[^:]+:${u.actionId.toString(16).toUpperCase()}:/${u.window?` window ${u.window.join(",")}`:""}`).join(`
`),s("newTimeline",`导入${(w=e.player)==null?void 0:w.name}`,{zoneId:e.zoneID.toString(),jobs:[((m=e.player)==null?void 0:m.icon)??"NONE"]},e.abilityFilterEventsAfterFilterRawTimeline,`${e.code}#fight=${e.fightIndex+1}`),K(),s("showFFlogsToggle"),E.fire({position:"top-end",icon:"success",title:"已生成新时间轴",showConfirmButton:!1,timer:1500})}function K(){e.code="",e.fightIndex=0,e.start=0,e.end=0,e.friendlies=[],e.abilityFilterEvents=[],e.abilityFilterCandidate=[],e.abilityFilterSelected=[],e.abilityFilterEventsAfterFilterRawTimeline="",e.player=void 0,e.zoneID=0,e.bossIDs=[]}return($,c)=>{const w=Ne,m=Be,u=Ye,v=Ae,x=Oe,a=De,H=Ue,ne=be,le=ze,de=je,ie=he;return I(),G(X,null,[t(x,{inline:!0,class:"fflogs-query"},{default:l(()=>[t(m,{label:"FF logs 战斗",style:{width:"450px"}},{default:l(()=>[t(w,{modelValue:i(N),"onUpdate:modelValue":c[0]||(c[0]=h=>W(N)?N.value=h:null),placeholder:"reports/AAAaAaAAaa1aA1aA#fight=3",autocomplete:"on"},null,8,["modelValue"])]),_:1}),t(m,{label:"FF logs V1 Key",style:{width:"450px"}},{default:l(()=>[t(w,{modelValue:i(k).settings.api,"onUpdate:modelValue":c[1]||(c[1]=h=>i(k).settings.api=h)},null,8,["modelValue"])]),_:1}),t(m,{label:"添加TTS",style:{width:"100px"}},{default:l(()=>[t(u,{modelValue:i(B),"onUpdate:modelValue":c[2]||(c[2]=h=>W(B)?B.value=h:null)},null,8,["modelValue"])]),_:1}),t(m,null,{default:l(()=>[t(v,{disabled:i(C)==="正在请求",type:"primary",onClick:c[3]||(c[3]=h=>L(i(N)))},{default:l(()=>[F(Q(i(C)),1)]),_:1},8,["disabled"])]),_:1})]),_:1}),y("div",Ft,[t(ne,null,{default:l(()=>[ge(t(H,{data:i(e).friendlies.filter(h=>h.icon!=="NPC"),stripe:"",border:"",class:"fflogs-query-result-friendlies-list"},{default:l(()=>[t(a,{prop:"name",label:"玩家名称","min-width":"60px"}),t(a,{prop:"server",label:"服务器","min-width":"60px"}),t(a,{label:"职业","min-width":"60px"},{default:l(({row:h})=>[F(Q(i(Z).nameToFullName(i(Z).jobEnumToJob(i(Z).iconToJobEnum(h.icon))).cn),1)]),_:1}),t(a,{label:"选定","min-width":"20px"},{default:l(h=>[t(v,{type:"primary",size:"small",onClick:Fe=>P(h.row)},{default:l(()=>[F(" 选择 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),[[ye,i(e).abilityFilterEvents.length===0]])]),_:1}),ge(t(ne,{class:"fflogs-query-result-friendlies-ability-filter-select"},{default:l(()=>[t(ie,{span:20},{default:l(()=>[t(de,{modelValue:i(e).abilityFilterSelected,"onUpdate:modelValue":c[4]||(c[4]=h=>i(e).abilityFilterSelected=h),multiple:"",placeholder:"技能过滤器","fit-input-width":!0},{default:l(()=>[(I(!0),G(X,null,te(i(e).abilityFilterCandidate,h=>(I(),q(le,{key:h.actionId,class:"ability-filter-li",value:h.actionId,label:h.actionName},{default:l(()=>[y("img",{src:i(gt)(`/i/${h.url}.png`),class:"ability-filter-li-icon",title:"",onerror:i(yt)},null,8,xt),F(Q(h.actionName),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(ie,{span:4},{default:l(()=>[t(v,{type:"success",onClick:c[5]||(c[5]=h=>Y())},{default:l(()=>[F(" 选择好了 ")]),_:1})]),_:1})]),_:1},512),[[ye,i(e).abilityFilterEvents.length>0]])])],64)}}});const St=Te(Ct,[["__scopeId","data-v-d050fc91"]]),ce=S=>(Me("data-v-52d0d6b5"),S=S(),qe(),S),$t=ce(()=>y("h3",{style:{margin:"0",padding:"10px","background-color":"#f5f7fa",cursor:"move"}}," 设置 ",-1)),Vt=ce(()=>y("h3",{class:"form-section-title"}," 参数 ",-1)),Et=ce(()=>y("h3",{class:"form-section-title"}," 样式 ",-1)),It=ce(()=>y("h3",{class:"form-section-title"}," 测试用例 ",-1)),kt=we({__name:"SettingsDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(S,{emit:D}){const g=S,s=D,T=ve();et(()=>{T.saveTimelineSettings()});const R=Pe({get:()=>g.modelValue,set:B=>s("update:modelValue",B)}),C=z(-15),N=z([{time:-15,action:"<圣光幕帘>~",show:!0},{time:-2,action:"<圣灵>~",show:!0},{time:0,action:"战斗开始！",show:!0},{time:3,action:"<挑衅>~",show:!0},{time:5,action:"<神圣领域>~",show:!0}]);return(B,e)=>{const k=nt,L=Be,P=he,U=be,Y=Je,K=Re,$=Oe,c=tt;return I(),q(c,{modelValue:i(R),"onUpdate:modelValue":e[1]||(e[1]=w=>W(R)?R.value=w:null),modal:!0,overflow:"","close-on-click-modal":!1,"custom-class":"timeline-dialog",width:"600px","append-to-body":!0,draggable:!0},{header:l(()=>[$t]),default:l(()=>[t($,{"label-position":"right","label-width":"120px",class:"timeline-form"},{default:l(()=>[Vt,t(U,{gutter:20},{default:l(()=>[(I(!0),G(X,null,te(i(T).configValues,(w,m,u)=>(I(),q(P,{key:u,span:12},{default:l(()=>[t(L,{label:i(T).configTranslate[m]},{default:l(()=>[t(k,{modelValue:i(T).configValues[m],"onUpdate:modelValue":v=>i(T).configValues[m]=v,min:0,step:.1,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),Et,t(U,{gutter:20},{default:l(()=>[(I(!0),G(X,null,te(i(T).showStyle,(w,m,u)=>(I(),q(P,{key:u,span:12},{default:l(()=>[t(L,{label:i(T).showStyleTranslate[m]},{default:l(()=>[t(k,{modelValue:i(T).showStyle[m],"onUpdate:modelValue":v=>i(T).showStyle[m]=v,min:0,step:.01,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),It,t(U,{gutter:20},{default:l(()=>[t(Y,{modelValue:i(C),"onUpdate:modelValue":e[0]||(e[0]=w=>W(C)?C.value=w:null),min:-15,max:5,step:.1,"show-input":""},null,8,["modelValue"]),t(K,{config:i(T).configValues,lines:i(N),runtime:i(C),"show-style":i(T).showStyle},null,8,["config","lines","runtime","show-style"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}});const Nt=Te(kt,[["__scopeId","data-v-52d0d6b5"]]),O=S=>(Me("data-v-8af8e002"),S=S(),qe(),S),Bt=O(()=>y("br",null,null,-1)),At=O(()=>y("br",null,null,-1)),Ot={class:"slider-demo-block"},Dt=O(()=>y("span",null,"模拟时间：",-1)),Ut={class:"timeline-info-config"},jt=O(()=>y("span",null,"显示名称：",-1)),zt={class:"timeline-info-config"},Pt=O(()=>y("span",null,"限定地图：",-1)),Jt={class:"timeline-info-config"},Mt=O(()=>y("span",null,"限定职业：",-1)),qt={class:"timeline-info-config"},Rt=O(()=>y("span",null,"战斗来源：",-1)),Lt={class:"timeline-info-config"},Kt=O(()=>y("span",null,"创建时间：",-1)),Ht={style:{flex:"1"}},Qt={style:{"max-height":"353px"}},Zt={class:"timeline-timeline-view"},Gt=O(()=>y("br",null,null,-1)),Wt=O(()=>y("br",null,null,-1)),Xt=we({__name:"timelineSettings",setup(S){const{wsConnected:D}=vt(),g=z(0),s=ve(),T=Ve(s,"allTimelines"),R=Ve(s,"filters"),C=[{id:"0",name:"任意"}],N=z(!1),B=z(!1),e=ke({timeline:{name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}}),k=z([]);let L=null,P=!1;m();async function U(){k.value=[{time:0,action:"正在加载...",show:!0,windowBefore:0,windowAfter:0,alertAlready:!0}],k.value=await ft(e.timeline.timeline)}const Y=[...Z.getBattleJobs3(),"NONE"];K();function K(){var d,n,_;for(const b in _e)if(Object.prototype.hasOwnProperty.call(_e,b)){const p=_e[b];switch(p.contentType){case 4:case 5:case 28:C.push({id:b,name:((d=p.name)==null?void 0:d.cn)??((n=p.name)==null?void 0:n.ja)??((_=p.name)==null?void 0:_.ja)??b})}}a(),s.sortTimelines()}function $(d,n={}){bt({call:"broadcast",source:"soumaTimelineSettings",msg:{type:d,data:n}})}function c(){N.value=!N.value,m()}function w(){const d="https://docs.qq.com/sheet/DTWxKT3lFbmpDV3Fm?tab=5ovrc8";window.open(d,"_blank")}function m(){g.value=-30,e.timeline={name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}}function u(){e.timeline=s.allTimelines[s.newTimeline()],U()}function v(d){window.scrollTo({top:0,behavior:"smooth"}),e.timeline=d,U()}function x(d){E.fire({title:`确定要删除${d.name}吗？`,text:"这将无法撤回！",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"确认删除",cancelButtonText:"取消"}).then(n=>{n.isConfirmed&&(m(),T.value.splice(T.value.findIndex(_=>_===d),1))})}function a(){s.loadTimelineSettings()}function H(d){const n=JSON.stringify(d),_=JSON.parse(n);for(const M of _)M.timeline=M.timeline.replace(/^#.*\n/gm,"");const b=JSON.stringify(_),p=re.compressToBase64(n),f=re.compressToBase64(b),V=p.length,J=f.length;if(V===J){Ie(p).then(()=>{j({message:"数据复制成功，已写入剪切板。",type:"success",duration:2e3})}).catch(()=>{j({message:"复制失败，请手动复制！",type:"error",duration:3e3})});return}const ue=((V-J)/V*100).toFixed(2);ee.confirm(`
     1. 完整版本（包含注释）<br>
     &nbsp;&nbsp;&nbsp;- 大小：${V} 字节<br>
     &nbsp;&nbsp;&nbsp;- 包含所有时间轴信息和注释<br><br>
     2. 优化版本（不含注释）<br>
     &nbsp;&nbsp;&nbsp;- 大小：${J} 字节<br>
     &nbsp;&nbsp;&nbsp;- 节省 ${ue}% 的空间<br>
     &nbsp;&nbsp;&nbsp;- 仅包含必要的时间轴数据`,"请选择导出版本：",{confirmButtonText:"导出优化版本",cancelButtonText:"导出完整版本",distinguishCancelAndClose:!0,closeOnClickModal:!1,closeOnPressEscape:!1,dangerouslyUseHTMLString:!0,showClose:!0,type:"info",callback:M=>{(M==="cancel"||M==="confirm")&&Ie(M==="confirm"?f:p).then(()=>{j({message:"压缩数据复制成功，已写入剪切板。",type:"success",duration:2e3})}).catch(()=>{j({message:"复制失败，请手动复制！",type:"error",duration:3e3})})}})}function ne(){ee.prompt("请输入导出的字符串（支持多行导入）","导入时间轴",{confirmButtonText:"解析",cancelButtonText:"取消",inputType:"textarea",inputValidator:d=>{if(!d)return"请输入导出的字符串";const n=d.split(`
`).filter(b=>b.trim()!=="");let _=[];for(const b of n){let p;try{p=JSON.parse(b)}catch{try{const f=re.decompressFromBase64(b);p=JSON.parse(f)}catch{return`无法解析输入的数据：${b}，请确保每行都是正确的JSON或压缩后的字符串。`}}if(!Array.isArray(p))return`导入的数据格式不正确：${b}`;_=_.concat(p)}return _.length===0?"导入的数据不包含任何时间轴。":!0},inputErrorMessage:"无效的输入"}).then(({value:d})=>{const n=d.split(`
`).filter(f=>f.trim()!=="");let _=[];for(const f of n){let V;try{V=JSON.parse(f)}catch{const J=re.decompressFromBase64(f);V=JSON.parse(J)}_=_.concat(V)}const b=_.length,p=_.map(f=>`「${f.name}」`).join(", ");ee({title:"确认",message:`导入 ${b} 个时间轴：
${p}
？`,showCancelButton:!0,showConfirmButton:!0,confirmButtonText:"追加",cancelButtonText:"覆盖",distinguishCancelAndClose:!0,type:"warning",callback:f=>{f==="cancel"?ee.prompt('覆盖操作将删除所有现有的时间轴。请输入"我确认"以继续。',"二次确认",{confirmButtonText:"确定覆盖",cancelButtonText:"取消",inputPattern:/^我确认$/,inputErrorMessage:'请输入"我确认"以确认覆盖操作',type:"warning"}).then(({value:V})=>{V==="我确认"&&le(_,!0)}).catch(()=>{}):f==="confirm"&&le(_,!1)}})}).catch(()=>{})}function le(d,n){n&&(s.allTimelines.length=0),s.allTimelines.push(...d),s.sortTimelines();for(const f of s.allTimelines)f.condition.jobs===void 0&&(f.condition.jobs=[f.condition.job]);if(m(),n){j({type:"success",message:"覆盖成功！",duration:2e3});return}const _=[],b=new Set;for(const f of s.allTimelines){const V=JSON.stringify({name:f.name,condition:f.condition,timeline:f.timeline,codeFight:f.codeFight,create:f.create});b.has(V)||(b.add(V),_.push(f))}const p=s.allTimelines.length-_.length;s.allTimelines=_,j({message:`追加成功！共导入 ${d.length} 个时间轴${p>0?`，但其中 ${p} 个重复，已自动移除。`:""}`,type:"success",duration:3e3})}const de=Pe(()=>`${(g.value<0?"-":"")+(Array(2).join("0")+(Math.floor(g.value/60)+(g.value<0?1:0))).slice(-2)}:${(Array(2).join("0")+Math.floor(g.value%60)).slice(-2)}`);function ie(){e.timeline.timeline=e.timeline.timeline.replaceAll(new RegExp("(?<=^|#\\s*)(?<time>[:：\\d.]+)","gm"),(d,n)=>/^\d+:\d+(?:\.\d{1,2})?$/.test(d.toString())?Ee.duration(`00:${d.toString()}`).as("seconds").toString():Ee.utc(Number.parseFloat(d.toString())*1e3).format("mm:ss.S"))}function h(){const d=ht.resolve({path:"/timelineHelp"}).href;window.open(d,"_blank")}function Fe(d){s.configValues=d.configValues,s.showStyle=d.showStyle}const Le=d=>{if(d.source==="soumaTimeline"&&d.msg.type==="post"){P=!1,L.close();const n=d.msg.data;if(s.allTimelines.length===0&&n.allTimelines.length>s.allTimelines.length){for(const _ of n.allTimelines)_.condition.jobs===void 0&&(_.condition.jobs=[_.condition.job]),Reflect.deleteProperty(_.condition,"job");s.allTimelines=n.allTimelines,s.configValues=n.configValues,s.showStyle=n.showStyle,j.closeAll(),j({message:"数据获取成功",type:"success",duration:3e3})}}};function xe(){P=!0,L=ot.service({lock:!0,text:"正在请求数据，请确保 ACT 与悬浮窗已开启...，若 3 秒内仍未获取到数据，请检查 ACT 状态，且确认 timeline 悬浮窗已开启，或刷新页面重连。",background:"rgba(0, 0, 0, 0.7)"}),$("get"),setTimeout(()=>{P&&(j.info("重新尝试获取数据..."),xe())},5e3)}function Ke(){ee.confirm("你确定要将当前数据发送至 ACT 悬浮窗吗？悬浮窗中的内容将会被覆盖！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{$("post",s.$state)})}return lt(()=>{wt("BroadcastMessage",Le);const d=it(D,n=>{n&&(xe(),d())})}),(d,n)=>{const _=st,b=be,p=Ae,f=at,V=rt,J=he,ue=ct,M=Nt,Ce=St,He=Je,oe=Ne,Se=ze,$e=je,Qe=Re,me=dt,se=De,Ze=Ue,Ge=ut,We=mt,Xe=pt;return I(),q(Xe,{class:"container"},{default:l(()=>[t(ue,null,{default:l(()=>[t(b,{"m-b-5":""},{default:l(()=>[t(_,{title:"为防止用户数据意外丢失，在编辑完成后，你需要手动点击右侧绿色「应用」按钮，才会使得改动应用到悬浮窗中。",type:"info",closable:!1})]),_:1}),t(b,{align:"middle"},{default:l(()=>[t(J,{span:20},{default:l(()=>[t(V,{wrap:""},{default:l(()=>[t(f,null,{default:l(()=>[t(p,{type:"primary",onClick:n[0]||(n[0]=o=>c())},{default:l(()=>[F(" 从 FFlogs 生成 ")]),_:1}),t(p,{type:"primary",onClick:n[1]||(n[1]=o=>w())},{default:l(()=>[F(" 从 在线文档 获取 ")]),_:1}),t(p,{type:"primary",onClick:n[2]||(n[2]=o=>u())},{default:l(()=>[F(" 手动编写 ")]),_:1})]),_:1}),t(f,null,{default:l(()=>[t(p,{onClick:n[3]||(n[3]=o=>ne())},{default:l(()=>[F(" 导入字符串 ")]),_:1}),t(p,{class:"export",onClick:n[4]||(n[4]=o=>H(i(T)))},{default:l(()=>[F(" 导出全部 ")]),_:1})]),_:1}),t(f,null,{default:l(()=>[t(p,{onClick:n[5]||(n[5]=o=>h())},{default:l(()=>[F(" 时间轴语法 ")]),_:1})]),_:1}),t(f,null,{default:l(()=>[t(p,{type:"success",onClick:n[6]||(n[6]=o=>Ke())},{default:l(()=>[F(" 应用 ")]),_:1})]),_:1})]),_:1})]),_:1}),t(J,{span:4,style:{"text-align":"right"}},{default:l(()=>[t(p,{color:"#626aef",style:{color:"white"},onClick:n[7]||(n[7]=o=>B.value=!0)},{default:l(()=>[F(" 设置 ")]),_:1})]),_:1})]),_:1})]),_:1}),t(M,{modelValue:i(B),"onUpdate:modelValue":n[8]||(n[8]=o=>W(B)?B.value=o:null),onSave:Fe},null,8,["modelValue"]),t(We,null,{default:l(()=>[Bt,i(N)?(I(),q(Ce,{key:0,filters:i(R),onClearCurrentlyTimeline:m,onShowFFlogsToggle:n[9]||(n[9]=()=>N.value=!i(N)),onNewTimeline:i(s).newTimeline,onUpdateFilters:i(s).updateFilters},null,8,["filters","onNewTimeline","onUpdateFilters"])):fe("",!0),At,ge(t(me,null,{default:l(()=>[y("div",Ot,[Dt,t(He,{modelValue:i(g),"onUpdate:modelValue":n[10]||(n[10]=o=>W(g)?g.value=o:null),min:-30,max:1500,step:.1,"show-input":""},null,8,["modelValue"]),y("div",null,Q(i(de)),1)]),t(b,{class:"timeline-info"},{default:l(()=>[y("div",null,[y("p",Ut,[jt,t(oe,{modelValue:i(e).timeline.name,"onUpdate:modelValue":n[11]||(n[11]=o=>i(e).timeline.name=o),class:"timeline-info-name"},null,8,["modelValue"])]),y("p",zt,[Pt,t($e,{modelValue:i(e).timeline.condition.zoneId,"onUpdate:modelValue":n[12]||(n[12]=o=>i(e).timeline.condition.zoneId=o),filterable:""},{default:l(()=>[(I(),G(X,null,te(C,o=>t(Se,{key:o.id,label:o.name,value:o.id},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),y("p",Jt,[Mt,t($e,{modelValue:i(e).timeline.condition.jobs,"onUpdate:modelValue":n[13]||(n[13]=o=>i(e).timeline.condition.jobs=o),multiple:"",required:"",placeholder:"职业","collapse-tags":"","collapse-tags-tooltip":""},{default:l(()=>[(I(),G(X,null,te(Y,o=>{var A;return t(Se,{key:o,label:(((A=i(Z).nameToFullName(o))==null?void 0:A.cn)??o).replace("冒险者","全部职业"),value:o},null,8,["label","value"])}),64))]),_:1},8,["modelValue"])]),y("p",qt,[Rt,t(oe,{modelValue:i(e).timeline.codeFight,"onUpdate:modelValue":n[14]||(n[14]=o=>i(e).timeline.codeFight=o),disabled:""},null,8,["modelValue"])]),y("p",Lt,[Kt,t(oe,{modelValue:i(e).timeline.create,"onUpdate:modelValue":n[15]||(n[15]=o=>i(e).timeline.create=o),disabled:""},null,8,["modelValue"])]),t(b,{"m-b-10px":""},{default:l(()=>[t(p,{span:12,class:"export",onClick:n[16]||(n[16]=o=>H([i(e).timeline]))},{default:l(()=>[F(" 单独导出 ")]),_:1}),t(p,{type:"primary",span:12,onClick:n[17]||(n[17]=o=>ie())},{default:l(()=>[F(" 切换时间 ")]),_:1})]),_:1}),t(b,null,{default:l(()=>[t(p,{span:24,onClick:n[18]||(n[18]=o=>m())},{default:l(()=>[F(" 隐藏编辑界面 ")]),_:1})]),_:1})]),y("div",Ht,[t(oe,{modelValue:i(e).timeline.timeline,"onUpdate:modelValue":n[19]||(n[19]=o=>i(e).timeline.timeline=o),class:"timeline-timeline-raw",type:"textarea",rows:12,wrap:"off",placeholder:"请键入时间轴文本",style:{"max-width":"569px"},onChange:n[20]||(n[20]=o=>U())},null,8,["modelValue"])]),y("div",Qt,[y("div",Zt,[t(Qe,{config:i(s).configValues,lines:i(k),runtime:i(g),"show-style":i(s).showStyle},null,8,["config","lines","runtime","show-style"])])])]),_:1}),Gt]),_:1},512),[[ye,i(e).timeline.create!=="空"]]),Wt,i(T).length>0?(I(),q(me,{key:1},{default:l(()=>[t(Ze,{data:i(T),style:{width:"100%"},stripe:""},{default:l(()=>[t(se,{prop:"name",label:"名称"}),t(se,{prop:"conditon",label:"地图",sortable:""},{default:l(o=>{var A;return[F(Q((A=C.find(ae=>ae.id===o.row.condition.zoneId))==null?void 0:A.name),1)]}),_:1}),t(se,{prop:"conditon",label:"职业"},{default:l(o=>[F(Q(o.row.condition.jobs.map(A=>{var ae;return((ae=i(Z).nameToFullName(A.toUpperCase()))==null?void 0:ae.cn)??A}).join("、").replace("冒险者","全部职业")),1)]),_:1}),t(se,{fixed:"right",label:"操作",width:"150"},{default:l(o=>[t(p,{type:"primary",size:"small",onClick:A=>v(o.row)},{default:l(()=>[F(" 编辑 ")]),_:2},1032,["onClick"]),t(p,{type:"danger",size:"small",onClick:A=>x(o.row)},{default:l(()=>[F(" 删除 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):fe("",!0),i(T).length===0?(I(),q(me,{key:2},{default:l(()=>[t(Ge,{description:"点击上方新建或导入一个时间轴吧~"})]),_:1})):fe("",!0)]),_:1})]),_:1})}}});const un=Te(Xt,[["__scopeId","data-v-8af8e002"]]);export{un as default};
