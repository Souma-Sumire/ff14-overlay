import{d as nt,at as ot,v as _,y as $,A as st,B as it,au as lt,x as rt,Z as ct,r as B,o as J,b as ne,f as oe,D as _e,F as Ne,u as m,a as c,w as D,H as se,I as ut,a1 as dt,Q as mt,G as ft,t as pt,g as bt,av as vt,aw as ke,c as gt}from"./vendor-834361d8.js";import{t as ie,a as yt,p as ht,b as Ct,d as wt}from"./deepClone-11eeae0f.js";import{N as z,l as o}from"./netregexes-bb7ceaea.js";import{U as K}from"./util-f6d3a594.js";import{c as Te,s as xt,a as It}from"./status-2cacdfd9.js";import{g as _t}from"./actionChinese-71b7e526.js";import"./index-d60edf73.js";const Ee=[{id:141,name:"战斗之声",icon:12601,isFriendly:!0},{id:2722,name:"光明神的最终乐章",icon:12622,isFriendly:!0},{id:3183,name:"夺取",icon:14942,isFriendly:!1},{id:2599,name:"神秘环",icon:12936,isFriendly:!0},{id:786,name:"战斗连祷",icon:12578,isFriendly:!0},{id:1910,name:"巨龙右眼",icon:12581,isFriendly:!0},{id:1454,name:"巨龙左眼",icon:12582,isFriendly:!0},{id:1185,name:"义结金兰：攻击",icon:12532,isFriendly:!0},{id:2703,name:"灼热之光",icon:12699,isFriendly:!0},{id:1221,name:"连环计",icon:12809,isFriendly:!1},{id:1297,name:"鼓励",icon:13410,isFriendly:!0},{id:1822,name:"技巧舞步结束",icon:13709,isFriendly:!0},{id:1825,name:"进攻之探戈",icon:13714,isFriendly:!0},{id:1878,name:"占卜",icon:13245,isFriendly:!0}],le=new Map;let Ae;function re(N){if(Ae!==N){const s=N==="Chinese"?Ee:Object.assign(Ee,{});le.clear();for(const y of s)y.fullIcon=Te(y.icon),le.set(y.id.toString(16).toUpperCase(),y);Ae=N}}re("Chinese");function Nt(N){return le.get(N)}const kt=/(?:攻击力|伤害)提高/,Et=/(?:耐性|防御力)(?:大幅)?(?:降低|提升|低下|下降)|受伤(?:加重|减轻)|体力(?:增加|衰减|减少)|伤害屏障/,$e=(N,s)=>Object.entries(xt).reduce((y,[p,[n,k]])=>(N.test(n)&&y.set(p,{name:n,icon:k,isFriendly:s}),y),new Map),At=$e(kt,!0),St=$e(Et,!1),Tt={key:0,class:"testLog"},Se="souma-raidbuff-record-2",Ot=nt({__name:"raidbuffRecord",setup(N){const s=ot("hash"),y=_(s.dev==="1"||s.dev===void 0&&!window.OverlayPluginApi&&!s.OVERLAY_WS&&!s.HOST_PORT);y.value&&setTimeout(()=>{y.value=s.dev==="1"||s.dev===void 0&&!window.OverlayPluginApi&&!s.OVERLAY_WS&&!s.HOST_PORT},1e3);function p(e,t){return typeof t=="boolean"?e==="0"?!1:e==="1"?!0:t:typeof t=="number"?isNaN(+e)?t:+e:t}const n={scale:p(s.scale,1),showHeader:p(s.showHeader,!0),showIcon:p(s.showIcon,!0),showName:p(s.showName,!1),abbrId:p(s.abbrId,!0),anonymous:p(s.anonymous,!0),replaceWithYou:p(s.replaceWithYou,!1),parseAA:p(s.parseAA,!1),parseDoT:p(s.parseDoT,!1),minimize:p(s.minimize,!1),actionCN:p(s.actionCN,!0),statusCN:p(s.statusCN,!0),onlyBuffs:p(s.onlyBuffs,!0),filterPov:p(s.filterPov,!0)},k=_(n.minimize),Fe=n.scale>=2||window.devicePixelRatio>=2?"_hr1":"",F={line_height:28*n.scale,time:35*n.scale,action:65*n.scale,source:((n.showIcon?24:0)+(n.showName?n.anonymous||!n.anonymous&&n.abbrId?24:36:0)+4)*n.scale,amount:44*n.scale,properties:32*n.scale},Le={"--vxe-font-size-mini":12*n.scale+"px","--vxe-table-row-line-height":30*n.scale+"px","--vxe-table-row-height-mini":30*n.scale+"px","--vxe-input-height-mini":20*n.scale+"px","--vxe-select-option-height-mini":24*n.scale+"px"},ce={runtime:99,localStorage:3},Q=_(!1),O=_(),R=$("raidbuff-record-2-pov-name",""),M=$("raidbuff-record-2-pov-id",""),ue=$("raidbuff-record-2-party-list",[]),L=$("raidbuff-record-2-job-map",{}),X=$("raidbuff-record-2-party-event-party",[]),A=_(0),l=_([{zoneName:"",duration:"00:00",table:[],key:"init"}]),de={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d*)[^|]*\|(?<real>[^|]*)\|/i,ability:z.ability(),gainsEffect:z.gainsEffect(),losesEffect:z.losesEffect(),inCombat:/^260\|(?<timestamp>[^|]*)\|(?<inACTCombat>[^|]*)\|(?<inGameCombat>[^|]*)\|/i,changeZone:z.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|){0,})\w{16}/i,primaryPlayer:/^02\|(?<timestamp>[^|]*)\|(?<id>[^|]*)\|(?<name>[^|]*)/,addCombatant:z.addedCombatant(),removingCombatant:z.removingCombatant()},C=_(0),me=$("souma-raidbuff-record-2-zone-name",""),fe=$("souma-raidbuff-record-2-rsv-data",{}),w={friendly:{},enemy:{}},je=e=>{e.table.length=0,e.zoneName="",e.duration="00:00",e.key="init"},Pe=()=>{Q.value=!0,C.value=0,A.value=0,l.value.length=1,je(l.value[0])},De=()=>{ge(),Q.value=!1},pe=e=>{be(e.rawLine)},be=e=>{var t,r,d;for(const h in de){const I=de[h].exec(e);if(I){const a=e.split("|");switch(h){case"gainsEffect":{const i=a[o.GainsEffect.fields.effectId],u=a[o.GainsEffect.fields.effect],b=a[o.GainsEffect.fields.target],f=a[o.GainsEffect.fields.targetId],x=Number(a[o.GainsEffect.fields.count]);let g=Nt(i);if(!g){const S=f.startsWith("1")&&At.get(parseInt(i,16).toString())||f.startsWith("4")&&St.get(parseInt(i,16).toString());if(!S)return;const G=Te(S.icon),ae=x>1?It(G,x):G;g={id:parseInt(i,16),icon:S.icon,fullIcon:ae,name:S.name,isFriendly:S.isFriendly}}const j=a[o.GainsEffect.fields.duration],E=a[o.GainsEffect.fields.source],P=a[o.GainsEffect.fields.sourceId],te=new Date(a[o.GainsEffect.fields.timestamp]).getTime()+parseFloat(j)*1e3,Z={name:g.name,count:x,effect:u,effectId:i,source:E,sourceId:P,target:b,targetId:f,expirationTimestamp:te,fullIcon:g.fullIcon,isPov:M.value===P};f.startsWith("1")&&g.isFriendly?((t=w.friendly)[f]??(t[f]={}))[i]=Z:f.startsWith("4")&&!g.isFriendly&&(((r=w.enemy)[b]??(r[b]={}))[i]=Z)}break;case"losesEffect":{const i=a[o.LosesEffect.fields.target],u=a[o.LosesEffect.fields.targetId],b=a[o.LosesEffect.fields.effectId];u.startsWith("1")?w.friendly[u]&&Reflect.deleteProperty(w.friendly[u],b):w.enemy[i]&&Reflect.deleteProperty(w.enemy[i],b)}break;case"addCombatant":if(a[o.AddedCombatant.fields.job]!=="00"){const i=a[o.AddedCombatant.fields.job],u=new Date(a[o.AddedCombatant.fields.timestamp]).getTime();L.value[a[o.AddedCombatant.fields.id]]={job:parseInt(i,16),timestamp:u}}break;case"removingCombatant":Reflect.deleteProperty(L.value,a[o.RemovedCombatant.fields.id]);break;case"primaryPlayer":M.value=a[o.ChangedPlayer.fields.id];const U=a[o.ChangedPlayer.fields.name];if(R.value===U)return;R.value=U,ye(a[o.ChangedPlayer.fields.name]);break;case"partyList":ue.value=((d=I.groups.list)==null?void 0:d.split("|"))??[];break;case"changeZone":me.value=a[o.ChangeZone.fields.name],ve(new Date(a[o.ChangeZone.fields.timestamp]).getTime());break;case"inCombat":{const i=a[o.InCombat.fields.inACTCombat]==="1",u=a[o.InCombat.fields.inGameCombat]==="1",b=new Date(a[o.InCombat.fields.timestamp]).getTime();if(i||u){if(C.value>0)return;l.value[0].table.length!==0&&(l.value[0]=vt(l.value[0]),l.value.unshift({zoneName:"",duration:"00:00",table:[],key:a[o.InCombat.fields.timestamp]}),l.value.length>=ce.runtime&&l.value.splice(l.value.length-1,1)),C.value=b,l.value[0].zoneName=me.value,A.value=0;const f=O.value;f&&n.filterPov&&f.updateData().then(()=>{const x=f.getColumnByField("source");if(x){const g=x.filters.find(j=>j.value===R.value);if(!g)return;g.checked=!0,f.updateData().then(()=>{H.value.source=!0})}});return}if(!i&&!u){ve(b);return}}break;case"rsv":{const i=Number(I.groups.id),u=a[o.RSVData.fields.value];fe.value[Number(i)]=u}break;case"ability":if(C.value===0)return;{const i=ht(a);if(i.isAttack&&i.amount>=0){const u=a[o.Ability.fields.sourceId]??"???",b=a[o.Ability.fields.targetId]??"???";if(!(u.startsWith("1")&&b.startsWith("4"))||!(u===M.value||ue.value.includes(u)||X.value.find(T=>T.id===u)))return;const f=new Date(a[o.Ability.fields.timestamp]??"???").getTime(),x=a[o.Ability.fields.ability],g=x.match(/^_rsv_(?<id>\d+)_/),j=a[o.Ability.fields.id]??"???";let E=x;if(g){const T=Number(g.groups.id);E=fe.value[T]??x.match(/^_(?<id>rsv_\d+)_/).groups.id}else if(E=E.replace(/unknown_.*/,"攻击"),n.parseAA===!1&&/^攻击|攻撃|[Aa]ttack$/.test(E))return;const P=_t(parseInt(j,16)),Ce=P&&P!==""?P:E,te=Number(a[o.Ability.fields.targetCurrentHp])??"???",Z=Number(a[o.Ability.fields.targetMaxHp])??"???",S=a[o.Ability.fields.source]??"???",G=a[o.Ability.fields.target]??"???",{effect:ae,type:Qe,properties:Xe}=Ct(i.flags),qe=C.value===0?0:f-C.value,et=q(qe),we=ze(u),tt=K.nameToFullName(K.jobEnumToJob(we)).cn.substring(0,2),xe=we,at=K.jobEnumToIcon(xe).toLocaleLowerCase(),Ie=wt(Object.values(w.friendly[u]??[]).concat(Object.values(w.enemy[G]??[])).filter(T=>{const Y=Math.max(0,(T.expirationTimestamp-f)/1e3);return T.remainingDuration=Y>=999?"":Y.toFixed(Y>.05&&Y<.95?1:0),Number(T.remainingDuration)>-3}));if(n.onlyBuffs&&Ie.length===0)return;Oe({timestamp:f,time:et,id:j,action:E,actionCN:Ce,source:S,target:G,sourceId:u,job:tt,jobIcon:at,jobEnum:xe,amount:i.amount,raidbuffs:Ie,currentHp:te,maxHp:Z,effect:ae,properties:Xe,type:Qe,povId:M.value}),l.value[0].duration=q(new Date(a[o.Ability.fields.timestamp]).getTime()-C.value)}break}}}}},ze=e=>{const t=L.value[e],r=X.value.find(d=>d.id===e)??{job:0,timestamp:0};return[t,r].sort((d,h)=>h.timestamp-d.timestamp)[0].job},Oe=e=>{l.value[0].table.unshift(e)},ve=e=>{C.value!==0&&(l.value[0].duration=q(e-C.value),C.value=0,w.friendly={},w.enemy={},ge())},ge=()=>{localStorage.setItem(Se,JSON.stringify(l.value.slice(0,ce.localStorage)))},Re=()=>{const e=localStorage.getItem(Se);if(e)try{const t=JSON.parse(e);l.value.length=0,l.value.push(...t)}catch(t){console.error(t)}},q=e=>{const t=Math.max(Math.floor(e/6e4),0),r=Math.max(Math.floor((e-t*6e4)/1e3),0);return`${t<10?"0":""}${t}:${r<10?"0":""}${r}`},Me=st(()=>{const e={},t=new Set(l.value[A.value].table.slice().sort((r,d)=>K.enumSortMethod(r.jobEnum,d.jobEnum)).map(r=>(e[r.source]=r.job,r.source)));return Array.from(t).map(r=>({label:`${e[r]}（${r}）`,value:r}))});let ee=e=>e;const ye=e=>{/^([A-Z])\S+ ([A-Z])\S+$/.test(e)?(n.abbrId&&(ee=t=>t.replace(/^([A-Z])\S+ ([A-Z])\S+$/,"$1.$2.")),re("Global")):(n.abbrId&&(ee=t=>t.substring(0,2)),re("Chinese"))};ye(R.value);const he=e=>{const t=e.target;t.src.includes("cafemaker.wakingsands.com")?t.src=t.src.replace("cafemaker.wakingsands.com","xivapi.com"):t.src.includes("xivapi.com")&&(t.src="")},He=e=>{R.value=e.charName,M.value=e.charID.toString(16).toUpperCase()},Ge=e=>{X.value=e.party.map(t=>({...t,timestamp:Date.now()}))};it(()=>{for(const e in L.value){const t=L.value[e];Date.now()-t.timestamp>1e3*60*60*24*1&&Reflect.deleteProperty(L.value,e)}Re(),addOverlayListener("LogLine",pe),addOverlayListener("PartyChanged",Ge),addOverlayListener("ChangePrimaryPlayer",He),startOverlayEvents()}),lt(()=>{removeOverlayListener("LogLine",pe)});const Be=({row:e})=>c("div",null,[c("span",{class:"target"},[n.showIcon&&c("img",{class:"jobIcon",src:`//cafemaker.wakingsands.com/cj/companion/${e.jobIcon}.png`,alt:"","data-job":n.showName?"":e.job,onError:he,loading:"lazy"},null),n.showName&&c("span",{class:`job ${e.jobIcon} ${e.sourceId===e.povId?"YOU":""}`},[e.sourceId===e.povId&&n.replaceWithYou?"YOU":n.anonymous?e.job:ee(e.source)])])]),Ve=({row:e})=>c("span",{class:"amount"},[c("span",{class:`${e.type}`},[c("span",null,[e.amount.toLocaleString().padStart(3,"　")])])]),We=({row:e})=>c(se,null,[e.type==="dot"?"（不支持）":e.raidbuffs.map(t=>c("span",{class:"status",title:`${t.name}(${t.source})`,"data-duration":t.remainingDuration,"data-sourcePov":t.isPov},[c("img",{class:"statusIcon",src:`//cafemaker.wakingsands.com/i/${t.fullIcon}${Fe}.png`,alt:t.effect,onError:he,loading:"lazy"},null)]))]),Ue=e=>{const{action:t,actionCN:r,amount:d,job:h,raidbuffs:v,target:I,time:a,type:U}=e,i=e.effect==="damage done"?"":","+ie(e.effect),u=`${a} [${h}]${I} “${t}${r!==t?"("+r+")":""}” 造成${d.toLocaleString()}点${ie(U)}伤害。团辅：${v.length===0&&i===""?"无":v.map(b=>n.statusCN?b.name:b.effect).join(",")+i}。`;Ze(u)},Ze=e=>{navigator.clipboard.writeText(e).catch(()=>{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}),ke.modal.message({content:"已复制到剪贴板",status:"success"})},H=_({source:!1,action:!1}),V=_(),W=rt({className:"my-menus",body:{options:[]}});ct(()=>{var e;W.body&&W.body.options&&O.value&&(W.body.options[0]=[{code:"copy",name:"复制详情",prefixIcon:"vxe-icon-copy",className:"my-copy-item"},{code:"clearFilterTarget",name:"取消玩家筛选",prefixIcon:"vxe-icon-funnel-clear",visible:H.value.source,disabled:!1},{code:"filterSelectTarget",name:(e=V.value)!=null&&e.source?`只看[${V.value.job}] ${V.value.source}`:"只看该玩家",prefixIcon:"vxe-icon-user-fill",visible:!H.value.source,disabled:!1}])});const Ye=()=>{k.value=!k.value},Je=({row:e})=>{const t=O.value;t&&(t.setCurrentRow(e),V.value=e)},Ke=({menu:e,row:t,column:r})=>{const d=O.value;switch(e.code){case"copy":if(!t){ke.modal.message({content:"未选中有效数据行",status:"error"});return}Ue(t);break;case"clearFilterTarget":d&&(d.clearFilter(d.getColumnByField("source")),H.value.source=!1);break;case"filterSelectTarget":if(d){const h=d.getColumnByField("source");if(h){const v=h.filters.find(I=>I.value===t.source);if(!v)return;v.checked=!0,d.updateData().then(()=>{d.scrollToRow(t),H.value.source=!0})}}break}};return(e,t)=>{const r=B("vxe-option"),d=B("vxe-select"),h=B("vxe-button"),v=B("vxe-column"),I=B("vxe-table");return J(),ne(se,null,[oe("div",{class:"wrapper",style:Le},[oe("header",null,[_e(c(d,{modelValue:m(A),"onUpdate:modelValue":t[0]||(t[0]=a=>dt(A)?A.value=a:null),size:"mini",class:"select"},{default:D(()=>[(J(!0),ne(se,null,ut(m(l).length,a=>(J(),gt(r,{key:`${m(l)[a-1].key}-${m(l)[a-1].duration}-${m(l)[a-1].zoneName}`,value:a-1,label:`${m(l)[a-1].duration} ${m(l)[a-1].zoneName}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue"]),[[Ne,!m(k)]]),c(h,{class:"minimize",icon:m(k)?"vxe-icon-fullscreen":"vxe-icon-minimize",onClick:Ye,style:mt({opacity:m(k)?.5:1})},null,8,["icon","style"])]),_e(oe("main",null,[c(I,{ref_key:"xTable",ref:O,size:"mini",class:"vxe-table","show-overflow":"tooltip",round:"",height:"100%","scroll-y":{enabled:!0},loading:m(Q),"show-header":n.showHeader,data:m(l)[m(A)].table,"row-config":{isHover:!0,height:F.line_height},"header-cell-style":{padding:"0px"},onCellMenu:Je,"menu-config":m(W),onMenuClick:Ke},{default:D(()=>[c(v,{width:F.source,field:"source",title:n.showName?"友方":"友",filters:m(Me),"filter-multiple":!1,resizable:!n.anonymous&&!n.abbrId,align:"left","header-align":"center"},{default:D(({row:a})=>[c(Be,{row:a},null,8,["row"])]),_:1},8,["width","title","filters","resizable"]),c(v,{width:F.time,field:"time",title:"时间",align:"center"},null,8,["width"]),c(v,{width:F.action,field:n.actionCN?"actionCN":"action",title:"技能",resizable:!1,align:"right"},null,8,["width","field"]),c(v,{width:F.amount,title:"伤害","header-align":"center"},{default:D(({row:a})=>[c(Ve,{row:a},null,8,["row"])]),_:1},8,["width"]),c(v,{width:F.properties,title:"直暴","header-align":"center",align:"center"},{default:D(({row:a})=>[ft(pt(m(ie)(a.properties).replace(/普通|击$/,"")),1)]),_:1},8,["width"]),c(v,{title:"团辅",align:"left"},{default:D(({row:a})=>[c(We,{row:a},null,8,["row"])]),_:1})]),_:1},8,["loading","show-header","data","row-config","menu-config"])],512),[[Ne,!m(k)]])]),m(y)?(J(),ne("div",Tt,[c(yt,{onBeforeHandle:Pe,onAfterHandle:De,onHandleLine:be})])):bt("",!0)],64)}}});export{Ot as default};
