import{U as f}from"./util-6ab7166a.js";const d=new URLSearchParams(window.location.href.split("?")[1]),a=d.get("api"),i={cafe:"cafemaker.wakingsands.com",xivapi:"xivapi.com"},m=new Map,s={first:`https://${(a==null?void 0:a.toLowerCase())==="xivapi"?i.xivapi:i.cafe}`,second:`https://${(a==null?void 0:a.toLowerCase())==="xivapi"?i.cafe:i.xivapi}`},w={get random(){return Math.floor(Math.random()*864e5*11)+864e5*25}},I=new Map(Object.entries({任务指令:"/i/000000/000123.png",冲刺:"/i/000000/000104.png",坐骑:"/i/000000/000118.png",攻击:"/i/000000/000101.png",腐秽大地:"/i/003000/003090.png"})),p="souma-action-cache",u=JSON.parse(localStorage.getItem(p)||"[]"),$=Date.now(),C=1e3,y=u.filter((e,t)=>e.expirationTime>=$&&t<C);localStorage.setItem(p,JSON.stringify(y));const A=/(\d{6})\/(\d{6})\.png$/;async function T(e,t,o=["ID","Icon","ActionCategoryTargetID"]){if(m.has(t))return m.get(t);const n=D(e,t,o);try{const r=await h(n,{mode:"cors"});return m.set(t,r),r}catch(r){return console.error(`Failed to parse action: ${r}`),Promise.resolve({ActionCategoryTargetID:0,ID:t,Icon:"/i/000000/000405.png"})}}function D(e,t,o){const n=`${s.first}/${e}/${t}?columns=${o.join(",")}`;return[n,n.replace(s.first,s.second)]}async function E(e,t=!1){return`${s.first}${e}`.replace(A,(n,r,c)=>`${r}/${t?"hq/":""}${c}.png`)}function S(e){const t=f.jobEnumToJob(e),o=f.nameToFullName(t);return`${s.first}/cj/companion/${o.en.toLowerCase().replaceAll(/\s/g,"")}.png`}async function b(e){const t=await T("action",e,["Icon"]);return E(t.Icon)}async function j(e){const t=I.get(e);if(t)return{ActionCategoryTargetID:0,ID:0,Icon:t};const o=u.find(n=>n.name===e);if(o!=null&&o.action)return o.action;try{const r=(await h([`https://${i.cafe}/search?filters=ClassJobLevel>0&indexes=action&string=${encodeURIComponent(e)}`])).Results[0];if(r){const c=Date.now()+w.random,l={name:e,action:r,expirationTime:c};return u.push(l),localStorage.setItem(p,JSON.stringify(u)),r}return{ActionCategoryTargetID:0,ID:0,Icon:"/i/000000/000405.png"}}catch(n){throw console.error(`Failed to get action by name: ${n}`),new Error("Failed to retrieve action data")}}async function v(e,t){let o;const n=new Promise((r,c)=>{o=setTimeout(()=>{c(new Error("Promise timed out"))},t)});return Promise.race([e,n]).finally(()=>{clearTimeout(o)})}async function h(e,t){const o=Object.assign({cache:"force-cache"},t);for(const n of e)try{const r=await v(fetch(n,o),3e3);if(r.ok){const c=await r.json(),l=new URL(n).host;return{...c,Host:l}}}catch{}throw new Error("All fetch attempts failed.")}const g=new Map;function N(e){return g.has(e)?g.get(e):`${s.first}${e}`}function L(e){var n;const t=e.target,o=(n=t.src.match(new RegExp("(?<=\\.\\w+)\\/.+$")))==null?void 0:n[0];!o||t.src===""||(/pictomancer\.png$/.test(t.src)?t.src="//souma.diemoe.net/resources/img/pictomancer.png":/viper\.png$/.test(t.src)?t.src="//souma.diemoe.net/resources/img/viper.png":t.src.includes(s.first)?t.src=t.src.replace(s.first,s.second):t.src="",g.set(o,t.src))}export{j as a,E as b,b as c,m as d,S as e,N as g,L as h,T as p,s};
