import{d as be,p as z,K as Ce,o as I,e as G,a as t,w as o,y as h,R as Ge,u as l,c as j,a0 as W,A as Q,$ as oe,x as g,F as X,M as se,U,ah as ye,O as Ie,ai as Xe,aj as Ye,C as Ee,ak as ke,al as et,D as tt,am as Be,ag as Ne,ae as Ae,af as ze,a1 as Ue,ac as De,Y as nt,q as je,ad as Oe,an as Pe,ao as Le,H as Me,I as Re,B as lt,ap as ot,Z as Ve,b as it,X as st,t as at,v as rt,aq as de,n as M,ar as $e,as as ct,a3 as dt,a2 as ut,at as mt,G as pt,au as ft,a4 as _t,a5 as gt}from"./vendor-6ba522cf.js";import{u as he,_ as qe,p as yt}from"./TimelineShow-fad28b0f.js";import{U as ie}from"./util-831b56e7.js";import{g as wt}from"./actionChinese-bb2edb73.js";import{g as bt,h as ht}from"./xivapi-a5c0f7f0.js";import{_ as ve}from"./_plugin-vue_export-helper-c27b6911.js";import{a as vt,c as Tt}from"./overlay_plugin_api-409cb9ea.js";import{z as we}from"./zoneInfo-f6341183.js";import{r as Ft}from"./index-c95d10b3.js";import{u as St,c as xe}from"./useWebSocket-3477449c.js";import"./actWS-e2500b62.js";const s=new Map;s.set(26155,{type:"cast",window:[999,999]});s.set(28027,{type:"cast",window:[999,999]});s.set(26340,{type:"cast",window:[999,999]});s.set(25533,{type:"begincast",window:[60,60]});s.set(26376,{type:"cast",window:[999,999]});s.set(26814,{type:"begincast",window:[999,999]});s.set(25313,{type:"begincast",window:[200,200]});s.set(27526,{type:"begincast",window:[999,999]});s.set(26215,{type:"cast",window:[500,30]});s.set(29050,{type:"begincast",window:[200,30]});s.set(29156,{type:"cast",window:[20,20]});s.set(27973,{type:"cast",window:[20,20]});s.set(27937,{type:"begincast",window:[20,20]});s.set(28059,{type:"begincast",window:[20,20]});s.set(28060,{type:"begincast",window:[20,20]});s.set(28061,{type:"begincast",window:[20,20]});s.set(27956,{type:"begincast",window:[20,20]});s.set(27957,{type:"begincast",window:[20,20]});s.set(27952,{type:"begincast",window:[30,30]});s.set(27969,{type:"begincast",window:[20,20]});s.set(27971,{type:"begincast",window:[20,20]});s.set(27939,{type:"begincast",window:[20,20]});s.set(27966,{type:"begincast",window:[20,20]});s.set(25316,{type:"begincast",window:[999,999]});s.set(25544,{type:"begincast",window:[10,10]});s.set(26379,{type:"begincast",window:[10,10]});s.set(31552,{type:"begincast",window:[30,30]});s.set(31573,{type:"begincast",window:[30,30]});s.set(31573,{type:"begincast",window:[30,30]});s.set(31617,{type:"begincast",window:[8,8]});s.set(31624,{type:"begincast",window:[30,30]});s.set(31649,{type:"begincast",window:[30,30]});s.set(18864,{type:"cast",window:[10,2.5],once:!0});s.set(18480,{type:"cast",window:[200,60],once:!0});s.set(18516,{type:"cast",window:[250,65],once:!0});s.set(18522,{type:"begincast",window:[500,500],once:!0});s.set(18552,{type:"begincast",window:[67,67],once:!0});s.set(18553,{type:"cast",window:[67,67],once:!0});s.set(19083,{type:"cast",window:[900,0],once:!0});function Vt(E){const L=new Map;E.filter(y=>y.type==="begincast").map(y=>L.set(y.actionId,(L.get(y.actionId)??0)+1));for(const y of E){L.get(y.actionId)===1&&y.type==="begincast"&&(y.window=[12,12]);const i=s.get(y.actionId);(i==null?void 0:i.type)===y.type&&(y.window=i==null?void 0:i.window),y.syncOnce=!!(i!=null&&i.once)}return E}const $t={class:"query-results"},xt={class:"ability-filter-container"},Ct=["src","alt","onerror"],It=be({__name:"FflogsImport",props:{filters:{}},emits:["newTimeline","showFFlogsToggle","clearCurrentlyTimeline","updateFilters"],setup(E,{emit:L}){const y=E,i=L,T=new RegExp("(?<=^|\\/)(?<code>\\w{16,})\\/?#fight=(?<fight>\\d+|last)"),H={begincast:"14",cast:"1[56]"},k=z("查询"),N=z(""),A=z(!1),d=z(!1),$=z(0),O=z(!1),n=Ce({});x();const B=he();async function Y(C){var v,S,m;d.value=!0,x(),k.value="正在查询...";const a=C.match(T);if(!B.settings.api){U.alert("请在FF Logs个人设置页面获取V1 API Key","FF logs API Key 未填写",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0,message:'<a href="https://cn.fflogs.com/profile">点击这里，在最下方填写 V1 客户名称并点击确认后，获取你的 V1 客户端密钥</a>'}),k.value="查询",d.value=!1;return}if(!a){U.alert("请正确填写FF Logs链接","FF Logs链接格式错误",{confirmButtonText:"确定",type:"error"}),k.value="查询",d.value=!1;return}n.code=((v=a.groups)==null?void 0:v.code)??"";try{const p=await ye.get(`https://cn.fflogs.com/v1/report/fights/${n.code}?api_key=${B.settings.api}`);n.bossIDs=p.data.enemies.filter(w=>w.type==="Boss").map(w=>w.id),n.fightIndex=(((S=a==null?void 0:a.groups)==null?void 0:S.fight)==="last"?p.data.fights.length:Number.parseInt(((m=a==null?void 0:a.groups)==null?void 0:m.fight)??"0"))-1;const F=p.data.fights[n.fightIndex];n.zoneID=F.zoneID,n.start=F.start_time,n.end=F.end_time,n.friendlies=p.data.friendlies.filter(w=>w.icon!=="LimitBreak"&&w.fights.find(ne=>ne.id===n.fightIndex+1)),k.value="查询",n.abilityFilterEvents.length=0,n.abilityFilterCandidate.length=0,d.value=!1,$.value=1}catch(p){U.alert(`请检查您的FF Logs链接是否正确,并确保您有权限访问该报告。错误详情: ${p}`,"无法获取战斗数据",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0}),k.value="查询",d.value=!1}}async function Z(C){d.value=!0,$.value=2,n.player=C;try{await ee(),n.abilityFilterCandidate=n.abilityFilterEvents.reduce((a,v)=>(v.sourceIsFriendly&&!a.find(S=>S.actionId===v.actionId)&&a.push(v),a),[]),d.value=!1}catch(a){U.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${a}`,"获取玩家技能数据失败",{confirmButtonText:"确定",type:"error"}),d.value=!1}}async function ee(){var S,m;O.value=!1;const C=[];n.abilityFilterEvents.length=0;async function a(p){var F;try{const w=await ye.get(`https://cn.fflogs.com/v1/report/events/casts/${n.code}?start=${p}&end=${n.end}&hostility=0&sourceid=${(F=n.player)==null?void 0:F.id}&api_key=${B.settings.api}`);C.push(...w.data.events),w.data.nextPageTimestamp&&w.data.nextPageTimestamp>0&&w.data.nextPageTimestamp<n.end&&await a(w.data.nextPageTimestamp)}catch(w){U.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${w}`,"获取友方技能数据失败",{confirmButtonText:"确定",type:"error"})}}async function v(p,F){if(F>=0)try{const w=await ye.get(`https://cn.fflogs.com/v1/report/events/casts/${n.code}?start=${p}&end=${n.end}&hostility=1&sourceid=${n.bossIDs[F]}&api_key=${B.settings.api}`);C.push(...w.data.events),w.data.nextPageTimestamp&&w.data.nextPageTimestamp>0&&w.data.nextPageTimestamp<n.end&&await v(w.data.nextPageTimestamp,F),F<n.bossIDs.length-1&&await v(p,F+1)}catch(w){U.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${w}`,"获取敌方技能数据失败",{confirmButtonText:"确定",type:"error"})}}await Promise.all([a(n.start),v(n.start,0)]);for(const p of C)p.type==="begincast"&&p.sourceIsFriendly||n.abilityFilterEvents.push({time:Number(((p.timestamp-n.start)/1e3).toFixed(1)),type:p.type,actionName:wt(p.ability.guid)??p.ability.name,actionId:p.ability.guid,sourceIsFriendly:p.sourceIsFriendly,url:((S=p==null?void 0:p.ability)==null?void 0:S.abilityIcon.replace("-","/").replace(".png",""))??"000000/000405",window:void 0});(m=n.player)!=null&&m.icon&&y.filters[n.player.icon]&&(n.abilityFilterSelected=y.filters[n.player.icon]),O.value=!0}function te(){var C,a,v,S;d.value=!0,$.value=3,(C=n.player)!=null&&C.icon&&i("updateFilters",(a=n.player)==null?void 0:a.icon,JSON.parse(JSON.stringify(n.abilityFilterSelected))),n.abilityFilterEvents=n.abilityFilterEvents.filter(m=>m.sourceIsFriendly&&n.abilityFilterSelected.includes(m.actionId)||!m.sourceIsFriendly).sort((m,p)=>m.time-p.time),n.abilityFilterEvents=Vt(n.abilityFilterEvents),n.abilityFilterEventsAfterFilterRawTimeline=n.abilityFilterEvents.map(m=>m.sourceIsFriendly?`${m.time} "<${m.actionName}>~"${A.value?` tts "${m.actionName}"`:""}`:/^(?:攻击|attack|攻撃)$|^unknown/i.test(m.actionName)||m.type==="cast"&&m.window===void 0?`# ${m.time} "${m.actionName}"`:`${m.time} "${m.actionName}" sync /^.{14} \\w+ ${H[m.type]}:4.{7}:[^:]+:${m.actionId.toString(16).toUpperCase()}:/${m.window?` window ${m.window.join(",")}`:""}`).join(`
`),i("newTimeline",`导入${(v=n.player)==null?void 0:v.name}`,{zoneId:n.zoneID.toString(),jobs:[((S=n.player)==null?void 0:S.icon)??"NONE"]},n.abilityFilterEventsAfterFilterRawTimeline,`${n.code}#fight=${n.fightIndex+1}`),x(),i("showFFlogsToggle"),$.value=0,d.value=!1}function x(){n.code="",n.fightIndex=0,n.start=0,n.end=0,n.friendlies=[],n.abilityFilterEvents=[],n.abilityFilterCandidate=[],n.abilityFilterSelected=[],n.abilityFilterEventsAfterFilterRawTimeline="",n.player=void 0,n.zoneID=0,n.bossIDs=[]}function D(){window.open("https://cn.fflogs.com/profile","_blank")}return(C,a)=>{const v=Ie,S=Xe,m=Ye,p=Ee,F=ke,w=et,ne=tt,me=Be,le=Ne,K=Ae,pe=ze,fe=De,r=Ue;return I(),G(X,null,[t(v,{"position-absolute":"","z-999":"",style:Ge(l($)>0?{}:{visibility:"hidden",pointerEvent:"none"}),type:"primary",text:"",class:"guide",onClick:a[0]||(a[0]=e=>$.value--)},{default:o(()=>[h(" 上一步 ")]),_:1},8,["style"]),t(m,{active:l($),class:"steps-guide","align-center":""},{default:o(()=>[t(S,{title:"输入链接"}),t(S,{title:"选择玩家"}),t(S,{title:"过滤技能"}),t(S,{title:"生成时间轴"})]),_:1},8,["active"]),l($)===0?(I(),j(le,{key:0,class:"input-section"},{default:o(()=>[t(me,{"label-width":"150px",class:"fflogs-form"},{default:o(()=>[t(F,{label:"FF logs 战斗链接"},{default:o(()=>[t(p,{modelValue:l(N),"onUpdate:modelValue":a[1]||(a[1]=e=>W(N)?N.value=e:null),placeholder:"AAAaAaAAaa1aA1aA#fight=3",autocomplete:"on"},null,8,["modelValue"])]),_:1}),t(F,{label:"FF logs V1 Key"},{default:o(()=>[t(p,{modelValue:l(B).settings.api,"onUpdate:modelValue":a[2]||(a[2]=e=>l(B).settings.api=e),placeholder:"在FF Logs个人设置页面获取V1 API Key"},{append:o(()=>[t(w,{content:"点击前往FF Logs个人设置页面，在最下方填写V1客户名称并点击确认后，获取你的V1客户端密钥",placement:"top",effect:"light"},{default:o(()=>[t(v,{type:"primary",link:"",onClick:D},{default:o(()=>[h(" 如何获取 ")]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(F,{label:"使用 TTS"},{default:o(()=>[t(ne,{modelValue:l(A),"onUpdate:modelValue":a[3]||(a[3]=e=>W(A)?A.value=e:null)},null,8,["modelValue"])]),_:1}),t(F,null,{default:o(()=>[t(v,{disabled:l(k)==="正在查询...",type:"primary",onClick:a[4]||(a[4]=e=>Y(l(N)))},{default:o(()=>[h(Q(l(k)),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})):oe("",!0),g("div",$t,[l($)===1&&l(n).friendlies.length>0&&l(n).abilityFilterEvents.length===0?(I(),j(le,{key:0,class:"player-selection"},{default:o(()=>[t(pe,{data:l(n).friendlies.filter(e=>!["NPC"].includes(e.icon)),stripe:"",border:"",class:"friendlies-table"},{default:o(()=>[t(K,{prop:"name",label:"玩家名称"}),t(K,{label:"职业"},{default:o(({row:e})=>[h(Q(l(ie).nameToFullName(l(ie).jobEnumToJob(l(ie).iconToJobEnum(e.icon))).cn),1)]),_:1}),t(K,{label:"选定",width:"100",align:"center"},{default:o(e=>[t(v,{type:"primary",size:"small",onClick:f=>Z(e.row)},{default:o(()=>[h(" 选择 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):oe("",!0),l($)===2?(I(),j(le,{key:1,class:"ability-filter"},{default:o(()=>[g("div",xt,[t(r,{modelValue:l(n).abilityFilterSelected,"onUpdate:modelValue":a[5]||(a[5]=e=>l(n).abilityFilterSelected=e),multiple:"",placeholder:"选择需要导入的技能","fit-input-width":!0,class:"ability-filter-select"},{default:o(()=>[(I(!0),G(X,null,se(l(n).abilityFilterCandidate,e=>(I(),j(fe,{key:e.actionId,value:e.actionId,label:e.actionName,class:"ability-filter-option"},{default:o(()=>[g("img",{src:l(bt)(`/i/${e.url}.png`),class:"ability-filter-icon",alt:e.actionName,onerror:l(ht)},null,8,Ct),g("span",null,Q(e.actionName),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue"]),t(v,{type:"success",class:"filter-confirm-btn",disabled:!l(O),onClick:te},{default:o(()=>[h(Q(l(O)?"生成时间轴":"加载中..."),1)]),_:1},8,["disabled"])])]),_:1})):oe("",!0)])],64)}}});const Et=ve(It,[["__scopeId","data-v-f1a65b50"]]),ue=E=>(Me("data-v-52d0d6b5"),E=E(),Re(),E),kt=ue(()=>g("h3",{style:{margin:"0",padding:"10px","background-color":"#f5f7fa",cursor:"move"}}," 设置 ",-1)),Bt=ue(()=>g("h3",{class:"form-section-title"}," 参数 ",-1)),Nt=ue(()=>g("h3",{class:"form-section-title"}," 样式 ",-1)),At=ue(()=>g("h3",{class:"form-section-title"}," 测试用例 ",-1)),zt=be({__name:"SettingsDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(E,{emit:L}){const y=E,i=L,T=he();nt(()=>{T.saveTimelineSettings()});const H=je({get:()=>y.modelValue,set:A=>i("update:modelValue",A)}),k=z(-15),N=z([{time:-15,action:"<圣光幕帘>~",show:!0},{time:-2,action:"<圣灵>~",show:!0},{time:0,action:"战斗开始！",show:!0},{time:3,action:"<挑衅>~",show:!0},{time:5,action:"<神圣领域>~",show:!0}]);return(A,d)=>{const $=lt,O=ke,n=ot,B=Oe,Y=Pe,Z=qe,ee=Be,te=Le;return I(),j(te,{modelValue:l(H),"onUpdate:modelValue":d[1]||(d[1]=x=>W(H)?H.value=x:null),modal:!0,overflow:"","close-on-click-modal":!1,"custom-class":"timeline-dialog",width:"600px","append-to-body":!0,draggable:!0},{header:o(()=>[kt]),default:o(()=>[t(ee,{"label-position":"right","label-width":"120px",class:"timeline-form"},{default:o(()=>[Bt,t(B,{gutter:20},{default:o(()=>[(I(!0),G(X,null,se(l(T).configValues,(x,D,C)=>(I(),j(n,{key:C,span:12},{default:o(()=>[t(O,{label:l(T).configTranslate[D]},{default:o(()=>[t($,{modelValue:l(T).configValues[D],"onUpdate:modelValue":a=>l(T).configValues[D]=a,min:0,step:.1,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),Nt,t(B,{gutter:20},{default:o(()=>[(I(!0),G(X,null,se(l(T).showStyle,(x,D,C)=>(I(),j(n,{key:C,span:12},{default:o(()=>[t(O,{label:l(T).showStyleTranslate[D]},{default:o(()=>[t($,{modelValue:l(T).showStyle[D],"onUpdate:modelValue":a=>l(T).showStyle[D]=a,min:0,step:.01,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),At,t(B,{gutter:20},{default:o(()=>[t(Y,{modelValue:l(k),"onUpdate:modelValue":d[0]||(d[0]=x=>W(k)?k.value=x:null),min:-15,max:5,step:.1,"show-input":""},null,8,["modelValue"]),t(Z,{config:l(T).configValues,lines:l(N),runtime:l(k),"show-style":l(T).showStyle},null,8,["config","lines","runtime","show-style"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}});const Ut=ve(zt,[["__scopeId","data-v-52d0d6b5"]]),J=E=>(Me("data-v-e017711e"),E=E(),Re(),E),Dt={class:"alerts-container"},jt={class:"slider-demo-block"},Ot=J(()=>g("span",null,"模拟时间：",-1)),Pt={class:"timeline-info-config"},Lt=J(()=>g("span",null,"显示名称：",-1)),Mt={class:"timeline-info-config"},Rt=J(()=>g("span",null,"限定地图：",-1)),qt={class:"timeline-info-config"},Jt=J(()=>g("span",null,"限定职业：",-1)),Ht={class:"timeline-info-config"},Kt=J(()=>g("span",null,"战斗来源：",-1)),Qt={class:"timeline-info-config"},Wt=J(()=>g("span",null,"创建时间：",-1)),Zt={style:{flex:"1"}},Gt={style:{"max-height":"353px"}},Xt={class:"timeline-timeline-view"},Yt=J(()=>g("br",null,null,-1)),en=J(()=>g("br",null,null,-1)),tn=be({__name:"timelineSettings",setup(E){const{wsConnected:L}=St({allowClose:!0,addWsParam:!0}),y=z(0),i=he(),T=Ve(i,"allTimelines"),H=Ve(i,"filters"),k=[{id:"0",name:"任意"}],N=z(!1),A=z(!1),d=Ce({timeline:{name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}}),$=z([]);let O=null,n=!1;x();async function B(){$.value=[{time:0,action:"正在加载...",show:!0,windowBefore:0,windowAfter:0,alertAlready:!0}],$.value=await yt(d.timeline.timeline)}Y();function Y(){var r,e,f;for(const u in we)if(Object.prototype.hasOwnProperty.call(we,u)){const b=we[u];switch(b.contentType){case 4:case 5:case 28:k.push({id:u,name:((r=b.name)==null?void 0:r.cn)??((e=b.name)==null?void 0:e.ja)??((f=b.name)==null?void 0:f.ja)??u})}}v(),i.sortTimelines()}function Z(r,e={}){Tt({call:"broadcast",source:"soumaTimelineSettings",msg:{type:r,data:e}})}function ee(){N.value=!0,x()}function te(){const r="https://docs.qq.com/sheet/DTWxKT3lFbmpDV3Fm?tab=5ovrc8";window.open(r,"_blank")}function x(){y.value=-30,d.timeline={name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}}function D(){d.timeline=i.allTimelines[i.newTimeline()],B()}function C(r){window.scrollTo({top:0,behavior:"smooth"}),d.timeline=r,B()}function a(r){U.confirm(`确定要删除「${r.name}」吗？`,"删除时间轴",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning"}).then(()=>{x(),T.value.splice(T.value.findIndex(e=>e===r),1)})}function v(){i.loadTimelineSettings()}function S(r){const e=JSON.stringify(r),f=JSON.parse(e);for(const q of f)q.timeline=q.timeline.replace(/^#.*\n/gm,"");const u=JSON.stringify(f),b=de.compressToBase64(e),_=de.compressToBase64(u),V=b.length,R=_.length;if(V===R){xe(b).then(()=>{M({message:"数据复制成功，已写入剪切板。",type:"success",duration:2e3})}).catch(()=>{M({message:"复制失败，请手动复制！",type:"error",duration:3e3})});return}const _e=((V-R)/V*100).toFixed(2);U.confirm(`
     1. 完整版本（包含注释）<br>
     &nbsp;&nbsp;&nbsp;- 大小：${V} 字节<br>
     &nbsp;&nbsp;&nbsp;- 包含所有时间轴信息和注释<br><br>
     2. 优化版本（不含注释）<br>
     &nbsp;&nbsp;&nbsp;- 大小：${R} 字节<br>
     &nbsp;&nbsp;&nbsp;- 节省 ${_e}% 的空间<br>
     &nbsp;&nbsp;&nbsp;- 仅包含必要的时间轴数据`,"请选择导出版本：",{confirmButtonText:"导出优化版本",cancelButtonText:"导出完整版本",distinguishCancelAndClose:!0,closeOnClickModal:!1,closeOnPressEscape:!1,dangerouslyUseHTMLString:!0,showClose:!0,type:"info",callback:q=>{(q==="cancel"||q==="confirm")&&xe(q==="confirm"?_:b).then(()=>{M({message:"压缩数据复制成功，已写入剪切板。",type:"success",duration:2e3})}).catch(()=>{M({message:"复制失败，请手动复制！",type:"error",duration:3e3})})}})}function m(){U.prompt("请输入导出的字符串（支持多行导入）","导入时间轴",{confirmButtonText:"解析",cancelButtonText:"取消",inputType:"textarea",inputValidator:r=>{if(!r)return"请输入导出的字符串";const e=r.split(`
`).filter(u=>u.trim()!=="");let f=[];for(const u of e){let b;try{b=JSON.parse(u)}catch{try{const _=de.decompressFromBase64(u);b=JSON.parse(_)}catch{return`无法解析输入的数据：${u}，请确保每行都是正确的JSON或压缩后的字符串。`}}if(!Array.isArray(b))return`导入的数据格式不正确：${u}`;f=f.concat(b)}return f.length===0?"导入的数据不包含任何时间轴。":!0},inputErrorMessage:"无效的输入"}).then(({value:r})=>{const e=r.split(`
`).filter(_=>_.trim()!=="");let f=[];for(const _ of e){let V;try{V=JSON.parse(_)}catch{const R=de.decompressFromBase64(_);V=JSON.parse(R)}f=f.concat(V)}const u=f.length,b=f.map(_=>`「${_.name}」`).join(", ");U({title:"确认",message:`导入 ${u} 个时间轴：
${b}
？`,showCancelButton:!0,showConfirmButton:!0,confirmButtonText:"追加",cancelButtonText:"覆盖",distinguishCancelAndClose:!0,type:"warning",callback:_=>{_==="cancel"?U.prompt('覆盖操作将删除所有现有的时间轴。请输入"我确认"以继续。',"二次确认",{confirmButtonText:"确定覆盖",cancelButtonText:"取消",inputPattern:/^我确认$/,inputErrorMessage:'请输入"我确认"以确认覆盖操作',type:"warning"}).then(({value:V})=>{V==="我确认"&&p(f,!0)}).catch(()=>{}):_==="confirm"&&p(f,!1)}})}).catch(()=>{})}function p(r,e){e&&(i.allTimelines.length=0),i.allTimelines.push(...r),i.sortTimelines();for(const _ of i.allTimelines)_.condition.jobs===void 0&&(_.condition.jobs=[_.condition.job]);if(x(),e){M({type:"success",message:"覆盖成功！",duration:2e3});return}const f=[],u=new Set;for(const _ of i.allTimelines){const V=JSON.stringify({name:_.name,condition:_.condition,timeline:_.timeline,codeFight:_.codeFight,create:_.create});u.has(V)||(u.add(V),f.push(_))}const b=i.allTimelines.length-f.length;i.allTimelines=f,M({message:`追加成功！共导入 ${r.length} 个时间轴${b>0?`，但其中 ${b} 个重复，已自动移除。`:""}`,type:"success",duration:3e3})}const F=je(()=>`${(y.value<0?"-":"")+(Array(2).join("0")+(Math.floor(y.value/60)+(y.value<0?1:0))).slice(-2)}:${(Array(2).join("0")+Math.floor(y.value%60)).slice(-2)}`);function w(){d.timeline.timeline=d.timeline.timeline.replaceAll(new RegExp("(?<=^|#\\s*)(?<time>[:：\\d.]+)","gm"),(r,e)=>/^\d+:\d+(?:\.\d{1,2})?$/.test(r.toString())?$e.duration(`00:${r.toString()}`).as("seconds").toString():$e.utc(Number.parseFloat(r.toString())*1e3).format("mm:ss.S"))}function ne(){const r=Ft.resolve({path:"/timelineHelp"}).href;window.open(r,"_blank")}function me(r){i.configValues=r.configValues,i.showStyle=r.showStyle}const le=r=>{if(r.source==="soumaTimeline"&&r.msg.type==="post"){n=!1,O.close();const e=r.msg.data;for(const f of e.allTimelines)f.condition.jobs===void 0&&(f.condition.jobs=[f.condition.job]),f.condition.jobs.sort((u,b)=>i.jobList.indexOf(u)-i.jobList.indexOf(b)),Reflect.deleteProperty(f.condition,"job");i.allTimelines=e.allTimelines,i.configValues=e.configValues,i.showStyle=e.showStyle,M.closeAll(),M({message:"数据获取成功",type:"success",duration:3e3})}};function K(){n=!0,O=ct.service({lock:!0,text:"正在请求数据，请确保 ACT 与悬浮窗已开启...，若 10 秒内仍未获取到数据，请检查 ACT 状态，且确认 timeline 悬浮窗已开启，或刷新页面重连。",background:"rgba(0, 0, 0, 0.7)"}),Z("get"),setTimeout(()=>{n&&(M.info("重新尝试获取数据..."),K())},5e3)}function pe(){U.confirm("你确定要将当前数据发送至 ACT 悬浮窗吗？悬浮窗中的内容将会被覆盖！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{Z("post",i.$state)})}function fe(){x(),K()}return it(()=>{vt("BroadcastMessage",le);const r=st(L,e=>{e&&(i.allTimelines.length===0&&K(),r())})}),(r,e)=>{const f=Ut,u=Ie,b=dt,_=ut,V=Oe,R=mt,_e=pt,q=Et,Te=Le,Je=Pe,ae=Ee,Fe=De,Se=Ue,He=qe,ge=Ne,re=Ae,Ke=ze,Qe=ft,We=_t,Ze=gt;return I(),j(Ze,{class:"container"},{default:o(()=>[t(f,{modelValue:l(A),"onUpdate:modelValue":e[0]||(e[0]=c=>W(A)?A.value=c:null),onSave:me},null,8,["modelValue"]),t(_e,{class:"flex-header"},{default:o(()=>[t(V,{justify:"space-between",align:"middle","m-b-2":""},{default:o(()=>[t(_,{wrap:"",size:10},{default:o(()=>[t(b,null,{default:o(()=>[t(u,{type:"primary",size:"small",onClick:ee},{default:o(()=>[h(" 从 FFlogs 生成 ")]),_:1}),t(u,{type:"primary",size:"small",onClick:te},{default:o(()=>[h(" 从 在线文档 获取 ")]),_:1}),t(u,{type:"primary",size:"small",onClick:D},{default:o(()=>[h(" 手动编写 ")]),_:1})]),_:1}),t(b,null,{default:o(()=>[t(u,{size:"small",onClick:m},{default:o(()=>[h(" 导入字符串 ")]),_:1}),t(u,{size:"small",class:"export",onClick:e[1]||(e[1]=c=>S(l(T)))},{default:o(()=>[h(" 导出全部 ")]),_:1})]),_:1}),t(u,{size:"small",onClick:ne},{default:o(()=>[h(" 时间轴语法 ")]),_:1}),t(u,{type:"success",size:"small",onClick:pe},{default:o(()=>[h(" 应用 ")]),_:1})]),_:1}),t(_,null,{default:o(()=>[t(u,{color:"#a0d911",style:{color:"white"},size:"small",onClick:fe},{default:o(()=>[h(" 恢复至之前的时间轴 ")]),_:1}),t(u,{color:"#626aef",style:{color:"white"},size:"small",onClick:e[2]||(e[2]=c=>A.value=!0)},{default:o(()=>[h(" 设置 ")]),_:1})]),_:1})]),_:1}),g("div",Dt,[t(R,{title:"编辑完成后,需手动点击「应用」按钮","show-icon":"",type:"info",closable:!1,class:"alert-item"}),t(R,{title:"当你误操作或数据与 ACT 悬浮窗中的数据不符，且尚未点击「应用」时，可点击「恢复至之前的时间轴」，则会恢复到当前 ACT 悬浮窗中保存的数据","show-icon":"",type:"warning",closable:!1,class:"alert-item"})])]),_:1}),t(We,null,{default:o(()=>[t(Te,{modelValue:l(N),"onUpdate:modelValue":e[4]||(e[4]=c=>W(N)?N.value=c:null),title:"从 FFlogs 生成时间轴",width:"80%","before-close":()=>N.value=!1},{default:o(()=>[t(q,{filters:l(H),onClearCurrentlyTimeline:x,onShowFFlogsToggle:e[3]||(e[3]=()=>N.value=!1),onNewTimeline:l(i).newTimeline,onUpdateFilters:l(i).updateFilters},null,8,["filters","onNewTimeline","onUpdateFilters"])]),_:1},8,["modelValue","before-close"]),at(t(ge,null,{default:o(()=>[g("div",jt,[Ot,t(Je,{modelValue:l(y),"onUpdate:modelValue":e[5]||(e[5]=c=>W(y)?y.value=c:null),min:-30,max:1500,step:.1,"show-input":""},null,8,["modelValue"]),g("div",null,Q(l(F)),1)]),t(V,{class:"timeline-info"},{default:o(()=>[g("div",null,[g("p",Pt,[Lt,t(ae,{modelValue:l(d).timeline.name,"onUpdate:modelValue":e[6]||(e[6]=c=>l(d).timeline.name=c),class:"timeline-info-name"},null,8,["modelValue"])]),g("p",Mt,[Rt,t(Se,{modelValue:l(d).timeline.condition.zoneId,"onUpdate:modelValue":e[7]||(e[7]=c=>l(d).timeline.condition.zoneId=c),filterable:""},{default:o(()=>[(I(),G(X,null,se(k,c=>t(Fe,{key:c.id,label:c.name,value:c.id},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),g("p",qt,[Jt,t(Se,{modelValue:l(d).timeline.condition.jobs,"onUpdate:modelValue":e[8]||(e[8]=c=>l(d).timeline.condition.jobs=c),multiple:"",required:"",placeholder:"职业","collapse-tags":"","collapse-tags-tooltip":""},{default:o(()=>[(I(!0),G(X,null,se(l(i).jobList,c=>{var P;return I(),j(Fe,{key:c,label:(((P=l(ie).nameToFullName(c))==null?void 0:P.cn)??c).replace("冒险者","全部职业"),value:c},null,8,["label","value"])}),128))]),_:1},8,["modelValue"])]),g("p",Ht,[Kt,t(ae,{modelValue:l(d).timeline.codeFight,"onUpdate:modelValue":e[9]||(e[9]=c=>l(d).timeline.codeFight=c),disabled:""},null,8,["modelValue"])]),g("p",Qt,[Wt,t(ae,{modelValue:l(d).timeline.create,"onUpdate:modelValue":e[10]||(e[10]=c=>l(d).timeline.create=c),disabled:""},null,8,["modelValue"])]),t(V,{"m-b-10px":""},{default:o(()=>[t(u,{span:12,class:"export",onClick:e[11]||(e[11]=c=>S([l(d).timeline]))},{default:o(()=>[h(" 单独导出 ")]),_:1}),t(u,{type:"primary",span:12,onClick:e[12]||(e[12]=c=>w())},{default:o(()=>[h(" 切换时间 ")]),_:1})]),_:1}),t(V,null,{default:o(()=>[t(u,{span:24,onClick:e[13]||(e[13]=c=>x())},{default:o(()=>[h(" 隐藏编辑界面 ")]),_:1})]),_:1})]),g("div",Zt,[t(ae,{modelValue:l(d).timeline.timeline,"onUpdate:modelValue":e[14]||(e[14]=c=>l(d).timeline.timeline=c),class:"timeline-timeline-raw",type:"textarea",rows:12,wrap:"off",placeholder:"请键入时间轴文本",style:{"max-width":"569px"},onChange:e[15]||(e[15]=c=>B())},null,8,["modelValue"])]),g("div",Gt,[g("div",Xt,[t(He,{config:l(i).configValues,lines:l($),runtime:l(y),"show-style":l(i).showStyle},null,8,["config","lines","runtime","show-style"])])])]),_:1}),Yt]),_:1},512),[[rt,l(d).timeline.create!=="空"]]),en,l(T).length>0?(I(),j(ge,{key:0},{default:o(()=>[t(Ke,{data:l(T),style:{width:"100%"},stripe:""},{default:o(()=>[t(re,{prop:"name",label:"名称"}),t(re,{prop:"conditon",label:"地图",sortable:""},{default:o(c=>{var P;return[h(Q((P=k.find(ce=>ce.id===c.row.condition.zoneId))==null?void 0:P.name),1)]}),_:1}),t(re,{prop:"conditon",label:"职业"},{default:o(c=>[h(Q(c.row.condition.jobs.map(P=>{var ce;return((ce=l(ie).nameToFullName(P.toUpperCase()))==null?void 0:ce.cn)??P}).join("、").replace("冒险者","全部职业")),1)]),_:1}),t(re,{fixed:"right",label:"操作",width:"150"},{default:o(c=>[t(u,{type:"primary",size:"small",onClick:P=>C(c.row)},{default:o(()=>[h(" 编辑 ")]),_:2},1032,["onClick"]),t(u,{type:"danger",size:"small",onClick:P=>a(c.row)},{default:o(()=>[h(" 删除 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):oe("",!0),l(T).length===0?(I(),j(ge,{key:1},{default:o(()=>[t(Qe,{description:"点击上方新建或导入一个时间轴吧~"})]),_:1})):oe("",!0)]),_:1})]),_:1})}}});const fn=ve(tn,[["__scopeId","data-v-e017711e"]]);export{fn as default};
