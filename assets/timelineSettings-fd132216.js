import{d as be,p as z,K as Ce,o as E,e as G,a as t,w as o,y as h,R as Ge,u as l,c as j,a0 as W,A as Q,$ as oe,x as g,F as X,M as se,U,ah as ye,O as Ee,ai as Xe,aj as Ye,C as Ie,ak as ke,al as et,D as tt,am as Be,ag as Ne,ae as Ae,af as ze,a1 as Ue,ac as De,Y as nt,q as je,ad as Oe,an as Pe,ao as Le,H as Me,I as Re,B as lt,ap as ot,Z as Ve,b as it,X as st,t as at,v as rt,aq as de,n as M,ar as $e,as as ct,a3 as dt,a2 as ut,at as mt,G as pt,au as ft,a4 as _t,a5 as gt}from"./vendor-6ba522cf.js";import{u as he,_ as qe,p as yt}from"./TimelineShow-fad28b0f.js";import{U as ie}from"./util-831b56e7.js";import{g as wt}from"./actionChinese-bb2edb73.js";import{g as bt,h as ht}from"./xivapi-a5c0f7f0.js";import{_ as ve}from"./_plugin-vue_export-helper-c27b6911.js";import{a as vt,c as Tt}from"./overlay_plugin_api-409cb9ea.js";import{z as we}from"./zoneInfo-f6341183.js";import{r as Ft}from"./index-00264790.js";import{u as St,c as xe}from"./useWebSocket-3477449c.js";import"./actWS-e2500b62.js";const i=new Map;i.set(26155,{type:"cast",window:[999,999]});i.set(28027,{type:"cast",window:[999,999]});i.set(26340,{type:"cast",window:[999,999]});i.set(25533,{type:"begincast",window:[60,60]});i.set(26376,{type:"cast",window:[999,999]});i.set(26814,{type:"begincast",window:[999,999]});i.set(25313,{type:"begincast",window:[200,200]});i.set(27526,{type:"begincast",window:[999,999]});i.set(26215,{type:"cast",window:[500,30]});i.set(29050,{type:"begincast",window:[200,30]});i.set(29156,{type:"cast",window:[20,20]});i.set(27973,{type:"cast",window:[20,20]});i.set(27937,{type:"begincast",window:[20,20]});i.set(28059,{type:"begincast",window:[20,20]});i.set(28060,{type:"begincast",window:[20,20]});i.set(28061,{type:"begincast",window:[20,20]});i.set(27956,{type:"begincast",window:[20,20]});i.set(27957,{type:"begincast",window:[20,20]});i.set(27952,{type:"begincast",window:[30,30]});i.set(27969,{type:"begincast",window:[20,20]});i.set(27971,{type:"begincast",window:[20,20]});i.set(27939,{type:"begincast",window:[20,20]});i.set(27966,{type:"begincast",window:[20,20]});i.set(25316,{type:"begincast",window:[999,999]});i.set(25544,{type:"begincast",window:[10,10]});i.set(26379,{type:"begincast",window:[10,10]});i.set(31552,{type:"begincast",window:[30,30]});i.set(31573,{type:"begincast",window:[30,30]});i.set(31573,{type:"begincast",window:[30,30]});i.set(31617,{type:"begincast",window:[8,8]});i.set(31624,{type:"begincast",window:[30,30]});i.set(31649,{type:"begincast",window:[30,30]});i.set(18864,{type:"cast",window:[10,2.5],once:!0});i.set(18480,{type:"cast",window:[200,60],once:!0});i.set(18516,{type:"cast",window:[250,65],once:!0});i.set(18522,{type:"begincast",window:[500,500],once:!0});i.set(18552,{type:"begincast",window:[67,67],once:!0});i.set(18553,{type:"cast",window:[67,67],once:!0});i.set(19083,{type:"cast",window:[900,0],once:!0});i.set(40191,{type:"begincast",window:[200,20],once:!0});i.set(40265,{type:"begincast",window:[500,20],once:!0});function Vt(k){for(const O of k){const w=i.get(O.actionId);(w==null?void 0:w.type)===O.type&&(O.window=w==null?void 0:w.window),O.syncOnce=!!(w!=null&&w.once)}return k}const $t={class:"query-results"},xt={class:"ability-filter-container"},Ct=["src","alt","onerror"],Et=be({__name:"FflogsImport",props:{filters:{}},emits:["newTimeline","showFFlogsToggle","clearCurrentlyTimeline","updateFilters"],setup(k,{emit:O}){const w=k,u=O,T=new RegExp("(?<=^|\\/)(?<code>\\w{16,})\\/?#fight=(?<fight>\\d+|last)"),H={begincast:"14",cast:"1[56]"},I=z("查询"),N=z(""),A=z(!1),c=z(!1),$=z(0),P=z(!1),n=Ce({});x();const B=he();async function Y(C){var v,S,m;c.value=!0,x(),I.value="正在查询...";const s=C.match(T);if(!B.settings.api){U.alert("请在FF Logs个人设置页面获取V1 API Key","FF logs API Key 未填写",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0,message:'<a href="https://cn.fflogs.com/profile">点击这里，在最下方填写 V1 客户名称并点击确认后，获取你的 V1 客户端密钥</a>'}),I.value="查询",c.value=!1;return}if(!s){U.alert("请正确填写FF Logs链接","FF Logs链接格式错误",{confirmButtonText:"确定",type:"error"}),I.value="查询",c.value=!1;return}n.code=((v=s.groups)==null?void 0:v.code)??"";try{const p=await ye.get(`https://cn.fflogs.com/v1/report/fights/${n.code}?api_key=${B.settings.api}`);n.bossIDs=p.data.enemies.filter(y=>y.type==="Boss").map(y=>y.id),n.fightIndex=(((S=s==null?void 0:s.groups)==null?void 0:S.fight)==="last"?p.data.fights.length:Number.parseInt(((m=s==null?void 0:s.groups)==null?void 0:m.fight)??"0"))-1;const F=p.data.fights[n.fightIndex];n.zoneID=F.zoneID,n.start=F.start_time,n.end=F.end_time,n.friendlies=p.data.friendlies.filter(y=>y.icon!=="LimitBreak"&&y.fights.find(ne=>ne.id===n.fightIndex+1)),I.value="查询",n.abilityFilterEvents.length=0,n.abilityFilterCandidate.length=0,c.value=!1,$.value=1}catch(p){U.alert(`请检查您的FF Logs链接是否正确,并确保您有权限访问该报告。错误详情: ${p}`,"无法获取战斗数据",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0}),I.value="查询",c.value=!1}}async function Z(C){c.value=!0,$.value=2,n.player=C;try{await ee(),n.abilityFilterCandidate=n.abilityFilterEvents.reduce((s,v)=>(v.sourceIsFriendly&&!s.find(S=>S.actionId===v.actionId)&&s.push(v),s),[]),c.value=!1}catch(s){U.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${s}`,"获取玩家技能数据失败",{confirmButtonText:"确定",type:"error"}),c.value=!1}}async function ee(){var S,m;P.value=!1;const C=[];n.abilityFilterEvents.length=0;async function s(p){var F;try{const y=await ye.get(`https://cn.fflogs.com/v1/report/events/casts/${n.code}?start=${p}&end=${n.end}&hostility=0&sourceid=${(F=n.player)==null?void 0:F.id}&api_key=${B.settings.api}`);C.push(...y.data.events),y.data.nextPageTimestamp&&y.data.nextPageTimestamp>0&&y.data.nextPageTimestamp<n.end&&await s(y.data.nextPageTimestamp)}catch(y){U.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${y}`,"获取友方技能数据失败",{confirmButtonText:"确定",type:"error"})}}async function v(p,F){if(F>=0)try{const y=await ye.get(`https://cn.fflogs.com/v1/report/events/casts/${n.code}?start=${p}&end=${n.end}&hostility=1&sourceid=${n.bossIDs[F]}&api_key=${B.settings.api}`);C.push(...y.data.events),y.data.nextPageTimestamp&&y.data.nextPageTimestamp>0&&y.data.nextPageTimestamp<n.end&&await v(y.data.nextPageTimestamp,F),F<n.bossIDs.length-1&&await v(p,F+1)}catch(y){U.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${y}`,"获取敌方技能数据失败",{confirmButtonText:"确定",type:"error"})}}await Promise.all([s(n.start),v(n.start,0)]);for(const p of C)p.type==="begincast"&&p.sourceIsFriendly||n.abilityFilterEvents.push({time:Number(((p.timestamp-n.start)/1e3).toFixed(1)),type:p.type,actionName:wt(p.ability.guid)??p.ability.name,actionId:p.ability.guid,sourceIsFriendly:p.sourceIsFriendly,url:((S=p==null?void 0:p.ability)==null?void 0:S.abilityIcon.replace("-","/").replace(".png",""))??"000000/000405",window:void 0});(m=n.player)!=null&&m.icon&&w.filters[n.player.icon]&&(n.abilityFilterSelected=w.filters[n.player.icon]),P.value=!0}function te(){var C,s,v,S;c.value=!0,$.value=3,(C=n.player)!=null&&C.icon&&u("updateFilters",(s=n.player)==null?void 0:s.icon,JSON.parse(JSON.stringify(n.abilityFilterSelected))),n.abilityFilterEvents=n.abilityFilterEvents.filter(m=>m.sourceIsFriendly&&n.abilityFilterSelected.includes(m.actionId)||!m.sourceIsFriendly).sort((m,p)=>m.time-p.time),n.abilityFilterEvents=Vt(n.abilityFilterEvents),n.abilityFilterEventsAfterFilterRawTimeline=n.abilityFilterEvents.map(m=>m.sourceIsFriendly?`${m.time} "<${m.actionName}>~"${A.value?` tts "${m.actionName}"`:""}`:/^(?:攻击|attack|攻撃)$|^unknown/i.test(m.actionName)||m.type==="cast"&&m.window===void 0?`# ${m.time} "${m.actionName}"`:`${m.time} "${m.actionName}" sync /^.{14} \\w+ ${H[m.type]}:4.{7}:[^:]+:${m.actionId.toString(16).toUpperCase()}:/${m.window?` window ${m.window.join(",")}`:""}`).join(`
`),u("newTimeline",`导入${(v=n.player)==null?void 0:v.name}`,{zoneId:n.zoneID.toString(),jobs:[((S=n.player)==null?void 0:S.icon)??"NONE"]},n.abilityFilterEventsAfterFilterRawTimeline,`${n.code}#fight=${n.fightIndex+1}`),x(),u("showFFlogsToggle"),$.value=0,c.value=!1}function x(){n.code="",n.fightIndex=0,n.start=0,n.end=0,n.friendlies=[],n.abilityFilterEvents=[],n.abilityFilterCandidate=[],n.abilityFilterSelected=[],n.abilityFilterEventsAfterFilterRawTimeline="",n.player=void 0,n.zoneID=0,n.bossIDs=[]}function D(){window.open("https://cn.fflogs.com/profile","_blank")}return(C,s)=>{const v=Ee,S=Xe,m=Ye,p=Ie,F=ke,y=et,ne=tt,me=Be,le=Ne,K=Ae,pe=ze,fe=De,a=Ue;return E(),G(X,null,[t(v,{"position-absolute":"","z-999":"",style:Ge(l($)>0?{}:{visibility:"hidden",pointerEvent:"none"}),type:"primary",text:"",class:"guide",onClick:s[0]||(s[0]=e=>$.value--)},{default:o(()=>[h(" 上一步 ")]),_:1},8,["style"]),t(m,{active:l($),class:"steps-guide","align-center":""},{default:o(()=>[t(S,{title:"输入链接"}),t(S,{title:"选择玩家"}),t(S,{title:"过滤技能"}),t(S,{title:"生成时间轴"})]),_:1},8,["active"]),l($)===0?(E(),j(le,{key:0,class:"input-section"},{default:o(()=>[t(me,{"label-width":"150px",class:"fflogs-form"},{default:o(()=>[t(F,{label:"FF logs 战斗链接"},{default:o(()=>[t(p,{modelValue:l(N),"onUpdate:modelValue":s[1]||(s[1]=e=>W(N)?N.value=e:null),placeholder:"AAAaAaAAaa1aA1aA#fight=3",autocomplete:"on"},null,8,["modelValue"])]),_:1}),t(F,{label:"FF logs V1 Key"},{default:o(()=>[t(p,{modelValue:l(B).settings.api,"onUpdate:modelValue":s[2]||(s[2]=e=>l(B).settings.api=e),placeholder:"在FF Logs个人设置页面获取V1 API Key"},{append:o(()=>[t(y,{content:"点击前往FF Logs个人设置页面，在最下方填写V1客户名称并点击确认后，获取你的V1客户端密钥",placement:"top",effect:"light"},{default:o(()=>[t(v,{type:"primary",link:"",onClick:D},{default:o(()=>[h(" 如何获取 ")]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(F,{label:"使用 TTS"},{default:o(()=>[t(ne,{modelValue:l(A),"onUpdate:modelValue":s[3]||(s[3]=e=>W(A)?A.value=e:null)},null,8,["modelValue"])]),_:1}),t(F,null,{default:o(()=>[t(v,{disabled:l(I)==="正在查询...",type:"primary",onClick:s[4]||(s[4]=e=>Y(l(N)))},{default:o(()=>[h(Q(l(I)),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})):oe("",!0),g("div",$t,[l($)===1&&l(n).friendlies.length>0&&l(n).abilityFilterEvents.length===0?(E(),j(le,{key:0,class:"player-selection"},{default:o(()=>[t(pe,{data:l(n).friendlies.filter(e=>!["NPC"].includes(e.icon)),stripe:"",border:"",class:"friendlies-table"},{default:o(()=>[t(K,{prop:"name",label:"玩家名称"}),t(K,{label:"职业"},{default:o(({row:e})=>[h(Q(l(ie).nameToFullName(l(ie).jobEnumToJob(l(ie).iconToJobEnum(e.icon))).cn),1)]),_:1}),t(K,{label:"选定",width:"100",align:"center"},{default:o(e=>[t(v,{type:"primary",size:"small",onClick:f=>Z(e.row)},{default:o(()=>[h(" 选择 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):oe("",!0),l($)===2?(E(),j(le,{key:1,class:"ability-filter"},{default:o(()=>[g("div",xt,[t(a,{modelValue:l(n).abilityFilterSelected,"onUpdate:modelValue":s[5]||(s[5]=e=>l(n).abilityFilterSelected=e),multiple:"",placeholder:"选择需要导入的技能","fit-input-width":!0,class:"ability-filter-select"},{default:o(()=>[(E(!0),G(X,null,se(l(n).abilityFilterCandidate,e=>(E(),j(fe,{key:e.actionId,value:e.actionId,label:e.actionName,class:"ability-filter-option"},{default:o(()=>[g("img",{src:l(bt)(`/i/${e.url}.png`),class:"ability-filter-icon",alt:e.actionName,onerror:l(ht)},null,8,Ct),g("span",null,Q(e.actionName),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue"]),t(v,{type:"success",class:"filter-confirm-btn",disabled:!l(P),onClick:te},{default:o(()=>[h(Q(l(P)?"生成时间轴":"加载中..."),1)]),_:1},8,["disabled"])])]),_:1})):oe("",!0)])],64)}}});const It=ve(Et,[["__scopeId","data-v-f1a65b50"]]),ue=k=>(Me("data-v-52d0d6b5"),k=k(),Re(),k),kt=ue(()=>g("h3",{style:{margin:"0",padding:"10px","background-color":"#f5f7fa",cursor:"move"}}," 设置 ",-1)),Bt=ue(()=>g("h3",{class:"form-section-title"}," 参数 ",-1)),Nt=ue(()=>g("h3",{class:"form-section-title"}," 样式 ",-1)),At=ue(()=>g("h3",{class:"form-section-title"}," 测试用例 ",-1)),zt=be({__name:"SettingsDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(k,{emit:O}){const w=k,u=O,T=he();nt(()=>{T.saveTimelineSettings()});const H=je({get:()=>w.modelValue,set:A=>u("update:modelValue",A)}),I=z(-15),N=z([{time:-15,action:"<圣光幕帘>~",show:!0},{time:-2,action:"<圣灵>~",show:!0},{time:0,action:"战斗开始！",show:!0},{time:3,action:"<挑衅>~",show:!0},{time:5,action:"<神圣领域>~",show:!0}]);return(A,c)=>{const $=lt,P=ke,n=ot,B=Oe,Y=Pe,Z=qe,ee=Be,te=Le;return E(),j(te,{modelValue:l(H),"onUpdate:modelValue":c[1]||(c[1]=x=>W(H)?H.value=x:null),modal:!0,overflow:"","close-on-click-modal":!1,"custom-class":"timeline-dialog",width:"600px","append-to-body":!0,draggable:!0},{header:o(()=>[kt]),default:o(()=>[t(ee,{"label-position":"right","label-width":"120px",class:"timeline-form"},{default:o(()=>[Bt,t(B,{gutter:20},{default:o(()=>[(E(!0),G(X,null,se(l(T).configValues,(x,D,C)=>(E(),j(n,{key:C,span:12},{default:o(()=>[t(P,{label:l(T).configTranslate[D]},{default:o(()=>[t($,{modelValue:l(T).configValues[D],"onUpdate:modelValue":s=>l(T).configValues[D]=s,min:0,step:.1,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),Nt,t(B,{gutter:20},{default:o(()=>[(E(!0),G(X,null,se(l(T).showStyle,(x,D,C)=>(E(),j(n,{key:C,span:12},{default:o(()=>[t(P,{label:l(T).showStyleTranslate[D]},{default:o(()=>[t($,{modelValue:l(T).showStyle[D],"onUpdate:modelValue":s=>l(T).showStyle[D]=s,min:0,step:.01,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),At,t(B,{gutter:20},{default:o(()=>[t(Y,{modelValue:l(I),"onUpdate:modelValue":c[0]||(c[0]=x=>W(I)?I.value=x:null),min:-15,max:5,step:.1,"show-input":""},null,8,["modelValue"]),t(Z,{config:l(T).configValues,lines:l(N),runtime:l(I),"show-style":l(T).showStyle},null,8,["config","lines","runtime","show-style"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}});const Ut=ve(zt,[["__scopeId","data-v-52d0d6b5"]]),J=k=>(Me("data-v-e017711e"),k=k(),Re(),k),Dt={class:"alerts-container"},jt={class:"slider-demo-block"},Ot=J(()=>g("span",null,"模拟时间：",-1)),Pt={class:"timeline-info-config"},Lt=J(()=>g("span",null,"显示名称：",-1)),Mt={class:"timeline-info-config"},Rt=J(()=>g("span",null,"限定地图：",-1)),qt={class:"timeline-info-config"},Jt=J(()=>g("span",null,"限定职业：",-1)),Ht={class:"timeline-info-config"},Kt=J(()=>g("span",null,"战斗来源：",-1)),Qt={class:"timeline-info-config"},Wt=J(()=>g("span",null,"创建时间：",-1)),Zt={style:{flex:"1"}},Gt={style:{"max-height":"353px"}},Xt={class:"timeline-timeline-view"},Yt=J(()=>g("br",null,null,-1)),en=J(()=>g("br",null,null,-1)),tn=be({__name:"timelineSettings",setup(k){const{wsConnected:O}=St({allowClose:!0,addWsParam:!0}),w=z(0),u=he(),T=Ve(u,"allTimelines"),H=Ve(u,"filters"),I=[{id:"0",name:"任意"}],N=z(!1),A=z(!1),c=Ce({timeline:{name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}}),$=z([]);let P=null,n=!1;x();async function B(){$.value=[{time:0,action:"正在加载...",show:!0,windowBefore:0,windowAfter:0,alertAlready:!0}],$.value=await yt(c.timeline.timeline)}Y();function Y(){var a,e,f;for(const d in we)if(Object.prototype.hasOwnProperty.call(we,d)){const b=we[d];switch(b.contentType){case 4:case 5:case 28:I.push({id:d,name:((a=b.name)==null?void 0:a.cn)??((e=b.name)==null?void 0:e.ja)??((f=b.name)==null?void 0:f.ja)??d})}}v(),u.sortTimelines()}function Z(a,e={}){Tt({call:"broadcast",source:"soumaTimelineSettings",msg:{type:a,data:e}})}function ee(){N.value=!0,x()}function te(){const a="https://docs.qq.com/sheet/DTWxKT3lFbmpDV3Fm?tab=5ovrc8";window.open(a,"_blank")}function x(){w.value=-30,c.timeline={name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}}function D(){c.timeline=u.allTimelines[u.newTimeline()],B()}function C(a){window.scrollTo({top:0,behavior:"smooth"}),c.timeline=a,B()}function s(a){U.confirm(`确定要删除「${a.name}」吗？`,"删除时间轴",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning"}).then(()=>{x(),T.value.splice(T.value.findIndex(e=>e===a),1)})}function v(){u.loadTimelineSettings()}function S(a){const e=JSON.stringify(a),f=JSON.parse(e);for(const q of f)q.timeline=q.timeline.replace(/^#.*\n/gm,"");const d=JSON.stringify(f),b=de.compressToBase64(e),_=de.compressToBase64(d),V=b.length,R=_.length;if(V===R){xe(b).then(()=>{M({message:"数据复制成功，已写入剪切板。",type:"success",duration:2e3})}).catch(()=>{M({message:"复制失败，请手动复制！",type:"error",duration:3e3})});return}const _e=((V-R)/V*100).toFixed(2);U.confirm(`
     1. 完整版本（包含注释）<br>
     &nbsp;&nbsp;&nbsp;- 大小：${V} 字节<br>
     &nbsp;&nbsp;&nbsp;- 包含所有时间轴信息和注释<br><br>
     2. 优化版本（不含注释）<br>
     &nbsp;&nbsp;&nbsp;- 大小：${R} 字节<br>
     &nbsp;&nbsp;&nbsp;- 节省 ${_e}% 的空间<br>
     &nbsp;&nbsp;&nbsp;- 仅包含必要的时间轴数据`,"请选择导出版本：",{confirmButtonText:"导出优化版本",cancelButtonText:"导出完整版本",distinguishCancelAndClose:!0,closeOnClickModal:!1,closeOnPressEscape:!1,dangerouslyUseHTMLString:!0,showClose:!0,type:"info",callback:q=>{(q==="cancel"||q==="confirm")&&xe(q==="confirm"?_:b).then(()=>{M({message:"压缩数据复制成功，已写入剪切板。",type:"success",duration:2e3})}).catch(()=>{M({message:"复制失败，请手动复制！",type:"error",duration:3e3})})}})}function m(){U.prompt("请输入导出的字符串（支持多行导入）","导入时间轴",{confirmButtonText:"解析",cancelButtonText:"取消",inputType:"textarea",inputValidator:a=>{if(!a)return"请输入导出的字符串";const e=a.split(`
`).filter(d=>d.trim()!=="");let f=[];for(const d of e){let b;try{b=JSON.parse(d)}catch{try{const _=de.decompressFromBase64(d);b=JSON.parse(_)}catch{return`无法解析输入的数据：${d}，请确保每行都是正确的JSON或压缩后的字符串。`}}if(!Array.isArray(b))return`导入的数据格式不正确：${d}`;f=f.concat(b)}return f.length===0?"导入的数据不包含任何时间轴。":!0},inputErrorMessage:"无效的输入"}).then(({value:a})=>{const e=a.split(`
`).filter(_=>_.trim()!=="");let f=[];for(const _ of e){let V;try{V=JSON.parse(_)}catch{const R=de.decompressFromBase64(_);V=JSON.parse(R)}f=f.concat(V)}const d=f.length,b=f.map(_=>`「${_.name}」`).join(", ");U({title:"确认",message:`导入 ${d} 个时间轴：
${b}
？`,showCancelButton:!0,showConfirmButton:!0,confirmButtonText:"追加",cancelButtonText:"覆盖",distinguishCancelAndClose:!0,type:"warning",callback:_=>{_==="cancel"?U.prompt('覆盖操作将删除所有现有的时间轴。请输入"我确认"以继续。',"二次确认",{confirmButtonText:"确定覆盖",cancelButtonText:"取消",inputPattern:/^我确认$/,inputErrorMessage:'请输入"我确认"以确认覆盖操作',type:"warning"}).then(({value:V})=>{V==="我确认"&&p(f,!0)}).catch(()=>{}):_==="confirm"&&p(f,!1)}})}).catch(()=>{})}function p(a,e){e&&(u.allTimelines.length=0),u.allTimelines.push(...a),u.sortTimelines();for(const _ of u.allTimelines)_.condition.jobs===void 0&&(_.condition.jobs=[_.condition.job]);if(x(),e){M({type:"success",message:"覆盖成功！",duration:2e3});return}const f=[],d=new Set;for(const _ of u.allTimelines){const V=JSON.stringify({name:_.name,condition:_.condition,timeline:_.timeline,codeFight:_.codeFight,create:_.create});d.has(V)||(d.add(V),f.push(_))}const b=u.allTimelines.length-f.length;u.allTimelines=f,M({message:`追加成功！共导入 ${a.length} 个时间轴${b>0?`，但其中 ${b} 个重复，已自动移除。`:""}`,type:"success",duration:3e3})}const F=je(()=>`${(w.value<0?"-":"")+(Array(2).join("0")+(Math.floor(w.value/60)+(w.value<0?1:0))).slice(-2)}:${(Array(2).join("0")+Math.floor(w.value%60)).slice(-2)}`);function y(){c.timeline.timeline=c.timeline.timeline.replaceAll(new RegExp("(?<=^|#\\s*)(?<time>[:：\\d.]+)","gm"),(a,e)=>/^\d+:\d+(?:\.\d{1,2})?$/.test(a.toString())?$e.duration(`00:${a.toString()}`).as("seconds").toString():$e.utc(Number.parseFloat(a.toString())*1e3).format("mm:ss.S"))}function ne(){const a=Ft.resolve({path:"/timelineHelp"}).href;window.open(a,"_blank")}function me(a){u.configValues=a.configValues,u.showStyle=a.showStyle}const le=a=>{if(a.source==="soumaTimeline"&&a.msg.type==="post"){n=!1,P.close();const e=a.msg.data;for(const f of e.allTimelines)f.condition.jobs===void 0&&(f.condition.jobs=[f.condition.job]),f.condition.jobs.sort((d,b)=>u.jobList.indexOf(d)-u.jobList.indexOf(b)),Reflect.deleteProperty(f.condition,"job");u.allTimelines=e.allTimelines,u.configValues=e.configValues,u.showStyle=e.showStyle,M.closeAll(),M({message:"数据获取成功",type:"success",duration:3e3})}};function K(){n=!0,P=ct.service({lock:!0,text:"正在请求数据，请确保 ACT 与悬浮窗已开启...，若 10 秒内仍未获取到数据，请检查 ACT 状态，且确认 timeline 悬浮窗已开启，或刷新页面重连。",background:"rgba(0, 0, 0, 0.7)"}),Z("get"),setTimeout(()=>{n&&(M.info("重新尝试获取数据..."),K())},5e3)}function pe(){U.confirm("你确定要将当前数据发送至 ACT 悬浮窗吗？悬浮窗中的内容将会被覆盖！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{Z("post",u.$state)})}function fe(){x(),K()}return it(()=>{vt("BroadcastMessage",le);const a=st(O,e=>{e&&(u.allTimelines.length===0&&K(),a())})}),(a,e)=>{const f=Ut,d=Ee,b=dt,_=ut,V=Oe,R=mt,_e=pt,q=It,Te=Le,Je=Pe,ae=Ie,Fe=De,Se=Ue,He=qe,ge=Ne,re=Ae,Ke=ze,Qe=ft,We=_t,Ze=gt;return E(),j(Ze,{class:"container"},{default:o(()=>[t(f,{modelValue:l(A),"onUpdate:modelValue":e[0]||(e[0]=r=>W(A)?A.value=r:null),onSave:me},null,8,["modelValue"]),t(_e,{class:"flex-header"},{default:o(()=>[t(V,{justify:"space-between",align:"middle","m-b-2":""},{default:o(()=>[t(_,{wrap:"",size:10},{default:o(()=>[t(b,null,{default:o(()=>[t(d,{type:"primary",size:"small",onClick:ee},{default:o(()=>[h(" 从 FFlogs 生成 ")]),_:1}),t(d,{type:"primary",size:"small",onClick:te},{default:o(()=>[h(" 从 在线文档 获取 ")]),_:1}),t(d,{type:"primary",size:"small",onClick:D},{default:o(()=>[h(" 手动编写 ")]),_:1})]),_:1}),t(b,null,{default:o(()=>[t(d,{size:"small",onClick:m},{default:o(()=>[h(" 导入字符串 ")]),_:1}),t(d,{size:"small",class:"export",onClick:e[1]||(e[1]=r=>S(l(T)))},{default:o(()=>[h(" 导出全部 ")]),_:1})]),_:1}),t(d,{size:"small",onClick:ne},{default:o(()=>[h(" 时间轴语法 ")]),_:1}),t(d,{type:"success",size:"small",onClick:pe},{default:o(()=>[h(" 应用 ")]),_:1})]),_:1}),t(_,null,{default:o(()=>[t(d,{color:"#a0d911",style:{color:"white"},size:"small",onClick:fe},{default:o(()=>[h(" 恢复至之前的时间轴 ")]),_:1}),t(d,{color:"#626aef",style:{color:"white"},size:"small",onClick:e[2]||(e[2]=r=>A.value=!0)},{default:o(()=>[h(" 设置 ")]),_:1})]),_:1})]),_:1}),g("div",Dt,[t(R,{title:"编辑完成后,需手动点击「应用」按钮","show-icon":"",type:"info",closable:!1,class:"alert-item"}),t(R,{title:"当你误操作或数据与 ACT 悬浮窗中的数据不符，且尚未点击「应用」时，可点击「恢复至之前的时间轴」，则会恢复到当前 ACT 悬浮窗中保存的数据","show-icon":"",type:"warning",closable:!1,class:"alert-item"})])]),_:1}),t(We,null,{default:o(()=>[t(Te,{modelValue:l(N),"onUpdate:modelValue":e[4]||(e[4]=r=>W(N)?N.value=r:null),title:"从 FFlogs 生成时间轴",width:"80%","before-close":()=>N.value=!1},{default:o(()=>[t(q,{filters:l(H),onClearCurrentlyTimeline:x,onShowFFlogsToggle:e[3]||(e[3]=()=>N.value=!1),onNewTimeline:l(u).newTimeline,onUpdateFilters:l(u).updateFilters},null,8,["filters","onNewTimeline","onUpdateFilters"])]),_:1},8,["modelValue","before-close"]),at(t(ge,null,{default:o(()=>[g("div",jt,[Ot,t(Je,{modelValue:l(w),"onUpdate:modelValue":e[5]||(e[5]=r=>W(w)?w.value=r:null),min:-30,max:1500,step:.1,"show-input":""},null,8,["modelValue"]),g("div",null,Q(l(F)),1)]),t(V,{class:"timeline-info"},{default:o(()=>[g("div",null,[g("p",Pt,[Lt,t(ae,{modelValue:l(c).timeline.name,"onUpdate:modelValue":e[6]||(e[6]=r=>l(c).timeline.name=r),class:"timeline-info-name"},null,8,["modelValue"])]),g("p",Mt,[Rt,t(Se,{modelValue:l(c).timeline.condition.zoneId,"onUpdate:modelValue":e[7]||(e[7]=r=>l(c).timeline.condition.zoneId=r),filterable:""},{default:o(()=>[(E(),G(X,null,se(I,r=>t(Fe,{key:r.id,label:r.name,value:r.id},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),g("p",qt,[Jt,t(Se,{modelValue:l(c).timeline.condition.jobs,"onUpdate:modelValue":e[8]||(e[8]=r=>l(c).timeline.condition.jobs=r),multiple:"",required:"",placeholder:"职业","collapse-tags":"","collapse-tags-tooltip":""},{default:o(()=>[(E(!0),G(X,null,se(l(u).jobList,r=>{var L;return E(),j(Fe,{key:r,label:(((L=l(ie).nameToFullName(r))==null?void 0:L.cn)??r).replace("冒险者","全部职业"),value:r},null,8,["label","value"])}),128))]),_:1},8,["modelValue"])]),g("p",Ht,[Kt,t(ae,{modelValue:l(c).timeline.codeFight,"onUpdate:modelValue":e[9]||(e[9]=r=>l(c).timeline.codeFight=r),disabled:""},null,8,["modelValue"])]),g("p",Qt,[Wt,t(ae,{modelValue:l(c).timeline.create,"onUpdate:modelValue":e[10]||(e[10]=r=>l(c).timeline.create=r),disabled:""},null,8,["modelValue"])]),t(V,{"m-b-10px":""},{default:o(()=>[t(d,{span:12,class:"export",onClick:e[11]||(e[11]=r=>S([l(c).timeline]))},{default:o(()=>[h(" 单独导出 ")]),_:1}),t(d,{type:"primary",span:12,onClick:e[12]||(e[12]=r=>y())},{default:o(()=>[h(" 切换时间 ")]),_:1})]),_:1}),t(V,null,{default:o(()=>[t(d,{span:24,onClick:e[13]||(e[13]=r=>x())},{default:o(()=>[h(" 隐藏编辑界面 ")]),_:1})]),_:1})]),g("div",Zt,[t(ae,{modelValue:l(c).timeline.timeline,"onUpdate:modelValue":e[14]||(e[14]=r=>l(c).timeline.timeline=r),class:"timeline-timeline-raw",type:"textarea",rows:12,wrap:"off",placeholder:"请键入时间轴文本",style:{"max-width":"569px"},onChange:e[15]||(e[15]=r=>B())},null,8,["modelValue"])]),g("div",Gt,[g("div",Xt,[t(He,{config:l(u).configValues,lines:l($),runtime:l(w),"show-style":l(u).showStyle},null,8,["config","lines","runtime","show-style"])])])]),_:1}),Yt]),_:1},512),[[rt,l(c).timeline.create!=="空"]]),en,l(T).length>0?(E(),j(ge,{key:0},{default:o(()=>[t(Ke,{data:l(T),style:{width:"100%"},stripe:""},{default:o(()=>[t(re,{prop:"name",label:"名称"}),t(re,{prop:"conditon",label:"地图",sortable:""},{default:o(r=>{var L;return[h(Q((L=I.find(ce=>ce.id===r.row.condition.zoneId))==null?void 0:L.name),1)]}),_:1}),t(re,{prop:"conditon",label:"职业"},{default:o(r=>[h(Q(r.row.condition.jobs.map(L=>{var ce;return((ce=l(ie).nameToFullName(L.toUpperCase()))==null?void 0:ce.cn)??L}).join("、").replace("冒险者","全部职业")),1)]),_:1}),t(re,{fixed:"right",label:"操作",width:"150"},{default:o(r=>[t(d,{type:"primary",size:"small",onClick:L=>C(r.row)},{default:o(()=>[h(" 编辑 ")]),_:2},1032,["onClick"]),t(d,{type:"danger",size:"small",onClick:L=>s(r.row)},{default:o(()=>[h(" 删除 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):oe("",!0),l(T).length===0?(E(),j(ge,{key:1},{default:o(()=>[t(Qe,{description:"点击上方新建或导入一个时间轴吧~"})]),_:1})):oe("",!0)]),_:1})]),_:1})}}});const fn=ve(tn,[["__scopeId","data-v-e017711e"]]);export{fn as default};
