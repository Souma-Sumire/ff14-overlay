import{R as O,x as E,v as w,d as j,o as u,b as m,G as T,H as x,u as n,c as F,w as f,f as D,t as P,O as k,P as G,g as $,aC as z,p as B,j as Q,Y as R,F as I,B as U,C as V,D as J,a as h,h as Y,i as q,e as W,M as K}from"./vendor-ce6ce513.js";import{p as C}from"./queryParams-77a1fad5.js";import{U as b}from"./util-f6d3a594.js";import{p as X,a as Z,b as tt}from"./xivapi-40ad3cc5.js";import{c as et,a as v}from"./overlay_plugin_api-9faadcd6.js";import{_ as L}from"./index-3dd5b169.js";const N=["tank","healer","dps","crafter","gatherer","none"],H=[24283,24284,24285,24286,24287,24288,24289,24290,24294,24295,24296,24297,24298,24299,24300,24301,24302,24303,24304,24305,24306,24307,24309,24310,24311,24312,24313,24315,24316,24317,24318],A=O("castingMonitor",{state:()=>{var t;return{castData:E({}),playerId:w(""),focusTargetId:w(""),partyData:[],config:{duration:Number(((t=C)==null?void 0:t.duration)||25)},lastPush:Date.now()}},getters:{partyDataFormatted(t){return t.partyData.sort((e,i)=>N.indexOf(b.jobToRole(b.jobEnumToJob(e.job)))-N.indexOf(b.jobToRole(b.jobEnumToJob(i.job))))},focusTargetCastArr(t){var e;return((e=t.castData)==null?void 0:e[t.focusTargetId])??[]}},actions:{testAction(){const t=H[Math.floor(Math.random()*H.length)];this.pushAction(Date.now(),14,"贤者技能随机",this.focusTargetId,t,1),setTimeout(()=>{this.pushAction(Date.now(),15,"贤者技能随机",this.focusTargetId,t)},1e3)},testItem(){this.pushAction(Date.now(),15,"item_11c7",this.focusTargetId,33558983)},testItemHQ(){this.pushAction(Date.now(),15,"item_f5407",this.focusTargetId,34558983)},testParty(t){this.handlePartyChanged({party:t?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0}]:[]})},async pushAction(t,e,i,s,p,r){var _;const d=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test((_=C)==null?void 0:_.energySaving);let c=p;if(this.partyData.length===0&&s===this.playerId||d&&s===this.focusTargetId||!d&&this.partyData.length>0&&this.partyData.find(a=>a.id===s)){let a,y=!1;/^(?:item|mount)_/.test(i)?(c=Number.parseInt(i.replace(/^.+_/,""),16),c>983040&&(c=Number.parseInt(c.toString().slice(-5),10),y=!0),a=i.replace(/_.+$/,"")):a="action",this.castData[s]||(this.castData[s]=[]);const g=Symbol();this.castData[s].push({time:t,logLine:e,src:"",class:"",key:g,APIData:{}}),this.lastPush=Date.now();const o=this.castData[s].find(l=>l.key===g);if(!o)return;if(setTimeout(()=>{var l;(l=this.castData[s])==null||l.splice(this.castData[s].indexOf(o),1)},(r||this.config.duration)*1e3),/^unknown_/.test(i))o.src="https://cafemaker.wakingsands.com/i/000000/000405.png",o.class="action action-category-0";else if(c<1e5){const l=await X(a,c,["ID","Icon","ActionCategoryTargetID","Name","Description"]);if(o.APIData=l,o.src=await Z((l==null?void 0:l.Icon)??"",y),a==="action"?o.class=`action action-category-${l==null?void 0:l.ActionCategoryTargetID}`:a==="item"?o.class=`item${y?"HQ":""}`:a==="mount"&&(o.class="mount"),l.ActionCategoryTargetID===2||l.ActionCategoryTargetID===3){const M=this.castData[s].filter(S=>/action-category-[23]/.test(S.class)&&S.logLine!==14).at(-2);M&&(o.GCDCast=((o.time-M.time)/1e3).toFixed(2),Number.parseFloat(o.GCDCast)>=2.55&&(o.GCDClass="wasted"))}}}},handleChangePrimaryPlayer(t){this.playerId=t.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(t){t.line[0]==="20"?this.pushAction(Date.parse(t.line[1]),14,t.line[5],t.line[2],Number.parseInt(t.line[4],16),Number(t.line[8])):(t.line[0]==="21"||t.line[0]==="22"&&t.line[45]==="0")&&this.pushAction(Date.parse(t.line[1]),15,t.line[5],t.line[2],Number.parseInt(t.line[4],16))},handlePartyChanged(t){if(t.party.length>0){this.partyData=t.party.filter(e=>e.inParty).map(e=>({...e,src:""}));for(const e in this.castData)Object.prototype.hasOwnProperty.call(this.castData,e)&&(this.partyData.find(i=>i.id===e)||Reflect.deleteProperty(this.castData,e));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(t){var e;t===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=t,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test((e=C)==null?void 0:e.syncFocusWS)&&et({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})}}}),at=t=>(B("data-v-600e68a5"),t=t(),Q(),t),st={"w-100vw":"",flex:"~ nowrap",class:"main"},ot=["data-casterId"],nt={class:"elhover"},it=["innerHTML"],rt=["src"],lt=at(()=>D("img",{class:"frame",loading:"lazy"},null,-1)),ct=j({__name:"Main",setup(t){const e=A(),i=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(C.displayAA)),s=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(C.displayGCDSpace));return(p,r)=>{const d=z;return u(),m("div",st,[(u(!0),m(T,null,x(n(e).castData,(c,_)=>(u(),m("div",{key:_,"data-casterId":_},[(u(!0),m(T,null,x(c,a=>(u(),F(d,{"raw-content":"",placement:"right-start",effect:"dark",transition:"",teleported:!1,"popper-class":"el-tooltip","show-arrow":!1,key:a.key},{content:f(()=>{var y;return[D("div",nt,[D("strong",null,P(a.APIData.Name),1),D("div",{innerHTML:(y=a.APIData)==null?void 0:y.Description,style:{"white-space":"pre-line"}},null,8,it)])]}),default:f(()=>[D("div",{class:k(`images ${a.class} logLine${a.logLine} displayAA${n(i)} displayGCD${n(s)}`),style:G(`--animeDuration: ${n(e).config.duration}s;opacity:${+(n(e).focusTargetId===_)}`)},[D("img",{src:a.src,class:"action-icon",height:"40",loading:"lazy"},null,8,rt),lt,n(s)===1?(u(),m("span",{key:0,class:k(["GCDCast",a.GCDClass])},P((a==null?void 0:a.GCDCast)??""),3)):$("",!0)],6)]),_:2},1024))),128))],8,ot))),128))])}}});const dt=L(ct,[["__scopeId","data-v-600e68a5"]]),ut={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},pt=["onClick"],ht={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},ft=["src"],mt=j({__name:"Header",setup(t){var s;const e=A();R(()=>{for(const p of e.partyData)p.src=tt(p.job)});const i=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test((s=C)==null?void 0:s.showHeader);return(p,r)=>n(i)?(u(),m("div",ut,[(u(!0),m(T,null,x(n(e).partyDataFormatted,(d,c)=>(u(),m("button",{key:c,onClick:_=>n(e).handleClickChangeTarget(d.id),class:k(["job-lists",n(e).focusTargetId===d.id?"job-lists-focus":""]),"p-0":"","m-0":""},[D("div",ht,[D("img",{src:d.src,style:{height:"1.25em"},loading:"lazy"},null,8,ft),I(" "+P(n(b).nameToFullName(n(b).jobEnumToJob(d.job)).simple2),1)])],10,pt))),128))])):$("",!0)}});const _t={class:"common-layout"},yt={key:0},gt=j({__name:"castingMonitor",setup(t){const e=A(),i=location.href.indexOf("localhost")>-1;U(()=>{v("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),v("LogLine",e.handleLogLine),v("PartyChanged",e.handlePartyChanged),v("BroadcastMessage",p=>{p.source==="castMonitorOverlay"&&(e.focusTargetId=p.msg.targetId)}),startOverlayEvents()});const s=w(!1);return setInterval(()=>{s.value=Date.now()-e.lastPush<e.config.duration*2*1e3},1e3),(p,r)=>{const d=mt,c=Y,_=dt,a=q,y=W,g=K;return V((u(),m("div",_t,[h(y,{"items-center":""},{default:f(()=>[h(c,{class:"header-layout"},{default:f(()=>[h(d)]),_:1}),h(a,{"p-0":""},{default:f(()=>[h(_)]),_:1})]),_:1}),i?(u(),m("footer",yt,[h(g,{onClick:r[0]||(r[0]=o=>n(e).testParty(!0))},{default:f(()=>[I("虚假小队")]),_:1}),h(g,{onClick:r[1]||(r[1]=o=>n(e).testParty(!1))},{default:f(()=>[I("单人")]),_:1}),h(g,{onClick:r[2]||(r[2]=o=>n(e).testAction())},{default:f(()=>[I("Action")]),_:1}),h(g,{onClick:r[3]||(r[3]=o=>n(e).testItem())},{default:f(()=>[I("Item")]),_:1}),h(g,{onClick:r[4]||(r[4]=o=>n(e).testItemHQ())},{default:f(()=>[I("ItemHQ")]),_:1})])):$("",!0)],512)),[[J,n(s)]])}}});const Tt=L(gt,[["__scopeId","data-v-2f7502ba"]]);export{Tt as default};
