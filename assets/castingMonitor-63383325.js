import{U as E,B as F,A as C,d as x,o as h,b as g,J as v,K as T,u as o,c as O,w as m,g as _,t as P,R as k,S as G,i as j,aF as U,p as z,l as B,a0 as R,I,F as Q,h as J,H as V,a as f,j as W,k as Y,e as q,P as K}from"./vendor-e39bbd45.js";import{c as X,a as b}from"./overlay_plugin_api-409cb9ea.js";import{U as D}from"./util-ef9ccf87.js";import{p as Z,a as tt,h as M,b as et}from"./xivapi-2de896fe.js";import{_ as H}from"./index-08753312.js";const w=new URLSearchParams(window.location.href.split("?")[1]),L=["tank","healer","dps","crafter","gatherer","none"],N=[34563,34564,34565,34566,34567,34568,34569,34570,34571,34572,34573,34574,34575,34576,34577,34578,34579,34580,34581,34582],$=E("castingMonitor",{state:()=>({castData:F({}),playerId:C(""),focusTargetId:C(""),partyData:[],config:{duration:Number(w.get("duration")||25)},lastPush:Date.now()}),getters:{partyDataFormatted(t){return t.partyData.sort((e,s)=>L.indexOf(D.jobToRole(D.jobEnumToJob(e.job)))-L.indexOf(D.jobToRole(D.jobEnumToJob(s.job))))},focusTargetCastArr(t){var e;return((e=t.castData)==null?void 0:e[t.focusTargetId])??[]}},actions:{testAction(){const t=N[Math.floor(Math.random()*N.length)];this.pushAction(Date.now(),15,"青魔技能随机",this.focusTargetId,t)},testItem(){this.pushAction(Date.now(),15,"item_11c7",this.focusTargetId,33558983)},testItemHQ(){this.pushAction(Date.now(),15,"item_f5407",this.focusTargetId,34558983)},testParty(t){this.handlePartyChanged({party:t?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0}]:[]})},async pushAction(t,e,s,r,d,l){const u=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(w.get("energySaving")||"");let p=d;if(this.partyData.length===0&&r===this.playerId||u&&r===this.focusTargetId||!u&&this.partyData.length>0&&this.partyData.find(c=>c.id===r)){let c,y=!1;/^(?:item|mount)_/.test(s)?(p=Number.parseInt(s.replace(/^.+_/,""),16),p>983040&&(p=Number.parseInt(p.toString().slice(-5),10),y=!0),c=s.replace(/_.+$/,"")):c="action",this.castData[r]||(this.castData[r]=[]);const i=Symbol("cast");this.castData[r].push({time:t,logLine:e,src:"",class:"",key:i,APIData:{}}),this.lastPush=Date.now();const a=this.castData[r].find(n=>n.key===i);if(!a)return;if(setTimeout(()=>{var n;(n=this.castData[r])==null||n.splice(this.castData[r].indexOf(a),1)},(l||this.config.duration)*1e3),s.startsWith("unknown_"))a.src="https://cafemaker.wakingsands.com/i/000000/000405.png",a.class="action action-category-0";else if(p<1e5){const n=await Z(c,p,["ID","Icon","ActionCategoryTargetID","Name","Description"]);if(a.APIData=n,a.src=await tt((n==null?void 0:n.Icon)??"",y),c==="action"?a.class=`action action-category-${n==null?void 0:n.ActionCategoryTargetID}`:c==="item"?a.class=`item${y?"HQ":""}`:c==="mount"&&(a.class="mount"),n.ActionCategoryTargetID===2||n.ActionCategoryTargetID===3){const A=this.castData[r].filter(S=>/action-category-[23]/.test(S.class)&&S.logLine!==14).at(-2);A&&(a.GCDCast=((a.time-A.time)/1e3).toFixed(2),Number.parseFloat(a.GCDCast)>=2.55&&(a.GCDClass="wasted"))}}}},handleChangePrimaryPlayer(t){this.playerId=t.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(t){t.line[0]==="20"?this.pushAction(Date.parse(t.line[1]),14,t.line[5],t.line[2],Number.parseInt(t.line[4],16),Number(t.line[8])):(t.line[0]==="21"||t.line[0]==="22"&&t.line[45]==="0")&&this.pushAction(Date.parse(t.line[1]),15,t.line[5],t.line[2],Number.parseInt(t.line[4],16))},handlePartyChanged(t){if(t.party.length>0){this.partyData=t.party.filter(e=>e.inParty).map(e=>({...e,src:""}));for(const e in this.castData)Object.prototype.hasOwnProperty.call(this.castData,e)&&(this.partyData.find(s=>s.id===e)||Reflect.deleteProperty(this.castData,e));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(t){t===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=t,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(w.get("syncFocusWS")||"")&&X({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})}}}),at=t=>(z("data-v-567f7838"),t=t(),B(),t),ot={"w-100vw":"",flex:"~ nowrap",class:"main"},st=["data-casterId"],nt={class:"elhover"},rt=["innerHTML"],it=["src"],lt=at(()=>_("img",{class:"frame",loading:"lazy"},null,-1)),ct=x({__name:"Main",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),s=$(),r=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(e.get("displayAA")??"")),d=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(e.get("displayGCD")??""));return(l,u)=>{const p=U;return h(),g("div",ot,[(h(!0),g(v,null,T(o(s).castData,(c,y)=>(h(),g("div",{key:y,"data-casterId":y},[(h(!0),g(v,null,T(c,i=>(h(),O(p,{key:i.key,"raw-content":"",placement:"right-start",effect:"dark",transition:"",teleported:!1,"popper-class":"el-tooltip","show-arrow":!1},{content:m(()=>{var a;return[_("div",nt,[_("strong",null,P(i.APIData.Name),1),_("div",{style:{"white-space":"pre-line"},innerHTML:(a=i.APIData)==null?void 0:a.Description},null,8,rt)])]}),default:m(()=>[_("div",{class:k(`images ${i.class} logLine${i.logLine} displayAA${o(r)} displayGCD${o(d)}`),style:G(`--animeDuration: ${o(s).config.duration}s;opacity:${+(o(s).focusTargetId===y)}`)},[_("img",{src:i.src,class:"action-icon",height:"40",loading:"lazy",onError:u[0]||(u[0]=(...a)=>o(M)&&o(M)(...a))},null,40,it),lt,o(d)===1?(h(),g("span",{key:0,class:k(["GCDCast",i.GCDClass])},P((i==null?void 0:i.GCDCast)??""),3)):j("",!0)],6)]),_:2},1024))),128))],8,st))),128))])}}});const dt=H(ct,[["__scopeId","data-v-567f7838"]]),ut={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},pt=["onClick"],ht={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},ft=["src"],mt=x({__name:"Header",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),s=$();R(()=>{for(const d of s.partyData)d.src=et(d.job)});const r=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(e.get("showHeader")||"false");return(d,l)=>o(r)?(h(),g("div",ut,[(h(!0),g(v,null,T(o(s).partyDataFormatted,(u,p)=>(h(),g("button",{key:p,class:k(["job-lists",o(s).focusTargetId===u.id?"job-lists-focus":""]),"m-0":"","p-0":"",onClick:c=>o(s).handleClickChangeTarget(u.id)},[_("div",ht,[_("img",{src:u.src,style:{height:"1.25em"},loading:"lazy"},null,8,ft),I(" "+P(o(D).nameToFullName(o(D).jobEnumToJob(u.job)).simple2),1)])],10,pt))),128))])):j("",!0)}});const gt={class:"common-layout"},yt={key:0},_t=x({__name:"castingMonitor",setup(t){const e=$(),s=location.href.includes("localhost");Q(()=>{b("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),b("LogLine",e.handleLogLine),b("PartyChanged",e.handlePartyChanged),b("BroadcastMessage",d=>{d.source==="castMonitorOverlay"&&(e.focusTargetId=d.msg.targetId)})});const r=C(!1);return setInterval(()=>{r.value=Date.now()-e.lastPush<e.config.duration*2*1e3},1e3),(d,l)=>{const u=mt,p=W,c=dt,y=Y,i=q,a=K;return J((h(),g("div",gt,[f(i,{"items-center":""},{default:m(()=>[f(p,{class:"header-layout"},{default:m(()=>[f(u)]),_:1}),f(y,{"p-0":""},{default:m(()=>[f(c)]),_:1})]),_:1}),o(s)?(h(),g("footer",yt,[f(a,{onClick:l[0]||(l[0]=n=>o(e).testParty(!0))},{default:m(()=>[I(" 虚假小队 ")]),_:1}),f(a,{onClick:l[1]||(l[1]=n=>o(e).testParty(!1))},{default:m(()=>[I(" 单人 ")]),_:1}),f(a,{onClick:l[2]||(l[2]=n=>o(e).testAction())},{default:m(()=>[I(" Action ")]),_:1}),f(a,{onClick:l[3]||(l[3]=n=>o(e).testItem())},{default:m(()=>[I(" Item ")]),_:1}),f(a,{onClick:l[4]||(l[4]=n=>o(e).testItemHQ())},{default:m(()=>[I(" ItemHQ ")]),_:1})])):j("",!0)],512)),[[V,o(r)]])}}});const vt=H(_t,[["__scopeId","data-v-8d0ae53f"]]);export{vt as default};
