{"version":3,"file":"xivapi.js","sources":["../../../src/utils/xivapi.ts"],"sourcesContent":["import { params } from \"@/utils/queryParams\";\nimport Util from \"./util\";\n\nconst { api } = params;\n\nconst siteList = {\n  cafe: \"https://cafemaker.wakingsands.com\",\n  xivapi: \"https://xivapi.com\",\n};\n\nconst site: { first: string; second: string } = {\n  first: api?.toLowerCase() === \"xivapi\" ? siteList.xivapi : siteList.cafe,\n  second: api?.toLowerCase() === \"xivapi\" ? siteList.cafe : siteList.xivapi,\n};\n\ninterface CachedImage {\n  url: string;\n  expirationTime: number;\n}\n\ninterface CachedAction {\n  name: string;\n  action: any;\n  expirationTime: number;\n}\n\nconst cacheExpirationTime = {\n  get random() {\n    return Math.floor(Math.random() * 86400000 * 11) + 86400000 * 25;\n  },\n};\n\nconst userAction = new Map(\n  Object.entries({\n    任务指令: \"/i/000000/000123.png\",\n    冲刺: \"/i/000000/000104.png\",\n    坐骑: \"/i/000000/000118.png\",\n    攻击: \"/i/000000/000101.png\",\n    腐秽大地: \"/i/003000/003090.png\",\n  }),\n);\n\nconst IMG_CACHE_KEY = \"souma-img-cache\";\nconst ACTION_CACHE_KEY = \"souma-action-cache\";\n\nconst rejectImageData: CachedImage[] = JSON.parse(localStorage.getItem(IMG_CACHE_KEY) || \"[]\");\nconst cachedActionData: CachedAction[] = JSON.parse(localStorage.getItem(ACTION_CACHE_KEY) || \"[]\");\nconst currentTime = Date.now();\nconst MAX_CACHE_LENGTH = 1000;\nconst updatedImageData = rejectImageData.filter((v, index) => v.expirationTime >= currentTime && index < MAX_CACHE_LENGTH);\nconst updatedActionData = cachedActionData.filter((v, index) => v.expirationTime >= currentTime && index < MAX_CACHE_LENGTH);\nlocalStorage.setItem(IMG_CACHE_KEY, JSON.stringify(updatedImageData));\nlocalStorage.setItem(ACTION_CACHE_KEY, JSON.stringify(updatedActionData));\n\nconst ICON_REGEX = /(\\d{6})\\/(\\d{6})\\.png$/;\n\nexport async function parseAction(\n  type: \"item\" | \"action\" | \"mount\" | string,\n  actionId: number,\n  columns: (keyof XivApiJson)[] = [\"ID\", \"Icon\", \"ActionCategoryTargetID\"],\n) {\n  const urls = generateActionUrls(type, actionId, columns);\n  try {\n    const response = await requestPromise(urls, { mode: \"cors\" });\n    return await response.json();\n  } catch (error) {\n    console.error(`Failed to parse action: ${error}`);\n    return { ActionCategoryTargetID: 0, ID: actionId, Icon: \"/i/000000/000405.png\" };\n  }\n}\n\nfunction generateActionUrls(type: string, actionId: number, columns: (keyof XivApiJson)[]) {\n  const urlTemplate = `${site.first}/${type}/${actionId}?columns=${columns.join(\",\")}`;\n  return [urlTemplate, urlTemplate.replace(site.first, site.second)];\n}\n\nexport async function getFullImgSrc(icon: string, itemIsHQ = false) {\n  const url = `${site.first}${icon}`;\n  return url.replace(ICON_REGEX, (_match, p1, p2) => `${p1}/${itemIsHQ ? \"hq/\" : \"\"}${p2}.png`);\n}\n\nexport function getClassjobIconSrc(jobEnum: number): string {\n  const job = Util.jobEnumToJob(jobEnum);\n  const fullName = Util.nameToFullName(job);\n  return `${site.first}/cj/companion/${fullName.en.toLowerCase().replaceAll(/\\s/g, \"\")}.png`;\n}\n\nexport async function getImgSrcByActionId(id: number): Promise<string> {\n  const res = await parseAction(\"action\", id, [\"Icon\"]);\n  return getFullImgSrc(res.Icon);\n}\n\nexport async function getActionByChineseName(name: string) {\n  const customAction = userAction.get(name);\n  if (customAction) {\n    return { ActionCategoryTargetID: 0, ID: 0, Icon: customAction };\n  }\n\n  const cachedAction = cachedActionData.find((v) => v.name === name);\n  if (cachedAction?.action) {\n    return cachedAction.action;\n  }\n\n  try {\n    const response = await requestPromise([`${siteList.cafe}/search?filters=ClassJobLevel>0&indexes=action&string=${encodeURIComponent(name)}`]);\n    const searchData = await response.json();\n    const result = searchData.Results?.[0];\n\n    if (result) {\n      const expirationTime = Date.now() + cacheExpirationTime.random;\n      const newCachedAction: CachedAction = {\n        name: name,\n        action: result,\n        expirationTime,\n      };\n      cachedActionData.push(newCachedAction);\n      localStorage.setItem(\"souma-action-cache\", JSON.stringify(cachedActionData));\n      return result;\n    } else {\n      return { ActionCategoryTargetID: 0, ID: 0, Icon: \"/i/000000/000405.png\" };\n    }\n  } catch (error) {\n    console.error(`Failed to get action by name: ${error}`);\n    throw new Error(\"Failed to retrieve action data\");\n  }\n}\n\nasync function timeoutPromise<T>(promise: Promise<T>, timeout: number): Promise<T> {\n  let timeoutId: NodeJS.Timer;\n  const timeoutPromise = new Promise<T>((_, reject) => {\n    timeoutId = setTimeout(() => {\n      reject(new Error(\"Promise timed out\"));\n    }, timeout);\n  });\n  return Promise.race([promise, timeoutPromise]).finally(() => {\n    clearTimeout(timeoutId);\n  });\n}\n\nasync function requestPromise(urls: string[], options?: RequestInit): Promise<Response> {\n  const _options = Object.assign({ cache: \"force-cache\" }, options);\n  for (const url of urls) {\n    try {\n      const response = await timeoutPromise(fetch(url, _options), 3000);\n      if (response.ok) {\n        return response;\n      }\n    } catch (err) {\n      console.error(`Failed to fetch ${url}: ${err}`);\n    }\n  }\n  throw new Error(\"All fetch attempts failed.\");\n}\n"],"names":["api","params","siteList","site","cacheExpirationTime","userAction","IMG_CACHE_KEY","ACTION_CACHE_KEY","rejectImageData","cachedActionData","currentTime","MAX_CACHE_LENGTH","updatedImageData","v","index","updatedActionData","ICON_REGEX","parseAction","type","actionId","columns","urls","generateActionUrls","requestPromise","error","urlTemplate","getFullImgSrc","icon","itemIsHQ","_match","p1","p2","getClassjobIconSrc","jobEnum","job","Util","fullName","getImgSrcByActionId","id","res","getActionByChineseName","name","customAction","cachedAction","result","_a","expirationTime","newCachedAction","timeoutPromise","promise","timeout","timeoutId","_","reject","options","_options","url","response","err"],"mappings":"mEAGA,KAAM,CAAE,IAAAA,CAAQ,EAAAC,EAEVC,EAAW,CACf,KAAM,oCACN,OAAQ,oBACV,EAEMC,EAA0C,CAC9C,OAAOH,GAAA,YAAAA,EAAK,iBAAkB,SAAWE,EAAS,OAASA,EAAS,KACpE,QAAQF,GAAA,YAAAA,EAAK,iBAAkB,SAAWE,EAAS,KAAOA,EAAS,MACrE,EAaME,EAAsB,CAC1B,IAAI,QAAS,CACJ,OAAA,KAAK,MAAM,KAAK,OAAA,EAAW,MAAW,EAAE,EAAI,MAAW,EAChE,CACF,EAEMC,EAAa,IAAI,IACrB,OAAO,QAAQ,CACb,KAAM,uBACN,GAAI,uBACJ,GAAI,uBACJ,GAAI,uBACJ,KAAM,sBAAA,CACP,CACH,EAEMC,EAAgB,kBAChBC,EAAmB,qBAEnBC,EAAiC,KAAK,MAAM,aAAa,QAAQF,CAAa,GAAK,IAAI,EACvFG,EAAmC,KAAK,MAAM,aAAa,QAAQF,CAAgB,GAAK,IAAI,EAC5FG,EAAc,KAAK,MACnBC,EAAmB,IACnBC,EAAmBJ,EAAgB,OAAO,CAACK,EAAGC,IAAUD,EAAE,gBAAkBH,GAAeI,EAAQH,CAAgB,EACnHI,EAAoBN,EAAiB,OAAO,CAACI,EAAGC,IAAUD,EAAE,gBAAkBH,GAAeI,EAAQH,CAAgB,EAC3H,aAAa,QAAQL,EAAe,KAAK,UAAUM,CAAgB,CAAC,EACpE,aAAa,QAAQL,EAAkB,KAAK,UAAUQ,CAAiB,CAAC,EAExE,MAAMC,EAAa,yBAEG,eAAAC,EACpBC,EACAC,EACAC,EAAgC,CAAC,KAAM,OAAQ,wBAAwB,EACvE,CACA,MAAMC,EAAOC,EAAmBJ,EAAMC,EAAUC,CAAO,EACnD,GAAA,CAEK,OAAA,MADU,MAAMG,EAAeF,EAAM,CAAE,KAAM,OAAQ,GACtC,aACfG,GACC,eAAA,MAAM,2BAA2BA,GAAO,EACzC,CAAE,uBAAwB,EAAG,GAAIL,EAAU,KAAM,uBAC1D,CACF,CAEA,SAASG,EAAmBJ,EAAcC,EAAkBC,EAA+B,CACnF,MAAAK,EAAc,GAAGtB,EAAK,SAASe,KAAQC,aAAoBC,EAAQ,KAAK,GAAG,IAC1E,MAAA,CAACK,EAAaA,EAAY,QAAQtB,EAAK,MAAOA,EAAK,MAAM,CAAC,CACnE,CAEsB,eAAAuB,EAAcC,EAAcC,EAAW,GAAO,CAElE,MADY,GAAGzB,EAAK,QAAQwB,IACjB,QAAQX,EAAY,CAACa,EAAQC,EAAIC,IAAO,GAAGD,KAAMF,EAAW,MAAQ,KAAKG,OAAQ,CAC9F,CAEO,SAASC,EAAmBC,EAAyB,CACpD,MAAAC,EAAMC,EAAK,aAAaF,CAAO,EAC/BG,EAAWD,EAAK,eAAeD,CAAG,EACjC,MAAA,GAAG/B,EAAK,sBAAsBiC,EAAS,GAAG,YAAY,EAAE,WAAW,MAAO,EAAE,OACrF,CAEA,eAAsBC,EAAoBC,EAA6B,CACrE,MAAMC,EAAM,MAAMtB,EAAY,SAAUqB,EAAI,CAAC,MAAM,CAAC,EAC7C,OAAAZ,EAAca,EAAI,IAAI,CAC/B,CAEA,eAAsBC,EAAuBC,EAAc,OACnD,MAAAC,EAAerC,EAAW,IAAIoC,CAAI,EACxC,GAAIC,EACF,MAAO,CAAE,uBAAwB,EAAG,GAAI,EAAG,KAAMA,GAGnD,MAAMC,EAAelC,EAAiB,KAAMI,GAAMA,EAAE,OAAS4B,CAAI,EACjE,GAAIE,GAAA,MAAAA,EAAc,OAChB,OAAOA,EAAa,OAGlB,GAAA,CAGI,MAAAC,GAASC,GADI,MADF,MAAMtB,EAAe,CAAC,GAAGrB,EAAS,6DAA6D,mBAAmBuC,CAAI,GAAG,CAAC,GACzG,QACR,UAAX,YAAAI,EAAqB,GAEpC,GAAID,EAAQ,CACV,MAAME,EAAiB,KAAK,IAAI,EAAI1C,EAAoB,OAClD2C,EAAgC,CACpC,KAAAN,EACA,OAAQG,EACR,eAAAE,CAAA,EAEF,OAAArC,EAAiB,KAAKsC,CAAe,EACrC,aAAa,QAAQ,qBAAsB,KAAK,UAAUtC,CAAgB,CAAC,EACpEmC,MAEP,OAAO,CAAE,uBAAwB,EAAG,GAAI,EAAG,KAAM,8BAE5CpB,GACC,cAAA,MAAM,iCAAiCA,GAAO,EAChD,IAAI,MAAM,gCAAgC,CAClD,CACF,CAEA,eAAewB,EAAkBC,EAAqBC,EAA6B,CAC7E,IAAAC,EACJ,MAAMH,EAAiB,IAAI,QAAW,CAACI,EAAGC,IAAW,CACnDF,EAAY,WAAW,IAAM,CACpBE,EAAA,IAAI,MAAM,mBAAmB,CAAC,GACpCH,CAAO,CAAA,CACX,EACM,OAAA,QAAQ,KAAK,CAACD,EAASD,CAAc,CAAC,EAAE,QAAQ,IAAM,CAC3D,aAAaG,CAAS,CAAA,CACvB,CACH,CAEA,eAAe5B,EAAeF,EAAgBiC,EAA0C,CACtF,MAAMC,EAAW,OAAO,OAAO,CAAE,MAAO,aAAA,EAAiBD,CAAO,EAChE,UAAWE,KAAOnC,EACZ,GAAA,CACF,MAAMoC,EAAW,MAAMT,EAAe,MAAMQ,EAAKD,CAAQ,EAAG,GAAI,EAChE,GAAIE,EAAS,GACJ,OAAAA,QAEFC,GACC,QAAA,MAAM,mBAAmBF,MAAQE,GAAK,CAChD,CAEI,MAAA,IAAI,MAAM,4BAA4B,CAC9C"}