import{p as w}from"./queryParams.js";import{U as u}from"./util.js";const{api:a}=w,c={cafe:"https://cafemaker.wakingsands.com",xivapi:"https://xivapi.com"},s={first:(a==null?void 0:a.toLowerCase())==="xivapi"?c.xivapi:c.cafe,second:(a==null?void 0:a.toLowerCase())==="xivapi"?c.cafe:c.xivapi},C={get random(){return Math.floor(Math.random()*864e5*11)+864e5*25}},A=new Map(Object.entries({任务指令:"/i/000000/000123.png",冲刺:"/i/000000/000104.png",坐骑:"/i/000000/000118.png",攻击:"/i/000000/000101.png",腐秽大地:"/i/003000/003090.png"})),g="souma-img-cache",p="souma-action-cache",$=JSON.parse(localStorage.getItem(g)||"[]"),m=JSON.parse(localStorage.getItem(p)||"[]"),f=Date.now(),I=1e3,D=$.filter((t,e)=>t.expirationTime>=f&&e<I),T=m.filter((t,e)=>t.expirationTime>=f&&e<I);localStorage.setItem(g,JSON.stringify(D));localStorage.setItem(p,JSON.stringify(T));const E=/(\d{6})\/(\d{6})\.png$/;async function S(t,e,o=["ID","Icon","ActionCategoryTargetID"]){const r=x(t,e,o);try{return await(await h(r,{mode:"cors"})).json()}catch(n){return console.error(`Failed to parse action: ${n}`),{ActionCategoryTargetID:0,ID:e,Icon:"/i/000000/000405.png"}}}function x(t,e,o){const r=`${s.first}/${t}/${e}?columns=${o.join(",")}`;return[r,r.replace(s.first,s.second)]}async function N(t,e=!1){return`${s.first}${t}`.replace(E,(r,n,i)=>`${n}/${e?"hq/":""}${i}.png`)}function O(t){const e=u.jobEnumToJob(t),o=u.nameToFullName(e);return`${s.first}/cj/companion/${o.en}.png`}async function v(t){const e=await S("action",t,["Icon"]);return N(e.Icon)}async function J(t){var r;const e=A.get(t);if(e)return{ActionCategoryTargetID:0,ID:0,Icon:e};const o=m.find(n=>n.name===t);if(o!=null&&o.action)return o.action;try{const l=(r=(await(await h([`${c.cafe}/search?filters=ClassJobLevel>0&indexes=action&string=${encodeURIComponent(t)}`])).json()).Results)==null?void 0:r[0];if(l){const d=Date.now()+C.random,y={name:t,action:l,expirationTime:d};return m.push(y),localStorage.setItem("souma-action-cache",JSON.stringify(m)),l}else return{ActionCategoryTargetID:0,ID:0,Icon:"/i/000000/000405.png"}}catch(n){throw console.error(`Failed to get action by name: ${n}`),new Error("Failed to retrieve action data")}}async function j(t,e){let o;const r=new Promise((n,i)=>{o=setTimeout(()=>{i(new Error("Promise timed out"))},e)});return Promise.race([t,r]).finally(()=>{clearTimeout(o)})}async function h(t,e){const o=Object.assign({cache:"force-cache"},e);for(const r of t)try{const n=await j(fetch(r,o),3e3);if(n.ok)return n}catch(n){console.error(`Failed to fetch ${r}: ${n}`)}throw new Error("All fetch attempts failed.")}export{N as a,O as b,v as c,J as g,S as p};
