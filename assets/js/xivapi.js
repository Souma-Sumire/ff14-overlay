import{p}from"./queryParams.js";import{U as u}from"./util.js";const s={cafe:"https://cafemaker.wakingsands.com",xivapi:"https://xivapi.com"};var f,l,h,I;const i={first:((l=(f=p)==null?void 0:f.api)==null?void 0:l.toLowerCase())==="xivapi"?s.xivapi:s.cafe,second:((I=(h=p)==null?void 0:h.api)==null?void 0:I.toLowerCase())==="xivapi"?s.cafe:s.xivapi},A=new Map(Object.entries({任务指令:"/i/000000/000123.png",冲刺:"/i/000000/000104.png",坐骑:"/i/000000/000118.png",攻击:"/i/000000/000101.png",腐秽大地:"/i/003000/003090.png"}));async function x(e,t,o=["ID","Icon","ActionCategoryTargetID"]){return y([`${i.first}/${e}/${t}?columns=${o.join(",")}`,`${i.second}/${e}/${t}?columns=${o.join(",")}`],{mode:"cors"}).then(c=>c.json()).catch(()=>({ActionCategoryTargetID:0,ID:t,Icon:"/i/000000/000405.png"}))}async function T(e,t=!1){if(!e)return"";let o=`${i.first}${e}`;return await $(o).catch(()=>o=o.replace(i.first,i.second)),o.replace(/(\d{6})\/(\d{6})\.png$/,(c,n,a)=>`${n}/${t?"hq/":""}${a}.png`)}function S(e){let t=`${i.first}/cj/companion/${u.nameToFullName(u.jobEnumToJob(e)).en}.png`;return $(t).catch(()=>t=t.replace(i.first,i.second)),t}const d={get random(){return Math.floor(Math.random()*864e5*11)+864e5*25}};function $(e){const t=localStorage.getItem("souma-img-cache"),o=t?JSON.parse(t):[],c=o.find(n=>n.url===e);return c&&c.expirationTime>Date.now()?Promise.resolve(e):w(new Promise((n,a)=>{let r=new Image;r.src=e,r.onload=()=>{const m=Date.now()+d.random,g={url:e,expirationTime:m};o.push(g),localStorage.setItem("souma-img-cache",JSON.stringify(o)),n(e)},r.onerror=()=>a()}),3e3)}async function v(e){return x("action",e,["Icon"]).then(t=>T((t==null?void 0:t.Icon)??""))}async function P(e){const t=A.get(e);if(t)return Object.assign({ActionCategoryTargetID:0,ID:0,Icon:t});const o=localStorage.getItem("souma-action-cache"),c=o?JSON.parse(o):[],n=c.find(a=>a.name===e);return n&&n.action&&n.expirationTime>Date.now()?Promise.resolve(n.action):await y([`${s.cafe}/search?filters=ClassJobLevel>0&indexes=action&string=${encodeURIComponent(e)}`]).then(a=>a.json()).then(a=>{var m;const r=(m=a.Results)==null?void 0:m[0];if(r){const g=Date.now()+d.random,D={name:e,action:r,expirationTime:g};return c.push(D),localStorage.setItem("souma-action-cache",JSON.stringify(c)),r}else return{ActionCategoryTargetID:0,ID:0,Icon:"/i/000000/000405.png"}}).catch(()=>({ActionCategoryTargetID:0,ID:0,Icon:"/i/000000/000405.png"}))}async function w(e,t){let o;const c=new Promise((n,a)=>{o=setTimeout(()=>{a(new Error("Promise timed out"))},t)});return Promise.race([e,c]).finally(()=>{clearTimeout(o)})}async function y(e,t){const o=Object.assign({cache:"force-cache"},t);for(const c of e)try{const n=await w(fetch(c,o),3e3);if(n.ok)return n}catch(n){console.error(`Failed to fetch ${c}: ${n}`)}throw new Error("All fetch attempts failed.")}export{T as a,S as b,v as c,P as g,x as p};
