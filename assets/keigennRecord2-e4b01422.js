import{d as ze,o as T,b as F,J as ke,K as He,g as Y,t as at,u as l,R as nt,D as ye,A as j,C as M,F as ot,B as it,a0 as st,r as ae,h as Ee,H as Ae,a as g,w as D,a3 as lt,S as rt,I as fe,i as Se,ax as ct,ay as je,c as ut}from"./vendor-2eaf26f0.js";import{u as Re,t as Ce,m as mt,a as dt,p as ft,b as pt,d as gt,g as vt,e as bt,f as yt,_ as ht,c as kt}from"./flags-d6bd8931.js";import{h as Le}from"./xivapi-2de896fe.js";import{N as L,l as n}from"./netregexes-2830d8aa.js";import{a as he}from"./overlay_plugin_api-409cb9ea.js";import{U as B}from"./util-ef9ccf87.js";import{g as Ct}from"./actionChinese-91930ff4.js";import{c as xt,a as It}from"./status-5d5f450e.js";import"./index-4a3f8124.js";const _t={key:0},wt={key:1},Nt=["title","data-duration","data-sourcePov"],$t=["src","alt"],Dt=ze({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(Q){const C=Q,z=Re().icon4k;return(H,E)=>C.row.type==="dot"?(T(),F("div",_t," （不支持） ")):(T(),F("div",wt,[(T(!0),F(ke,null,He(C.row.keigenns,(w,ne)=>(T(),F("span",{key:ne},[Y("span",{class:"status",title:`${w.name}(${w.source})`,"data-duration":w.remainingDuration,"data-sourcePov":w.isPov},[Y("img",{class:nt(`statusIcon ${l(mt)(w.performance[Q.row.type])}`),src:`//cafemaker.wakingsands.com/i/${w.fullIcon}${l(z)}.png`,alt:w.effect,loading:"lazy",onError:E[0]||(E[0]=(...ee)=>l(Le)&&l(Le)(...ee))},null,42,$t)],8,Nt)]))),128)),Y("span",null,at(Q.row.effect==="damage done"?"":l(Ce)(Q.row.effect)),1)]))}}),Tt={key:0,class:"testLog"},Et={key:0,class:"test-buttons"},Fe="souma-keigenn-record-2",Mt=ze({__name:"keigennRecord2",setup(Q){const C=Re(),r=C.userOptions;C.recheckIsDev();const z=ye(()=>r.actionCN?"actionCN":"action"),H=j(r.minimize),E={line_height:28*r.scale,time:35*r.scale,action:65*r.scale,target:((r.showIcon?24:0)+(r.showName?r.anonymous||!r.anonymous&&r.abbrId?24:36:0)+7)*r.scale,amount:44*r.scale},w={"--vxe-font-size-mini":`${12*r.scale}px`,"--vxe-table-row-line-height":`${30*r.scale}px`,"--vxe-table-row-height-mini":`${30*r.scale}px`,"--vxe-input-height-mini":`${20*r.scale}px`,"--vxe-select-option-height-mini":`${24*r.scale}px`},ne={runtime:99,localStorage:3},ee=j(!1),oe=j(),x=M("keigenn-record-2-pov-name",""),k=M("keigenn-record-2-pov-id",""),pe=M("keigenn-record-2-party-list",[]),G=M("keigenn-record-2-job-map",{}),ie=M("keigenn-record-2-party-event-party",[]),N=j(0),i=j([{zoneName:"",duration:"00:00",table:[],key:"init"}]),xe={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:L.ability(),statusEffectExplicit:L.statusEffectExplicit(),gainsEffect:L.gainsEffect(),losesEffect:L.losesEffect(),inCombat:/^260\|(?<timestamp>[^|]*)\|(?<inACTCombat>[^|]*)\|(?<inGameCombat>[^|]*)\|/,changeZone:L.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,primaryPlayer:/^02\|(?<timestamp>[^|]*)\|(?<id>[^|]*)\|(?<name>[^|]*)/,addCombatant:L.addedCombatant(),removingCombatant:L.removingCombatant(),networkDoT:L.networkDoT()},b=j(0),Ie=M("souma-keigenn-record-2-zone-name",""),_e=M("souma-keigenn-record-2-rsv-data",{}),ge={},p={friendly:{},enemy:{}};function Pe(e){e.table.length=0,e.zoneName="",e.duration="00:00",e.key="init"}function Me(){ee.value=!0,b.value=0,N.value=0,i.value.length=1,Pe(i.value[0])}function Be(){le(),ee.value=!1}function se(e){var t,o,u,f,v,V,J,W,K,m;for(const ue in xe){const R=xe[ue].exec(e);if(R){const a=e.split("|");switch(ue){case"statusEffectExplicit":(t=R.groups)!=null&&t.targetId.startsWith("1")&&(ge[(o=R.groups)==null?void 0:o.targetId]=(u=R.groups)==null?void 0:u.currentShield);break;case"gainsEffect":{const s=a[n.GainsEffect.fields.effectId],c=a[n.GainsEffect.fields.effect],d=a[n.GainsEffect.fields.target],y=a[n.GainsEffect.fields.targetId],$=Number.parseInt(a[n.GainsEffect.fields.count],16);let h=vt(s);if(!h){const _=y.startsWith("1")&&bt.get(Number.parseInt(s,16).toString())||y.startsWith("4")&&yt.get(Number.parseInt(s,16).toString());if(!_)return;const X=xt(_.icon),te=$>1?It(X,$):X;h={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(s,16),fullIcon:te,name:_.name,isFriendly:_.isFriendly}}const U=a[n.GainsEffect.fields.duration],I=a[n.GainsEffect.fields.source],S=a[n.GainsEffect.fields.sourceId],Z=new Date(a[n.GainsEffect.fields.timestamp]).getTime()+Number.parseFloat(U)*1e3,q={name:h.name,count:$,effect:c,effectId:s,source:I,sourceId:S,target:d,targetId:y,expirationTimestamp:Z,performance:h.performance,fullIcon:h.fullIcon,isPov:k.value===S};y.startsWith("1")&&h.isFriendly?(p.friendly[y]===void 0&&(p.friendly[y]={}),p.friendly[y][s]=q):y.startsWith("4")&&!h.isFriendly&&(p.enemy[d]===void 0&&(p.enemy[d]={}),p.enemy[d][s]=q)}break;case"losesEffect":{const s=a[n.LosesEffect.fields.target],c=a[n.LosesEffect.fields.targetId],d=a[n.LosesEffect.fields.effectId];c.startsWith("1")?p.friendly[c]&&Reflect.deleteProperty(p.friendly[c],d):p.enemy[s]&&Reflect.deleteProperty(p.enemy[s],d)}break;case"addCombatant":if(a[n.AddedCombatant.fields.job]!=="00"){const s=a[n.AddedCombatant.fields.job],c=new Date(a[n.AddedCombatant.fields.timestamp]).getTime();G.value[a[n.AddedCombatant.fields.id]]={job:Number.parseInt(s,16),timestamp:c}}break;case"removingCombatant":Reflect.deleteProperty(G.value,a[n.RemovedCombatant.fields.id]);break;case"primaryPlayer":{k.value=a[n.ChangedPlayer.fields.id];const s=a[n.ChangedPlayer.fields.name];if(x.value===s)return;x.value=s,C.initEnvironment(a[n.ChangedPlayer.fields.name]);break}case"partyList":pe.value=((v=(f=R.groups)==null?void 0:f.list)==null?void 0:v.split("|"))??[];break;case"changeZone":Ie.value=a[n.ChangeZone.fields.name],$e(new Date(a[n.ChangeZone.fields.timestamp]).getTime());break;case"inCombat":{const s=a[n.InCombat.fields.inACTCombat]==="1",c=a[n.InCombat.fields.inGameCombat]==="1",d=new Date(a[n.InCombat.fields.timestamp]).getTime();if(s||c){if(b.value>0)return;i.value[0].table.length!==0&&(i.value[0]=ct(i.value[0]),i.value.unshift({zoneName:"",duration:"00:00",table:[],key:a[n.InCombat.fields.timestamp]}),i.value.length>=ne.runtime&&i.value.splice(i.value.length-1,1)),b.value=d,i.value[0].zoneName=Ie.value,N.value=0;return}if(!s&&!c){$e(d);return}}break;case"rsv":{const s=Number((V=R.groups)==null?void 0:V.id),c=a[n.RSVData.fields.value];_e.value[Number(s)]=c}break;case"networkDoT":if(!r.parseDoT)return;{const s=a[n.NetworkDoT.fields.which],c=a[n.NetworkDoT.fields.id];if(s!=="DoT"||c.startsWith("4")||!(c===k.value||pe.value.includes(c)||ie.value.find(te=>te.id===c)))return;const d=a[n.NetworkDoT.fields.name],y=a[n.NetworkDoT.fields.damage],$=Number.parseInt(y,16),h=new Date(a[n.Ability.fields.timestamp]??"???").getTime(),U=Number(a[n.NetworkDoT.fields.currentHp]),I=Number(a[n.NetworkDoT.fields.maxHp]),S=b.value===0?0:h-b.value,me=re(S),Z=we(c),q=B.nameToFullName(B.jobEnumToJob(Z)).simple2,_=Z,X=B.jobEnumToIcon(_).toLowerCase();Ne({timestamp:h,time:me,id:void 0,action:s,actionCN:s,source:"",target:d,targetId:c,job:q,jobIcon:X,jobEnum:_,amount:$,keigenns:[],currentHp:U,maxHp:I,effect:"damage done",type:"dot",shield:ge[c],povId:k.value})}break;case"ability":if(b.value===0)return;{const s=ft(a);if(s.isAttack&&s.amount>=0){const c=a[n.Ability.fields.sourceId]??"???",d=a[n.Ability.fields.targetId]??"???";if(!(c.startsWith("4")&&d.startsWith("1"))||!(d===k.value||pe.value.includes(d)||ie.value.find(P=>P.id===d)))return;const y=new Date(a[n.Ability.fields.timestamp]??"???").getTime(),$=a[n.Ability.fields.ability],h=$.match(/^_rsv_(?<id>\d+)_/),U=a[n.Ability.fields.id]??"???";let I=$;if(h){const P=Number((J=h.groups)==null?void 0:J.id);I=_e.value[P]??((K=(W=$.match(/^_(?<id>rsv_\d+)_/))==null?void 0:W.groups)==null?void 0:K.id)}else if(I=I.replace(/unknown_.*/,"攻击"),r.parseAA===!1&&/^攻击|攻撃|[Aa]ttack$/.test(I))return;const S=Ct(Number.parseInt(U,16)),me=S&&S!==""?S:I,Z=Number(a[n.Ability.fields.targetCurrentHp])??"???",q=Number(a[n.Ability.fields.targetMaxHp])??"???",_=a[n.Ability.fields.source]??"???",X=a[n.Ability.fields.target]??"???",{effect:te,type:qe}=pt(s.flags),Xe=b.value===0?0:y-b.value,Ye=re(Xe),De=we(d),Qe=B.nameToFullName(B.jobEnumToJob(De)).cn.substring(0,2),Te=De,et=B.jobEnumToIcon(Te).toLowerCase(),tt=gt(Object.values(p.friendly[d]??[]).concat(Object.values(p.enemy[_]??[])).filter(P=>{const de=Math.max(0,(P.expirationTimestamp-y)/1e3);return P.remainingDuration=de>=999?"":de.toFixed(de>.05&&de<.95?1:0),Number(P.remainingDuration)>-3}));Ne({timestamp:y,time:Ye,id:U,action:I,actionCN:me,source:_,target:X,targetId:d,job:Qe,jobIcon:et,jobEnum:Te,amount:s.amount,keigenns:tt,currentHp:Z,maxHp:q,effect:te,type:qe,shield:ge[((m=R.groups)==null?void 0:m.targetId)??""],povId:k.value}),i.value[0].duration=re(new Date(a[n.Ability.fields.timestamp]).getTime()-b.value)}break}}}}}function we(e){const t=G.value[e],o=ie.value.find(u=>u.id===e)??{job:0,timestamp:0};return[t,o].sort((u,f)=>f.timestamp-u.timestamp)[0].job}function Ne(e){i.value[0].table.unshift(e)}function $e(e){b.value!==0&&(i.value[0].duration=re(e-b.value),b.value=0,p.friendly={},p.enemy={},le())}function le(){localStorage.setItem(Fe,JSON.stringify(i.value.slice(0,ne.localStorage)))}function Ge(){const e=localStorage.getItem(Fe);if(e)try{const t=JSON.parse(e);i.value.length=0,i.value.push(...t)}catch(t){console.error(t)}}function re(e){const t=Math.max(Math.floor(e/6e4),0),o=Math.max(Math.floor((e-t*6e4)/1e3),0);return`${t<10?"0":""}${t}:${o<10?"0":""}${o}`}const Oe=ye(()=>{const e=new Set(i.value[N.value].table.map(t=>r.actionCN?t.actionCN:t.action));return Array.from(e).map(t=>({label:t,value:t}))}),Ve=ye(()=>{const e={},t=new Set(i.value[N.value].table.slice().sort((o,u)=>B.enumSortMethod(o.jobEnum,u.jobEnum)).map(o=>(e[o.target]=o.job,o.target)));return Array.from(t).map(o=>({label:`${e[o]}（${o}）`,value:o}))});C.isDev&&(x.value="测试用户"),x.value!==""&&C.initEnvironment(x.value),ot(()=>{for(const e in G.value){const t=G.value[e];Date.now()-t.timestamp>1e3*60*60*24*1&&Reflect.deleteProperty(G.value,e)}Ge(),he("LogLine",e=>{se(e.rawLine)}),he("PartyChanged",e=>{ie.value=e.party.map(t=>({...t,timestamp:Date.now()}))}),he("ChangePrimaryPlayer",e=>{x.value=e.charName,k.value=Number(e.charID).toString(16).toUpperCase()})});function Je(e){const{action:t,actionCN:o,amount:u,job:f,keigenns:v,source:V,target:J,time:W,type:K}=e,m=e.effect==="damage done"?"":`,${Ce(e.effect)}`,ue=`${W} [${f}]${J} HP:${e.currentHp}/${e.maxHp}(${Math.round(e.currentHp/e.maxHp*100)}%)+盾:${Math.round(e.maxHp*+e.shield/100)}(${e.shield}%),受到${V}“${t}${o!==t?`(${o})`:""}”的 ${u.toLocaleString()} 点${Ce(K)}伤害。减伤:${v.length===0&&m===""?"无":v.map(be=>r.statusCN?be.name:be.effect).join(",")+m}`;We(ue)}function We(e){navigator.clipboard.writeText(e).catch(()=>{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}),je.modal.message({content:"已复制到剪贴板",status:"success"})}const A=j({target:!1,action:!1}),O=j(),ve=it({className:"my-menus",body:{options:[]}});st(()=>{var e,t,o,u;(e=ve.body)!=null&&e.options&&oe.value&&(ve.body.options[0]=[{code:"copy",name:"复制详情",prefixIcon:"vxe-icon-copy",className:"my-copy-item"},{code:"clearFilterAction",name:"取消技能筛选",prefixIcon:"vxe-icon-funnel-clear",className:"my-clear-filter",visible:A.value.action,disabled:!1},{code:"filterSelectAction",name:(t=O.value)!=null&&t[z.value]?`只看 ${(o=O.value)==null?void 0:o[z.value]}`:"只看该技能",prefixIcon:"vxe-icon-info-circle",visible:!A.value.action,disabled:!1},{code:"clearFilterTarget",name:"取消玩家筛选",prefixIcon:"vxe-icon-funnel-clear",visible:A.value.target,disabled:!1},{code:"filterSelectTarget",name:(u=O.value)!=null&&u.target?`只看[${O.value.job}] ${O.value.target}`:"只看该玩家",prefixIcon:"vxe-icon-user-fill",visible:!A.value.target,disabled:!1}])});function Ke(){H.value=!H.value}const Ue=({row:e})=>{const t=oe.value;t&&(t.setCurrentRow(e),O.value=e)},Ze=({menu:e,row:t})=>{const o=oe.value;switch(e.code){case"copy":if(!t){je.modal.message({content:"未选中有效数据行",status:"error"});return}Je(t);break;case"clearFilterTarget":o&&(o.clearFilter(o.getColumnByField("target")),A.value.target=!1);break;case"clearFilterAction":o&&(o.clearFilter(o.getColumnByField(z.value)),A.value.action=!1);break;case"filterSelectTarget":if(o){const u=o.getColumnByField("target");if(u){const f=u.filters.find(v=>v.value===t.target);if(!f)return;f.checked=!0,o.updateData().then(()=>{o.scrollToRow(t),A.value.target=!0})}}break;case"filterSelectAction":if(o){const u=o.getColumnByField(z.value);if(u){const f=u.filters.find(v=>v.value===t[z.value]);if(!f)return;f.checked=!0,o.updateData().then(()=>{o.scrollToRow(t),A.value.action=!0})}}break}},ce={clearData:()=>{N.value=0,i.value.length=0,i.value.push({key:Date.now().toString(),zoneName:"测试地区",duration:"00:00",table:[]}),b.value=0,p.friendly={},p.enemy={},le()},fakeData:()=>{i.value[0].table.push({timestamp:1e4,time:i.value[0].table.length.toString(),id:void 0,action:"测试动作",actionCN:"测试动作",source:"测试敌人",target:x.value,targetId:"1234567890",job:"战士",jobIcon:"warrior",jobEnum:0,amount:1e3,keigenns:[{name:"整体盾",count:0,effect:"整体盾",effectId:"D25",source:"芸豆角包子",sourceId:"1011A008",target:"芸豆角包子",targetId:"1011A008",expirationTimestamp:1712757148883,performance:{physics:1,magic:1,darkness:1},fullIcon:"012000/012972",isPov:!1,remainingDuration:"14"},{name:"整体论",count:0,effect:"整体论",effectId:"BBB",source:"芸豆角包子",sourceId:"1011A008",target:"芸豆角包子",targetId:"1011A008",expirationTimestamp:1712757138883,performance:{physics:1,magic:1,darkness:1},fullIcon:"012000/012971",isPov:!1,remainingDuration:"4"},{name:"均衡预后",count:0,effect:"均衡预后",effectId:"A31",source:"芸豆角包子",sourceId:"1011A008",target:"芸豆角包子",targetId:"1011A008",expirationTimestamp:1712757153915,performance:{physics:1,magic:1,darkness:1},fullIcon:"012000/012954",isPov:!1,remainingDuration:"19"}],currentHp:1e3,maxHp:1e3,effect:"damage done",type:"magic",shield:"0",povId:k.value}),le()},fakeLogDamage:()=>{b.value=Date.now(),se(`21|${new Date}|4000044A|万魔殿|829A|尖脚|${k.value}|${x.value}|720203|B0F10000|9F0E|8200000|1B|829A8000|0|0|0|0|0|0|0|0|0|0|155065|155065|10000|10000|||94.62|98.28|0.00|-3.13|44|44|0|10000|||92.00|100.00|0.00|0.00|000010B3|0|1|fd5fa47ff773c3ca`)},fakeLogStatus:()=>{se(`26|${new Date}|59|复仇|15.00|${k.value}|${x.value}|${k.value}|${x.value}|64|129221|129221|b6388ee76760c33b`)}};return(e,t)=>{const o=ae("vxe-option"),u=ae("vxe-select"),f=ae("vxe-button"),v=ae("vxe-column"),V=ht,J=kt,W=Dt,K=ae("vxe-table");return T(),F(ke,null,[Y("div",{class:"wrapper",style:w},[Y("header",null,[Ee(g(u,{modelValue:l(N),"onUpdate:modelValue":t[0]||(t[0]=m=>lt(N)?N.value=m:null),size:"mini",class:"select"},{default:D(()=>[(T(!0),F(ke,null,He(l(i).length,m=>(T(),ut(o,{key:`${l(i)[m-1].key}-${l(i)[m-1].duration}-${l(i)[m-1].zoneName}`,value:m-1,label:`${l(i)[m-1].duration} ${l(i)[m-1].zoneName}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue"]),[[Ae,!l(H)]]),g(f,{class:"minimize",icon:l(H)?"vxe-icon-fullscreen":"vxe-icon-minimize",style:rt({opacity:l(H)?.5:1}),onClick:Ke},null,8,["icon","style"])]),Ee(Y("main",null,[g(K,{ref_key:"xTable",ref:oe,size:"mini",class:"vxe-table","show-overflow":"tooltip",round:"",height:"100%","scroll-y":{enabled:!0},loading:l(ee),"show-header":l(r).showHeader,data:l(i)[l(N)].table,"row-config":{isHover:!0,height:E.line_height},"header-cell-style":{padding:"0px"},"menu-config":l(ve),onCellMenu:Ue,onMenuClick:Ze},{default:D(()=>[g(v,{width:E.time,field:"time",title:"时间",align:"center"},null,8,["width"]),g(v,{width:E.action,field:l(r).actionCN?"actionCN":"action",title:"技能",filters:l(Oe),"filter-multiple":!1,resizable:!1,align:"center"},null,8,["width","field","filters"]),g(v,{width:E.target,field:"target",title:l(r).showName?"目标":"目",filters:l(Ve),"filter-multiple":!1,resizable:!l(r).anonymous&&!l(r).abbrId,align:"left","header-align":"center"},{default:D(({row:m})=>[g(V,{row:m},null,8,["row"])]),_:1},8,["width","title","filters","resizable"]),g(v,{width:E.amount,title:"伤害","header-align":"center"},{default:D(({row:m})=>[g(J,{row:m},null,8,["row"])]),_:1},8,["width"]),g(v,{title:"减伤",align:"left"},{default:D(({row:m})=>[g(W,{row:m},null,8,["row"])]),_:1})]),_:1},8,["loading","show-header","data","row-config","menu-config"])],512),[[Ae,!l(H)]])]),l(C).isDev?(T(),F("div",Tt,[l(C).isLocalhost?(T(),F("div",Et,[g(f,{class:"test-button",type:"primary",onClick:ce.clearData},{default:D(()=>[fe(" 清空 ")]),_:1},8,["onClick"]),g(f,{class:"test-button",type:"primary",onClick:ce.fakeData},{default:D(()=>[fe(" 假条目 ")]),_:1},8,["onClick"]),g(f,{class:"test-button",type:"primary",onClick:ce.fakeLogDamage},{default:D(()=>[fe(" 假伤害 ")]),_:1},8,["onClick"]),g(f,{class:"test-button",type:"primary",onClick:ce.fakeLogStatus},{default:D(()=>[fe(" 假状态 ")]),_:1},8,["onClick"])])):Se("",!0),g(dt,{onBeforeHandle:Me,onAfterHandle:Be,onHandleLine:se})])):Se("",!0)],64)}}});export{Mt as default};
