import{S as M,d as x,o as h,e as _,F as P,L as $,u as s,P as k,Q as E,t as w,G as L,H as N,Z as H,a0 as S,x as b,y as O,b as U,a as u,w as f,D as F,a5 as z,a6 as R,N as B}from"./vendor-9c3ca848.js";import{c as V,a as I}from"./overlay_plugin_api-409cb9ea.js";import{U as g}from"./util-831b56e7.js";import{d as W,s as J,p as Q,b as Y,h as D,e as q}from"./xivapi-a5c0f7f0.js";import{_ as A}from"./_plugin-vue_export-helper-c27b6911.js";const v=new URLSearchParams(window.location.href.split("?")[1]),j=["tank","healer","dps","crafter","gatherer","none"],C=[34563,34564,34565,34566,34567,34568,34569,34570,34571,34572,34573,34574,34575,34576,34577,34578,34579,34580,34581,34582],T=M("castingMonitor",{state:()=>({castData:[],playerId:"",focusTargetId:"",partyData:[],config:{duration:Number(v.get("duration")||15)}}),getters:{partyDataFormatted(t){return t.partyData.sort((e,a)=>j.indexOf(g.jobToRole(g.jobEnumToJob(e.job)))-j.indexOf(g.jobToRole(g.jobEnumToJob(a.job))))},focusTargetCastArr(t){return t.castData.filter(e=>e.casterId===t.focusTargetId)}},actions:{testAction(){const t=C[Math.floor(Math.random()*C.length)];this.pushAction(Date.now(),15,"青魔技能随机",this.focusTargetId,t)},testParty(t){this.handlePartyChanged({party:t?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0}]:[]})},async pushAction(t,e,a,r,n,d){if(this.partyData.length===0&&r===this.playerId||this.partyData.length>0&&r===this.focusTargetId){let o=n,c="action",y=!1;if(a.startsWith("item_"))return;a.startsWith("mount_")&&(o=Number.parseInt(a.replace(/^.+_/,""),16),o>983040&&(o=Number.parseInt(o.toString().slice(-5),10),y=!0),c=a.replace(/_.+$/,""));const m=`${t}-${e}-${r}-${n}`,i={casterId:r,time:t,expirationTime:Date.now()+this.config.duration*1e3,logLine:e,src:"",class:"",key:m},p=W.get(o);if(p&&(i.src=`//${p.Host}${p.Icon}`),this.castData.push(i),e===14&&d&&setTimeout(()=>{this.castData=this.castData.filter(l=>l.key!==m)},d*1e3-500),a.startsWith("unknown_"))i.src=`${J.first}/i/000000/000405.png`,i.class="action action-category-0";else if(o<1e5){const l=p||await Q(c,o,["ID","Icon","ActionCategoryTargetID"]);l.ID===3&&(l.Icon="/i/000000/000104.png"),p||(i.src=await Y((l==null?void 0:l.Icon)??"",y)),c==="action"?i.class=`action action-category-${l==null?void 0:l.ActionCategoryTargetID}`:c==="mount"&&(i.class="mount")}}},handleChangePrimaryPlayer(t){this.playerId=t.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(t){t.line[0]==="20"?this.pushAction(Date.now(),14,t.line[5],t.line[2],Number.parseInt(t.line[4],16),Number(t.line[8])):(t.line[0]==="21"||t.line[0]==="22"&&t.line[45]==="0")&&this.pushAction(Date.now(),15,t.line[5],t.line[2],Number.parseInt(t.line[4],16))},handlePartyChanged(t){if(t.party.length>0){this.partyData=t.party.filter(e=>e.inParty).map(e=>({...e,src:""}));for(const e in this.castData)Object.prototype.hasOwnProperty.call(this.castData,e)&&(this.partyData.find(a=>a.id===e)||Reflect.deleteProperty(this.castData,e));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(t){t===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=t,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(v.get("syncFocusWS")||"")&&V({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})},cleanUpExpired(){this.castData=this.castData.filter(t=>t.expirationTime>Date.now())}}}),G=t=>(L("data-v-25111fd1"),t=t(),N(),t),Z={"w-100vw":"",flex:"~ nowrap",class:"main"},K=["data-casterId"],X=["src"],tt=G(()=>w("img",{class:"frame",loading:"lazy"},null,-1)),et=x({__name:"Main",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),a=T(),r=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(e.get("displayAA")??""));return(n,d)=>(h(),_("div",Z,[(h(!0),_(P,null,$(s(a).castData,o=>(h(),_("div",{key:o.key,"data-casterId":o.casterId,class:k(`images ${o.class} logLine${o.logLine} displayAA${s(r)}`),style:E(`--animeDuration: ${s(a).config.duration}s;`)},[w("img",{src:o.src,class:"action-icon",height:"40",loading:"lazy",onError:d[0]||(d[0]=(...c)=>s(D)&&s(D)(...c))},null,40,X),tt],14,K))),128))]))}});const at=A(et,[["__scopeId","data-v-25111fd1"]]),ot={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},st=["onClick"],nt={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},rt=["src","onerror"],it=x({__name:"Header",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),a=T();H(()=>{for(const n of a.partyData)n.src=q(n.job)});const r=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(e.get("showHeader")||"true");return(n,d)=>s(r)&&s(a).partyData.length>1?(h(),_("div",ot,[(h(!0),_(P,null,$(s(a).partyDataFormatted,(o,c)=>(h(),_("button",{key:c,class:k(["job-lists",s(a).focusTargetId===o.id?"job-lists-focus":""]),"m-0":"","p-0":"",onClick:y=>s(a).handleClickChangeTarget(o.id)},[w("div",nt,[w("img",{src:o.src,style:{height:"1.25em"},loading:"lazy",onerror:s(D)},null,8,rt),b(" "+O(s(g).nameToFullName(s(g).jobEnumToJob(o.job)).simple2),1)])],10,st))),128))])):S("",!0)}});const ct={class:"common-layout"},lt={key:0},dt=x({__name:"castingMonitor",setup(t){const e=T(),a=location.href.includes("localhost");return U(()=>{I("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),I("LogLine",e.handleLogLine),I("PartyChanged",e.handlePartyChanged),I("BroadcastMessage",r=>{r.source==="castMonitorOverlay"&&(e.focusTargetId=r.msg.targetId)})}),setInterval(()=>{e.cleanUpExpired()},1e3),(r,n)=>{const d=it,o=F,c=at,y=z,m=R,i=B;return h(),_("div",ct,[u(m,{"items-center":""},{default:f(()=>[u(o,{class:"header-layout"},{default:f(()=>[u(d)]),_:1}),u(y,null,{default:f(()=>[u(c)]),_:1})]),_:1}),s(a)?(h(),_("footer",lt,[u(i,{onClick:n[0]||(n[0]=p=>s(e).testParty(!0))},{default:f(()=>[b(" 虚假小队 ")]),_:1}),u(i,{onClick:n[1]||(n[1]=p=>s(e).testParty(!1))},{default:f(()=>[b(" 单人 ")]),_:1}),u(i,{onClick:n[2]||(n[2]=p=>s(e).testAction())},{default:f(()=>[b(" Action ")]),_:1})])):S("",!0)])}}});const gt=A(dt,[["__scopeId","data-v-9ae8b22a"]]);export{gt as default};
