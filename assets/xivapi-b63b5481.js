import{U as g}from"./util-4b7cb3a6.js";const I=new URLSearchParams(window.location.href.split("?")[1]),c=I.get("api"),a={cafe:"cafemaker.wakingsands.com",xivapi:"xivapi.com"},s={first:`https://${(c==null?void 0:c.toLowerCase())==="xivapi"?a.xivapi:a.cafe}`,second:`https://${(c==null?void 0:c.toLowerCase())==="xivapi"?a.cafe:a.xivapi}`},w={get random(){return Math.floor(Math.random()*864e5*11)+864e5*25}},$=new Map(Object.entries({任务指令:"/i/000000/000123.png",冲刺:"/i/000000/000104.png",坐骑:"/i/000000/000118.png",攻击:"/i/000000/000101.png",腐秽大地:"/i/003000/003090.png"})),u="souma-action-cache",l=JSON.parse(localStorage.getItem(u)||"[]"),y=Date.now(),C=1e3,A=l.filter((t,e)=>t.expirationTime>=y&&e<C);localStorage.setItem(u,JSON.stringify(A));const T=/(\d{6})\/(\d{6})\.png$/;async function D(t,e,o=["ID","Icon","ActionCategoryTargetID"]){const r=E(t,e,o);try{return await(await f(r,{mode:"cors"})).json()}catch(n){return console.error(`Failed to parse action: ${n}`),Promise.resolve({ActionCategoryTargetID:0,ID:e,Icon:"/i/000000/000405.png"})}}function E(t,e,o){const r=`${s.first}/${t}/${e}?columns=${o.join(",")}`;return[r,r.replace(s.first,s.second)]}async function v(t,e=!1){return`${s.first}${t}`.replace(T,(r,n,i)=>`${n}/${e?"hq/":""}${i}.png`)}function b(t){const e=g.jobEnumToJob(t),o=g.nameToFullName(e);return`${s.first}/cj/companion/${o.en.toLowerCase().replaceAll(/\s/g,"")}.png`}async function j(t){const e=await D("action",t,["Icon"]);return v(e.Icon)}async function N(t){var r;const e=$.get(t);if(e)return{ActionCategoryTargetID:0,ID:0,Icon:e};const o=l.find(n=>n.name===t);if(o!=null&&o.action)return o.action;try{const m=(r=(await(await f([`https://${a.cafe}/search?filters=ClassJobLevel>0&indexes=action&string=${encodeURIComponent(t)}`])).json()).Results)==null?void 0:r[0];if(m){const h=Date.now()+w.random,d={name:t,action:m,expirationTime:h};return l.push(d),localStorage.setItem(u,JSON.stringify(l)),m}return{ActionCategoryTargetID:0,ID:0,Icon:"/i/000000/000405.png"}}catch(n){throw console.error(`Failed to get action by name: ${n}`),new Error("Failed to retrieve action data")}}async function x(t,e){let o;const r=new Promise((n,i)=>{o=setTimeout(()=>{i(new Error("Promise timed out"))},e)});return Promise.race([t,r]).finally(()=>{clearTimeout(o)})}async function f(t,e){const o=Object.assign({cache:"force-cache"},e);for(const r of t)try{const n=await x(fetch(r,o),3e3);if(n.ok)return n}catch(n){console.error(`Failed to fetch ${r}: ${n}`)}throw new Error("All fetch attempts failed.")}const p=new Map;function P(t){return p.has(t)?p.get(t):`${s.first}${t}`}function _(t){const e=t.target,o=e.src.match(new RegExp("(?<=\\.\\w+)\\/.+$"))[0];/pictomancer\.png$/.test(e.src)?e.src="//souma.diemoe.net/resources/img/pictomancer.png":/viper\.png$/.test(e.src)?e.src="//souma.diemoe.net/resources/img/viper.png":e.src.includes(s.first)?e.src=e.src.replace(s.first,s.second):e.src="",p.set(o,e.src)}export{N as a,v as b,b as c,j as d,P as g,_ as h,D as p,s};
