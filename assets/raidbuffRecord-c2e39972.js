import{d as st,as as ot,v as _,y as S,A as it,B as rt,at as lt,x as ct,Y as ut,r as B,o as J,b as se,f as oe,C as _e,D as Ne,u as p,a as u,w as D,G as ie,H as dt,a0 as mt,P as ft,F as pt,t as bt,g as vt,au as gt,av as ke,c as yt}from"./vendor-ce6ce513.js";import{t as K,a as ht,p as Ct,b as wt,d as xt}from"./deepClone-2a045b99.js";import{N as z,l as s}from"./netregexes-2830d8aa.js";import{U as X}from"./util-f6d3a594.js";import{s as Se,c as $e,a as It}from"./status-2cacdfd9.js";import{g as _t}from"./actionChinese-71b7e526.js";import"./index-ecfccaf0.js";const Ee=[{id:141,name:"战斗之声",isFriendly:!0},{id:2722,name:"光明神的最终乐章",isFriendly:!0},{id:3183,name:"夺取",isFriendly:!1},{id:2599,name:"神秘环",isFriendly:!0},{id:786,name:"战斗连祷",isFriendly:!0},{id:1910,name:"巨龙右眼",isFriendly:!0},{id:1454,name:"巨龙左眼",isFriendly:!0},{id:1185,name:"义结金兰：攻击",isFriendly:!0},{id:2703,name:"灼热之光",isFriendly:!0},{id:1221,name:"连环计",isFriendly:!1},{id:1297,name:"鼓励",isFriendly:!0},{id:1822,name:"技巧舞步结束",isFriendly:!0},{id:1825,name:"进攻之探戈",isFriendly:!0},{id:1878,name:"占卜",isFriendly:!0},{id:1882,name:"太阳神之衡",isFriendly:!0},{id:1884,name:"放浪神之箭",isFriendly:!0},{id:1885,name:"战争神之枪",isFriendly:!0},{id:1883,name:"世界树之干",isFriendly:!0},{id:1886,name:"河流神之瓶",isFriendly:!0},{id:1887,name:"建筑神之塔",isFriendly:!0}],re=new Map;let Ae;function le(N){if(Ae!==N){const o=N==="Chinese"?Ee:Object.assign(Ee,{});re.clear();for(const y of o){const f=Se[y.id][1];y.fullIcon=$e(f),re.set(y.id.toString(16).toUpperCase(),y)}Ae=N}}le("Chinese");function Nt(N){return re.get(N)}const kt=/(?:攻击力|伤害)提高/,Et=/(?:耐性|防御力)(?:大幅)?(?:降低|提升|低下|下降)|受伤(?:加重|减轻)|体力(?:增加|衰减|减少)|伤害屏障/,Te=(N,o)=>Object.entries(Se).reduce((y,[f,[n,k]])=>(N.test(n)&&y.set(f,{name:n,icon:k,isFriendly:o}),y),new Map),At=Te(kt,!0),Ft=Te(Et,!1),St={key:0,class:"testLog"},Fe="souma-raidbuff-record-2",Ot=st({__name:"raidbuffRecord",setup(N){const o=ot("hash"),y=_(o.dev==="1"||o.dev===void 0&&!window.OverlayPluginApi&&!o.OVERLAY_WS&&!o.HOST_PORT);y.value&&setTimeout(()=>{y.value=o.dev==="1"||o.dev===void 0&&!window.OverlayPluginApi&&!o.OVERLAY_WS&&!o.HOST_PORT},1e3);function f(e,t){return typeof t=="boolean"?e==="0"?!1:e==="1"?!0:t:typeof t=="number"?isNaN(+e)?t:+e:t}const n={scale:f(o.scale,1),showHeader:f(o.showHeader,!0),showIcon:f(o.showIcon,!0),showName:f(o.showName,!1),abbrId:f(o.abbrId,!0),anonymous:f(o.anonymous,!0),replaceWithYou:f(o.replaceWithYou,!1),parseAA:f(o.parseAA,!1),parseDoT:f(o.parseDoT,!1),minimize:f(o.minimize,!1),actionCN:f(o.actionCN,!0),statusCN:f(o.statusCN,!0),onlyBuffs:f(o.onlyBuffs,!0),filterPov:f(o.filterPov,!0)},k=_(n.minimize),Le=n.scale>=2||window.devicePixelRatio>=2?"_hr1":"",$={line_height:28*n.scale,time:35*n.scale,action:65*n.scale,source:((n.showIcon?24:0)+(n.showName?n.anonymous||!n.anonymous&&n.abbrId?24:36:0)+4)*n.scale,amount:44*n.scale,properties:32*n.scale},je={"--vxe-font-size-mini":12*n.scale+"px","--vxe-table-row-line-height":30*n.scale+"px","--vxe-table-row-height-mini":30*n.scale+"px","--vxe-input-height-mini":20*n.scale+"px","--vxe-select-option-height-mini":24*n.scale+"px"},ce={runtime:99,localStorage:3},q=_(!1),O=_(),R=S("raidbuff-record-2-pov-name",""),M=S("raidbuff-record-2-pov-id",""),ue=S("raidbuff-record-2-party-list",[]),T=S("raidbuff-record-2-job-map",{}),Q=S("raidbuff-record-2-party-event-party",[]),A=_(0),i=_([{zoneName:"",duration:"00:00",table:[],key:"init"}]),de={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d*)[^|]*\|(?<real>[^|]*)\|/i,ability:z.ability(),gainsEffect:z.gainsEffect(),losesEffect:z.losesEffect(),inCombat:/^260\|(?<timestamp>[^|]*)\|(?<inACTCombat>[^|]*)\|(?<inGameCombat>[^|]*)\|/i,changeZone:z.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|){0,})\w{16}/i,primaryPlayer:/^02\|(?<timestamp>[^|]*)\|(?<id>[^|]*)\|(?<name>[^|]*)/,addCombatant:z.addedCombatant(),removingCombatant:z.removingCombatant()},C=_(0),me=S("souma-raidbuff-record-2-zone-name",""),fe=S("souma-raidbuff-record-2-rsv-data",{}),w={friendly:{},enemy:{}},Pe=e=>{e.table.length=0,e.zoneName="",e.duration="00:00",e.key="init"},De=()=>{q.value=!0,C.value=0,A.value=0,i.value.length=1,Pe(i.value[0])},ze=()=>{ge(),q.value=!1},pe=e=>{be(e.rawLine)},be=e=>{var t,l,d;for(const h in de){const I=de[h].exec(e);if(I){const a=e.split("|");switch(h){case"gainsEffect":{const r=a[s.GainsEffect.fields.effectId],c=a[s.GainsEffect.fields.effect],b=a[s.GainsEffect.fields.target],m=a[s.GainsEffect.fields.targetId],x=Number(a[s.GainsEffect.fields.count]);let g=Nt(r);if(!g){const P=m.startsWith("1")&&At.get(parseInt(r,16).toString())||m.startsWith("4")&&Ft.get(parseInt(r,16).toString());if(!P)return;const G=$e(P.icon),ne=x>1?It(G,x):G;g={id:parseInt(r,16),fullIcon:ne,name:P.name,isFriendly:P.isFriendly}}const L=a[s.GainsEffect.fields.duration],E=a[s.GainsEffect.fields.source],j=a[s.GainsEffect.fields.sourceId],ae=new Date(a[s.GainsEffect.fields.timestamp]).getTime()+parseFloat(L)*1e3,Y={name:g.name,count:x,effect:c,effectId:r,source:E,sourceId:j,target:b,targetId:m,expirationTimestamp:ae,fullIcon:g.fullIcon,isPov:M.value===j};m.startsWith("1")&&g.isFriendly?((t=w.friendly)[m]??(t[m]={}))[r]=Y:m.startsWith("4")&&!g.isFriendly&&(((l=w.enemy)[b]??(l[b]={}))[r]=Y)}break;case"losesEffect":{const r=a[s.LosesEffect.fields.target],c=a[s.LosesEffect.fields.targetId],b=a[s.LosesEffect.fields.effectId];c.startsWith("1")?w.friendly[c]&&Reflect.deleteProperty(w.friendly[c],b):w.enemy[r]&&Reflect.deleteProperty(w.enemy[r],b)}break;case"addCombatant":if(a[s.AddedCombatant.fields.job]!=="00"){const r=a[s.AddedCombatant.fields.job],c=new Date(a[s.AddedCombatant.fields.timestamp]).getTime();T.value[a[s.AddedCombatant.fields.id]]={job:parseInt(r,16),timestamp:c}}break;case"removingCombatant":Reflect.deleteProperty(T.value,a[s.RemovedCombatant.fields.id]);break;case"primaryPlayer":M.value=a[s.ChangedPlayer.fields.id];const U=a[s.ChangedPlayer.fields.name];if(R.value===U)return;R.value=U,ye(a[s.ChangedPlayer.fields.name]);break;case"partyList":ue.value=((d=I.groups.list)==null?void 0:d.split("|"))??[];break;case"changeZone":me.value=a[s.ChangeZone.fields.name],ve(new Date(a[s.ChangeZone.fields.timestamp]).getTime());break;case"inCombat":{const r=a[s.InCombat.fields.inACTCombat]==="1",c=a[s.InCombat.fields.inGameCombat]==="1",b=new Date(a[s.InCombat.fields.timestamp]).getTime();if(r||c){if(C.value>0)return;i.value[0].table.length!==0&&(i.value[0]=gt(i.value[0]),i.value.unshift({zoneName:"",duration:"00:00",table:[],key:a[s.InCombat.fields.timestamp]}),i.value.length>=ce.runtime&&i.value.splice(i.value.length-1,1)),C.value=b,i.value[0].zoneName=me.value,A.value=0;const m=O.value;m&&n.filterPov&&m.updateData().then(()=>{const x=m.getColumnByField("source");if(x){const g=x.filters.find(L=>L.value===R.value);if(!g)return;g.checked=!0,m.updateData().then(()=>{H.value.source=!0})}});return}if(!r&&!c){ve(b);return}}break;case"rsv":{const r=Number(I.groups.id),c=a[s.RSVData.fields.value];fe.value[Number(r)]=c}break;case"ability":if(C.value===0)return;{const r=Ct(a);if(r.isAttack&&r.amount>=0){const c=a[s.Ability.fields.sourceId]??"???",b=a[s.Ability.fields.targetId]??"???";if(!(c.startsWith("1")&&b.startsWith("4"))||!(c===M.value||ue.value.includes(c)||Q.value.find(F=>F.id===c)))return;const m=new Date(a[s.Ability.fields.timestamp]??"???").getTime(),x=a[s.Ability.fields.ability],g=x.match(/^_rsv_(?<id>\d+)_/),L=a[s.Ability.fields.id]??"???";let E=x;if(g){const F=Number(g.groups.id);E=fe.value[F]??x.match(/^_(?<id>rsv_\d+)_/).groups.id}else if(E=E.replace(/unknown_.*/,"攻击"),n.parseAA===!1&&/^攻击|攻撃|[Aa]ttack$/.test(E))return;const j=_t(parseInt(L,16)),Ce=j&&j!==""?j:E,ae=Number(a[s.Ability.fields.targetCurrentHp])??"???",Y=Number(a[s.Ability.fields.targetMaxHp])??"???",P=a[s.Ability.fields.source]??"???",G=a[s.Ability.fields.target]??"???",{effect:ne,type:qe,properties:Qe}=wt(r.flags),et=C.value===0?0:m-C.value,tt=ee(et),we=Oe(c),at=X.nameToFullName(X.jobEnumToJob(we)).cn.substring(0,2),xe=we,nt=X.jobEnumToIcon(xe).toLocaleLowerCase(),Ie=xt(Object.values(w.friendly[c]??[]).concat(Object.values(w.enemy[G]??[])).filter(F=>{const Z=Math.max(0,(F.expirationTimestamp-m)/1e3);return F.remainingDuration=Z>=999?"":Z.toFixed(Z>.05&&Z<.95?1:0),Number(F.remainingDuration)>-3}));if(n.onlyBuffs&&Ie.length===0)return;Re({timestamp:m,time:tt,id:L,action:E,actionCN:Ce,source:P,target:G,sourceId:c,job:at,jobIcon:nt,jobEnum:xe,amount:r.amount,raidbuffs:Ie,currentHp:ae,maxHp:Y,effect:ne,properties:Qe,type:qe,povId:M.value}),i.value[0].duration=ee(new Date(a[s.Ability.fields.timestamp]).getTime()-C.value)}break}}}}},Oe=e=>{const t=T.value[e],l=Q.value.find(d=>d.id===e)??{job:0,timestamp:0};return[t,l].sort((d,h)=>h.timestamp-d.timestamp)[0].job},Re=e=>{i.value[0].table.unshift(e)},ve=e=>{C.value!==0&&(i.value[0].duration=ee(e-C.value),C.value=0,w.friendly={},w.enemy={},ge())},ge=()=>{localStorage.setItem(Fe,JSON.stringify(i.value.slice(0,ce.localStorage)))},Me=()=>{const e=localStorage.getItem(Fe);if(e)try{const t=JSON.parse(e);i.value.length=0,i.value.push(...t)}catch(t){console.error(t)}},ee=e=>{const t=Math.max(Math.floor(e/6e4),0),l=Math.max(Math.floor((e-t*6e4)/1e3),0);return`${t<10?"0":""}${t}:${l<10?"0":""}${l}`},He=it(()=>{const e={},t=new Set(i.value[A.value].table.slice().sort((l,d)=>X.enumSortMethod(l.jobEnum,d.jobEnum)).map(l=>(e[l.source]=l.job,l.source)));return Array.from(t).map(l=>({label:`${e[l]}（${l}）`,value:l}))});let te=e=>e;const ye=e=>{/^([A-Z])\S+ ([A-Z])\S+$/.test(e)?(n.abbrId&&(te=t=>t.replace(/^([A-Z])\S+ ([A-Z])\S+$/,"$1.$2.")),le("Global")):(n.abbrId&&(te=t=>t.substring(0,2)),le("Chinese"))};ye(R.value);const he=e=>{const t=e.target;t.src.includes("cafemaker.wakingsands.com")?t.src=t.src.replace("cafemaker.wakingsands.com","xivapi.com"):t.src.includes("xivapi.com")&&(t.src="")},Ge=e=>{R.value=e.charName,M.value=e.charID.toString(16).toUpperCase()},Be=e=>{Q.value=e.party.map(t=>({...t,timestamp:Date.now()}))};rt(()=>{for(const e in T.value){const t=T.value[e];Date.now()-t.timestamp>1e3*60*60*24*1&&Reflect.deleteProperty(T.value,e)}Me(),addOverlayListener("LogLine",pe),addOverlayListener("PartyChanged",Be),addOverlayListener("ChangePrimaryPlayer",Ge),startOverlayEvents()}),lt(()=>{removeOverlayListener("LogLine",pe)});const Ve=({row:e})=>u("div",null,[u("span",{class:"target"},[n.showIcon&&u("img",{class:"jobIcon",src:`//cafemaker.wakingsands.com/cj/companion/${e.jobIcon}.png`,alt:"","data-job":n.showName?"":e.job,onError:he,loading:"lazy"},null),n.showName&&u("span",{class:`job ${e.jobIcon} ${e.sourceId===e.povId?"YOU":""}`},[e.sourceId===e.povId&&n.replaceWithYou?"YOU":n.anonymous?e.job:te(e.source)])])]),We=({row:e})=>u("span",{class:"amount"},[u("span",{class:`${e.type}`},[u("span",null,[e.amount.toLocaleString().padStart(3,"　")])])]),Ue=({row:e})=>u(ie,null,[e.type==="dot"?"（不支持）":e.raidbuffs.map(t=>u("span",{class:"status",title:`${t.name}(${t.source})`,"data-duration":t.remainingDuration,"data-sourcePov":t.isPov},[u("img",{class:"statusIcon",src:`//cafemaker.wakingsands.com/i/${t.fullIcon}${Le}.png`,alt:t.effect,onError:he,loading:"lazy"},null)]))]),Ye=e=>{const{action:t,actionCN:l,amount:d,job:h,raidbuffs:v,source:I,time:a,type:U,properties:r}=e,c=e.effect==="damage done"?"":","+K(e.effect),b=`${a} [${h}]${I}的“${t}${l!==t?"("+l+")":""}”造成${d.toLocaleString()}点${K(U)}${K(r)}伤害。团辅：${v.length===0&&c===""?"无":v.map(m=>n.statusCN?m.name:m.effect).join(",")+c}。`;Ze(b)},Ze=e=>{navigator.clipboard.writeText(e).catch(()=>{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}),ke.modal.message({content:"已复制到剪贴板",status:"success"})},H=_({source:!1,action:!1}),V=_(),W=ct({className:"my-menus",body:{options:[]}});ut(()=>{var e;W.body&&W.body.options&&O.value&&(W.body.options[0]=[{code:"copy",name:"复制详情",prefixIcon:"vxe-icon-copy",className:"my-copy-item"},{code:"clearFilterTarget",name:"取消玩家筛选",prefixIcon:"vxe-icon-funnel-clear",visible:H.value.source,disabled:!1},{code:"filterSelectTarget",name:(e=V.value)!=null&&e.source?`只看[${V.value.job}] ${V.value.source}`:"只看该玩家",prefixIcon:"vxe-icon-user-fill",visible:!H.value.source,disabled:!1}])});const Je=()=>{k.value=!k.value},Ke=({row:e})=>{const t=O.value;t&&(t.setCurrentRow(e),V.value=e)},Xe=({menu:e,row:t,column:l})=>{const d=O.value;switch(e.code){case"copy":if(!t){ke.modal.message({content:"未选中有效数据行",status:"error"});return}Ye(t);break;case"clearFilterTarget":d&&(d.clearFilter(d.getColumnByField("source")),H.value.source=!1);break;case"filterSelectTarget":if(d){const h=d.getColumnByField("source");if(h){const v=h.filters.find(I=>I.value===t.source);if(!v)return;v.checked=!0,d.updateData().then(()=>{d.scrollToRow(t),H.value.source=!0})}}break}};return(e,t)=>{const l=B("vxe-option"),d=B("vxe-select"),h=B("vxe-button"),v=B("vxe-column"),I=B("vxe-table");return J(),se(ie,null,[oe("div",{class:"wrapper",style:je},[oe("header",null,[_e(u(d,{modelValue:p(A),"onUpdate:modelValue":t[0]||(t[0]=a=>mt(A)?A.value=a:null),size:"mini",class:"select"},{default:D(()=>[(J(!0),se(ie,null,dt(p(i).length,a=>(J(),yt(l,{key:`${p(i)[a-1].key}-${p(i)[a-1].duration}-${p(i)[a-1].zoneName}`,value:a-1,label:`${p(i)[a-1].duration} ${p(i)[a-1].zoneName}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue"]),[[Ne,!p(k)]]),u(h,{class:"minimize",icon:p(k)?"vxe-icon-fullscreen":"vxe-icon-minimize",onClick:Je,style:ft({opacity:p(k)?.5:1})},null,8,["icon","style"])]),_e(oe("main",null,[u(I,{ref_key:"xTable",ref:O,size:"mini",class:"vxe-table","show-overflow":"tooltip",round:"",height:"100%","scroll-y":{enabled:!0},loading:p(q),"show-header":n.showHeader,data:p(i)[p(A)].table,"row-config":{isHover:!0,height:$.line_height},"header-cell-style":{padding:"0px"},onCellMenu:Ke,"menu-config":p(W),onMenuClick:Xe},{default:D(()=>[u(v,{width:$.source,field:"source",title:n.showName?"友方":"友",filters:p(He),"filter-multiple":!1,resizable:!n.anonymous&&!n.abbrId,align:"left","header-align":"center"},{default:D(({row:a})=>[u(Ve,{row:a},null,8,["row"])]),_:1},8,["width","title","filters","resizable"]),u(v,{width:$.time,field:"time",title:"时间",align:"center"},null,8,["width"]),u(v,{width:$.action,field:n.actionCN?"actionCN":"action",title:"技能",resizable:!1,align:"right"},null,8,["width","field"]),u(v,{width:$.amount,title:"伤害","header-align":"center"},{default:D(({row:a})=>[u(We,{row:a},null,8,["row"])]),_:1},8,["width"]),u(v,{width:$.properties,title:"直暴","header-align":"center",align:"center"},{default:D(({row:a})=>[pt(bt(p(K)(a.properties).replace(/普通$/,"").replace("直击","直　").replace("暴击","　暴")),1)]),_:1},8,["width"]),u(v,{title:"团辅",align:"left"},{default:D(({row:a})=>[u(Ue,{row:a},null,8,["row"])]),_:1})]),_:1},8,["loading","show-header","data","row-config","menu-config"])],512),[[Ne,!p(k)]])]),p(y)?(J(),se("div",St,[u(ht,{onBeforeHandle:De,onAfterHandle:ze,onHandleLine:be})])):vt("",!0)],64)}}});export{Ot as default};
